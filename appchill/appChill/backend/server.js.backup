  const express = require('express');
  const mysql = require('mysql2');
  const bcrypt = require('bcryptjs');
  const jwt = require('jsonwebtoken');
  const multer = require('multer');
  const path = require('path');
  const fs = require('fs');
  const cors = require('cors');
  const http = require('http');
  const socketIo = require('socket.io');
  const { Expo } = require('expo-server-sdk');
  require('dotenv').config();

  const app = express();
  const server = http.createServer(app);
  const io = socketIo(server, {
    cors: {
      origin: "*",
      methods: ["GET", "POST"]
    },
    transports: ['websocket', 'polling'],
    allowEIO3: true
  });

  // ‚≠ê –ù–û–í–û–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Expo SDK –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const expo = new Expo();

  // ========== –§–ê–ô–õ –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –¢–û–ö–ï–ù–û–í ==========
  const TOKENS_FILE = path.join(__dirname, 'push_tokens.json');

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞
  const loadTokensFromFile = () => {
    try {
      if (fs.existsSync(TOKENS_FILE)) {
        const data = fs.readFileSync(TOKENS_FILE, 'utf8');
        return JSON.parse(data);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤:', error.message);
    }
    return {};
  };

  // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ñ–∞–π–ª
  const saveTokensToFile = (tokens) => {
    try {
      fs.writeFileSync(TOKENS_FILE, JSON.stringify(tokens, null, 2));
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤:', error.message);
    }
  };

  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–∫–µ–Ω—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
  let userPushTokens = loadTokensFromFile();
  console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(userPushTokens).length} push-—Ç–æ–∫–µ–Ω–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞`);

  app.use(cors({
    origin: '*',
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
    credentials: true
  }));

  // –í–ê–ñ–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º req.body –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  app.use((req, res, next) => {
    req.body = req.body || {};
    next();
  });

  app.use(express.json({ limit: '50mb', strict: false }));
  app.use(express.urlencoded({ limit: '50mb', extended: true }));

  // ===== MIDDLEWARE –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –û–®–ò–ë–û–ö =====

  // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
  app.use((req, res, next) => {
    const timestamp = new Date().toISOString();
    console.log(`[${timestamp}] ${req.method} ${req.path}`);
    
    // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ —Ç–µ–ª–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ª–æ–≥–æ–≤
    if (req.body && Object.keys(req.body).length > 0) {
      console.log('  Body:', JSON.stringify(req.body).slice(0, 200));
    }
    next();
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ JSON –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç express.json()
  app.use((err, req, res, next) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
    if (err instanceof SyntaxError && err.status === 400 && 'body' in err) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É "null is not valid JSON" - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ body
      if (err.message.includes('null')) {
        console.log('‚ö†Ô∏è Null body received (normal for requests without body)');
        req.body = {};
        return next();
      }
      
      console.error('‚ùå JSON Parse Error:', err.message);
      console.error('   Request path:', req.path);
      console.error('   Content-Type:', req.headers['content-type']);
      console.error('   Request body:', req.body);
      
      return res.status(400).json({ 
        error: 'Invalid JSON in request body',
        message: err.message,
        path: req.path
      });
    }
    
    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ JSON, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ
    next(err);
  });

  // ===== –ö–û–ù–ï–¶ MIDDLEWARE =====

  // –¢–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
  app.get('/', (req, res) => {
    res.json({ message: '–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!', port: process.env.PORT || 3001 });
  });

  // MySQL –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
  const db = mysql.createPool({
    host: process.env.DB_HOST,
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    database: process.env.DB_NAME,
    multipleStatements: true,
    connectionLimit: 10,
    acquireTimeout: 60000,
    timeout: 60000,
    reconnect: true
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL
  db.getConnection((err, connection) => {
    if (err) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MySQL:', err);
      return;
    }
    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ MySQL');
    connection.release();
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
    db.query(`
      CREATE TABLE IF NOT EXISTS users (
        id INT AUTO_INCREMENT PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        phone VARCHAR(20),
        avatar TEXT,
        bio TEXT,
        status VARCHAR(100) DEFAULT '–û–Ω–ª–∞–π–Ω',
        is_online BOOLEAN DEFAULT FALSE,
        is_banned BOOLEAN DEFAULT FALSE,
        ban_reason TEXT DEFAULT NULL,
        banned_at TIMESTAMP NULL,
        banned_by INT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (banned_by) REFERENCES users(id) ON DELETE SET NULL
      )
    `);
    
    // ‚≠ê –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∫–æ–¥–æ–≤ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ SMS
    db.query(`
      CREATE TABLE IF NOT EXISTS verification_codes (
        id INT AUTO_INCREMENT PRIMARY KEY,
        email VARCHAR(100) NOT NULL,
        phone VARCHAR(20) NOT NULL,
        code VARCHAR(6) NOT NULL,
        session_token VARCHAR(255) NOT NULL,
        attempts INT DEFAULT 0,
        max_attempts INT DEFAULT 5,
        is_verified BOOLEAN DEFAULT FALSE,
        expires_at TIMESTAMP NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE KEY unique_email_phone (email, phone),
        INDEX idx_email (email),
        INDEX idx_phone (phone),
        INDEX idx_expires_at (expires_at)
      )
    `);

    db.query(`
      CREATE TABLE IF NOT EXISTS messages (
        id INT AUTO_INCREMENT PRIMARY KEY,
        sender_id INT NOT NULL,
        receiver_id INT NOT NULL,
        message TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (sender_id) REFERENCES users(id),
        FOREIGN KEY (receiver_id) REFERENCES users(id)
      )
    `);
    
    db.query(`
      CREATE TABLE IF NOT EXISTS posts (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        content TEXT NOT NULL,
        image TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id)
      )
    `);
    
    db.query(`
      CREATE TABLE IF NOT EXISTS likes (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        post_id INT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (post_id) REFERENCES posts(id),
        UNIQUE KEY unique_like (user_id, post_id)
      )
    `);
    
    db.query(`
      CREATE TABLE IF NOT EXISTS comments (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        post_id INT NOT NULL,
        comment TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (post_id) REFERENCES posts(id)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Ö–µ—à—Ç–µ–≥–æ–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS hashtags (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL UNIQUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        INDEX idx_name (name)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å–≤—è–∑–∏ –ø–æ—Å—Ç–æ–≤ –∏ —Ö–µ—à—Ç–µ–≥–æ–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS post_hashtags (
        id INT AUTO_INCREMENT PRIMARY KEY,
        post_id INT NOT NULL,
        hashtag_id INT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
        FOREIGN KEY (hashtag_id) REFERENCES hashtags(id) ON DELETE CASCADE,
        UNIQUE KEY unique_post_hashtag (post_id, hashtag_id)
      )
    `);

    db.query(`
      CREATE TABLE IF NOT EXISTS friends (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        friend_id INT NOT NULL,
        status ENUM('pending', 'accepted') DEFAULT 'pending',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (friend_id) REFERENCES users(id),
        UNIQUE KEY unique_friendship (user_id, friend_id)
      )
    `);
    
    db.query(`
      CREATE TABLE IF NOT EXISTS groups (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        description TEXT DEFAULT NULL,
        created_by INT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (created_by) REFERENCES users(id)
      )
    `);
    
    db.query(`
      CREATE TABLE IF NOT EXISTS group_members (
        id INT AUTO_INCREMENT PRIMARY KEY,
        group_id INT NOT NULL,
        user_id INT NOT NULL,
        role ENUM('admin', 'member') DEFAULT 'member',
        joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_membership (group_id, user_id)
      )
    `);
    
    db.query(`
      CREATE TABLE IF NOT EXISTS group_messages (
        id INT AUTO_INCREMENT PRIMARY KEY,
        group_id INT NOT NULL,
        sender_id INT NOT NULL,
        message TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (group_id) REFERENCES groups(id) ON DELETE CASCADE,
        FOREIGN KEY (sender_id) REFERENCES users(id)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    db.query(`
      CREATE TABLE IF NOT EXISTS message_read_status (
        message_id INT NOT NULL,
        reader_id INT NOT NULL,
        is_read BOOLEAN DEFAULT FALSE,
        read_at TIMESTAMP NULL,
        PRIMARY KEY (message_id, reader_id),
        FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
        FOREIGN KEY (reader_id) REFERENCES users(id) ON DELETE CASCADE
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    db.query(`
      CREATE TABLE IF NOT EXISTS group_message_read_status (
        message_id INT NOT NULL,
        reader_id INT NOT NULL,
        is_read BOOLEAN DEFAULT FALSE,
        read_at TIMESTAMP NULL,
        PRIMARY KEY (message_id, reader_id),
        FOREIGN KEY (message_id) REFERENCES group_messages(id) ON DELETE CASCADE,
        FOREIGN KEY (reader_id) REFERENCES users(id) ON DELETE CASCADE
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    db.query(`
      CREATE TABLE IF NOT EXISTS pinned_messages (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        message_id INT NOT NULL,
        chat_type ENUM('personal', 'group') NOT NULL,
        chat_id INT NOT NULL,
        pinned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_pin (user_id, message_id, chat_id)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è push-—Ç–æ–∫–µ–Ω–æ–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS push_tokens (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        push_token TEXT NOT NULL,
        device_type VARCHAR(50) DEFAULT 'unknown',
        device_name VARCHAR(100) DEFAULT 'Unknown Device',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_user_token (user_id),
        INDEX idx_user_id (user_id),
        INDEX idx_push_token (push_token(255))
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS pinned_chats (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        chat_type ENUM('personal', 'group') NOT NULL,
        chat_id INT NOT NULL,
        pinned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_pinned_chat (user_id, chat_type, chat_id)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    db.query(`
      CREATE TABLE IF NOT EXISTS user_preferences (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL UNIQUE,
        chat_background VARCHAR(255) DEFAULT 'default',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞–º–∏
    db.query(`
      CREATE TABLE IF NOT EXISTS calls (
        id INT AUTO_INCREMENT PRIMARY KEY,
        caller_id INT NOT NULL,
        receiver_id INT NOT NULL,
        call_type ENUM('audio', 'video') NOT NULL,
        status ENUM('pending', 'accepted', 'rejected', 'ended', 'missed') DEFAULT 'pending',
        started_at TIMESTAMP NULL,
        ended_at TIMESTAMP NULL,
        duration INT DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (caller_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (receiver_id) REFERENCES users(id) ON DELETE CASCADE,
        INDEX idx_receiver_id (receiver_id),
        INDEX idx_status (status),
        INDEX idx_created_at (created_at)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∑–≤–æ–Ω–∫–æ–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS call_participants (
        id INT AUTO_INCREMENT PRIMARY KEY,
        call_id INT NOT NULL,
        user_id INT NOT NULL,
        joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        left_at TIMESTAMP NULL,
        is_muted BOOLEAN DEFAULT FALSE,
        is_video_on BOOLEAN DEFAULT TRUE,
        FOREIGN KEY (call_id) REFERENCES calls(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_call_participant (call_id, user_id)
      )
    `);

    // ‚úÖ –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –∂–∞–ª–æ–± –Ω–∞ –ø–æ—Å—Ç—ã
    db.query(`
      CREATE TABLE IF NOT EXISTS post_reports (
        id INT AUTO_INCREMENT PRIMARY KEY,
        post_id INT NOT NULL,
        reporter_id INT NOT NULL,
        reason TEXT NOT NULL,
        status ENUM('pending', 'reviewed', 'approved', 'rejected') DEFAULT 'pending',
        reviewed_by INT NULL,
        reviewed_at TIMESTAMP NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
        FOREIGN KEY (reporter_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (reviewed_by) REFERENCES users(id) ON DELETE SET NULL,
        UNIQUE KEY unique_report (post_id, reporter_id),
        INDEX idx_status (status),
        INDEX idx_created_at (created_at)
      )
    `);

    // ============================================
    // ‚≠ê –¢–ê–ë–õ–ò–¶–´ –°–û–û–ë–©–ï–°–¢–í (COMMUNITIES)
    // ============================================

    // –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–æ–æ–±—â–µ—Å—Ç–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS community_categories (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(50) UNIQUE NOT NULL,
        icon VARCHAR(50),
        description TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS communities (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        category VARCHAR(50) DEFAULT 'General',
        creator_id INT NOT NULL,
        image LONGTEXT,
        banner_image LONGTEXT,
        rules TEXT,
        is_private BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE CASCADE,
        INDEX idx_category (category),
        INDEX idx_created_at (created_at),
        INDEX idx_is_private (is_private)
      )
    `);

    // –ß–ª–µ–Ω—ã —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
    db.query(`
      CREATE TABLE IF NOT EXISTS community_members (
        id INT AUTO_INCREMENT PRIMARY KEY,
        community_id INT NOT NULL,
        user_id INT NOT NULL,
        role ENUM('member', 'moderator', 'admin') DEFAULT 'member',
        joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_membership (community_id, user_id),
        INDEX idx_community_id (community_id),
        INDEX idx_user_id (user_id)
      )
    `);

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS community_stats (
        id INT AUTO_INCREMENT PRIMARY KEY,
        community_id INT UNIQUE NOT NULL,
        members_count INT DEFAULT 0,
        posts_count INT DEFAULT 0,
        followers_count INT DEFAULT 0,
        views_count INT DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE
      )
    `);

    // –ü–æ—Å—Ç—ã –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞—Ö
    db.query(`
      CREATE TABLE IF NOT EXISTS community_posts (
        id INT AUTO_INCREMENT PRIMARY KEY,
        community_id INT NOT NULL,
        author_id INT NOT NULL,
        title VARCHAR(255),
        content TEXT NOT NULL,
        image LONGTEXT,
        is_pinned BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
        FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
        INDEX idx_community_id (community_id),
        INDEX idx_created_at (created_at),
        INDEX idx_is_pinned (is_pinned)
      )
    `);

    // –õ–∞–π–∫–∏ –Ω–∞ –ø–æ—Å—Ç—ã —Å–æ–æ–±—â–µ—Å—Ç–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS community_post_likes (
        id INT AUTO_INCREMENT PRIMARY KEY,
        post_id INT NOT NULL,
        user_id INT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (post_id) REFERENCES community_posts(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_like (post_id, user_id),
        INDEX idx_post_id (post_id)
      )
    `);

    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ –ø–æ—Å—Ç—ã —Å–æ–æ–±—â–µ—Å—Ç–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS community_post_comments (
        id INT AUTO_INCREMENT PRIMARY KEY,
        post_id INT NOT NULL,
        author_id INT NOT NULL,
        content TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (post_id) REFERENCES community_posts(id) ON DELETE CASCADE,
        FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE,
        INDEX idx_post_id (post_id)
      )
    `);

    // –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS community_followers (
        id INT AUTO_INCREMENT PRIMARY KEY,
        community_id INT NOT NULL,
        user_id INT NOT NULL,
        followed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_follow (community_id, user_id),
        INDEX idx_community_id (community_id)
      )
    `);

    // –ë–∞–Ω—ã –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞—Ö
    db.query(`
      CREATE TABLE IF NOT EXISTS community_bans (
        id INT AUTO_INCREMENT PRIMARY KEY,
        community_id INT NOT NULL,
        banned_user_id INT NOT NULL,
        banned_by INT NOT NULL,
        reason TEXT,
        ban_duration_days INT,
        banned_until TIMESTAMP NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (community_id) REFERENCES communities(id) ON DELETE CASCADE,
        FOREIGN KEY (banned_user_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (banned_by) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_ban (community_id, banned_user_id),
        INDEX idx_banned_until (banned_until)
      )
    `);

    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    db.query(`
      INSERT IGNORE INTO community_categories (name, icon, description) VALUES
      ('General', 'üìù', '–û–±—â–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è'),
      ('Technology', 'üíª', '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ'),
      ('Gaming', 'üéÆ', '–í–∏–¥–µ–æ–∏–≥—Ä—ã'),
      ('Sports', '‚öΩ', '–°–ø–æ—Ä—Ç'),
      ('Music', 'üéµ', '–ú—É–∑—ã–∫–∞'),
      ('Art', 'üé®', '–ò—Å–∫—É—Å—Å—Ç–≤–æ'),
      ('Books', 'üìö', '–ö–Ω–∏–≥–∏'),
      ('Movies', 'üé¨', '–ö–∏–Ω–æ'),
      ('Food', 'üçï', '–ï–¥–∞'),
      ('Travel', '‚úàÔ∏è', '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'),
      ('Photography', 'üì∑', '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è'),
      ('Fashion', 'üëó', '–ú–æ–¥–∞'),
      ('Education', 'üéì', '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ'),
      ('Business', 'üíº', '–ë–∏–∑–Ω–µ—Å'),
      ('Health', 'üí™', '–ó–¥–æ—Ä–æ–≤—å–µ')
    `);

    // ============================================
    // üÜò –¢–ê–ë–õ–ò–¶–´ –°–ò–°–¢–ï–ú–´ –ü–û–î–î–ï–†–ñ–ö–ò
    // ============================================

    // –¢–∞–±–ª–∏—Ü–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    db.query(`
      CREATE TABLE IF NOT EXISTS support_categories (
        id INT AUTO_INCREMENT PRIMARY KEY,
        name VARCHAR(50) UNIQUE NOT NULL,
        icon VARCHAR(50),
        description TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ —Ç–∏–∫–µ—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    db.query(`
      CREATE TABLE IF NOT EXISTS support_tickets (
        id INT AUTO_INCREMENT PRIMARY KEY,
        user_id INT NOT NULL,
        subject VARCHAR(255) NOT NULL,
        message TEXT NOT NULL,
        category VARCHAR(50) DEFAULT 'general',
        priority ENUM('low', 'medium', 'high', 'critical') DEFAULT 'medium',
        status ENUM('open', 'in_progress', 'resolved', 'closed') DEFAULT 'open',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        INDEX idx_user_id (user_id),
        INDEX idx_status (status),
        INDEX idx_priority (priority),
        INDEX idx_category (category),
        INDEX idx_created_at (created_at)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —Ç–∏–∫–µ—Ç—ã
    db.query(`
      CREATE TABLE IF NOT EXISTS support_replies (
        id INT AUTO_INCREMENT PRIMARY KEY,
        ticket_id INT NOT NULL,
        admin_id INT NOT NULL,
        message TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (ticket_id) REFERENCES support_tickets(id) ON DELETE CASCADE,
        FOREIGN KEY (admin_id) REFERENCES users(id) ON DELETE CASCADE,
        INDEX idx_ticket_id (ticket_id),
        INDEX idx_admin_id (admin_id)
      )
    `);

    // –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤
    db.query(`
      CREATE TABLE IF NOT EXISTS support_ticket_read_status (
        id INT AUTO_INCREMENT PRIMARY KEY,
        ticket_id INT NOT NULL,
        user_id INT NOT NULL,
        is_read BOOLEAN DEFAULT FALSE,
        read_at TIMESTAMP NULL,
        FOREIGN KEY (ticket_id) REFERENCES support_tickets(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_read_status (ticket_id, user_id)
      )
    `);

    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    db.query(`
      INSERT IGNORE INTO support_categories (name, icon, description) VALUES
      ('general', 'üìù', '–û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã'),
      ('bug', 'üêõ', '–°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ'),
      ('feature', '‚ú®', '–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é'),
      ('account', 'üë§', '–ü—Ä–æ–±–ª–µ–º—ã —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º'),
      ('payment', 'üí≥', '–í–æ–ø—Ä–æ—Å—ã –æ–ø–ª–∞—Ç—ã'),
      ('technical', '‚öôÔ∏è', '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã'),
      ('abuse', '‚ö†Ô∏è', '–°–æ–æ–±—â–∏—Ç—å –æ –Ω–∞—Ä—É—à–µ–Ω–∏–∏')
    `);
  });

  // ‚≠ê –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
  const nodemailer = require('nodemailer');
  const crypto = require('crypto');

  console.log('\n' + '='.repeat(70));
  console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ EMAIL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:');
  console.log('  EMAIL_USER:', process.env.EMAIL_USER ? '‚úÖ –∑–∞–¥–∞–Ω' : '‚ùå –ù–ï –∑–∞–¥–∞–Ω');
  console.log('  EMAIL_PASSWORD:', process.env.EMAIL_PASSWORD ? '‚úÖ –∑–∞–¥–∞–Ω' : '‚ùå –ù–ï –∑–∞–¥–∞–Ω');
  console.log('='.repeat(70) + '\n');

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email
  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤:
  // 1. SendGrid - –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–∏—Å (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è —Ö–æ—Å—Ç–∏–Ω–≥–æ–≤)
  // 2. service: 'gmail' - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å Gmail
  // 3. Custom SMTP - –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ—á—Ç–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
  
  let transporter;
  
  if (process.env.SENDGRID_API_KEY) {
    // SendGrid configuration (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)
    console.log('\nüìß EMAIL: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SendGrid API');
    const sgTransport = require('nodemailer-sendgrid-transport');
    transporter = nodemailer.createTransport(sgTransport({
      auth: {
        api_key: process.env.SENDGRID_API_KEY
      }
    }));
  } else if (process.env.EMAIL_SMTP_HOST) {
    // Custom SMTP configuration
    console.log('\nüìß EMAIL: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Custom SMTP');
    transporter = nodemailer.createTransport({
      host: process.env.EMAIL_SMTP_HOST,
      port: parseInt(process.env.EMAIL_SMTP_PORT || '587'),
      secure: process.env.EMAIL_SMTP_SECURE === 'true', // true –¥–ª—è 465, false –¥–ª—è 587
      auth: {
        user: process.env.EMAIL_SMTP_USER || process.env.EMAIL_USER,
        pass: process.env.EMAIL_SMTP_PASSWORD || process.env.EMAIL_PASSWORD
      },
      tls: {
        rejectUnauthorized: false
      },
      connectionTimeout: 10000,
      socketTimeout: 10000,
      pool: process.env.EMAIL_SMTP_POOL === 'true' ? {
        maxConnections: 3,
        maxMessages: 20,
        rateDelta: 2000,
        rateLimit: 5
      } : undefined
    });
  } else {
    // Gmail service
    console.log('\nüìß EMAIL: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Gmail SMTP');
    // –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: —Å —Å–µ—Ä–≤–∏—Å–æ–º –∏ —Å —è–≤–Ω—ã–º–∏ —Ö–æ—Å—Ç–∞–º–∏
    const gmailConfig = {
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASSWORD
      },
      tls: {
        rejectUnauthorized: false
      },
      connectionTimeout: 15000,
      socketTimeout: 15000,
      pool: {
        maxConnections: 2,
        maxMessages: 10,
        rateDelta: 1000,
        rateLimit: 5
      }
    };

    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω EMAIL_SERVICE, –∏—Å–ø–æ–ª—å–∑—É–µ–º service (–Ω–∞–ø—Ä–∏–º–µ—Ä 'gmail')
    if (process.env.EMAIL_SERVICE) {
      gmailConfig.service = process.env.EMAIL_SERVICE;
      console.log(`   –°–µ—Ä–≤–∏—Å: ${process.env.EMAIL_SERVICE}`);
    } else {
      // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —è–≤–Ω—ã–µ —Ö–æ—Å—Ç—ã (gmail smtp)
      gmailConfig.host = 'smtp.gmail.com';
      gmailConfig.port = 465;
      gmailConfig.secure = true; // TLS –Ω–∞ 465
      console.log('   –•–æ—Å—Ç: smtp.gmail.com:465 (SSL)');
    }

    transporter = nodemailer.createTransport(gmailConfig);
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  console.log('üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ EMAIL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...');
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É (15 —Å–µ–∫)
  const verifyTimeout = setTimeout(() => {
    console.log('‚è±Ô∏è  EMAIL –ø—Ä–æ–≤–µ—Ä–∫–∞ timeout - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª)');
  }, 15000);

  transporter.verify((error, success) => {
    clearTimeout(verifyTimeout);
    if (error) {
      console.log('‚ö†Ô∏è  EMAIL –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:', error.message);
      console.log('   –ö–æ–¥—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è\n');
    } else {
      console.log('‚úÖ EMAIL –°–ï–†–í–ò–° –ì–û–¢–û–í –ö –û–¢–ü–†–ê–í–ö–ï');
      console.log(`   From: ${process.env.EMAIL_USER}\n`);
    }
  });

  function generateVerificationCode() {
    const code = Math.floor(100000 + Math.random() * 900000).toString();
    console.log(`üîê –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–¥: ${code}`);
    return code;
  }

  function generateSessionToken() {
    const token = crypto.randomBytes(32).toString('hex');
    console.log(`üé´ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω session token: ${token.substring(0, 16)}...`);
    return token;
  }

  async function sendVerificationEmail(email, code, username) {
    const fs = require('fs');
    const path = require('path');
    const codesLogFile = path.join(__dirname, 'verification_codes.log');

    try {
      console.log('\nüìß –û—Ç–ø—Ä–∞–≤–ª—è—é email...');
      
      const mailOptions = {
        from: process.env.EMAIL_USER,
        to: email,
        subject: '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px 10px 0 0; color: white;">
              <h2 style="margin: 0; text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
            </div>
            
            <div style="background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px;">
              <p style="color: #333; font-size: 16px;">–ü—Ä–∏–≤–µ—Ç, <strong>${username}</strong>!</p>
              
              <p style="color: #666; font-size: 14px;">
                –í—ã —Å–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç. –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
              </p>
              
              <div style="background: white; border: 2px solid #667eea; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0;">
                <h1 style="margin: 0; color: #667eea; font-size: 40px; letter-spacing: 5px;">
                  ${code}
                </h1>
              </div>
              
              <p style="color: #999; font-size: 12px; text-align: center;">
                –ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 5 –º–∏–Ω—É—Ç
              </p>
              
              <hr style="border: none; border-top: 1px solid #ddd; margin: 20px 0;">
              
              <p style="color: #999; font-size: 12px;">
                –ï—Å–ª–∏ –≤—ã –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –∞–∫–∫–∞—É–Ω—Ç, –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —ç—Ç–æ –ø–∏—Å—å–º–æ.
              </p>
            </div>
          </div>
        `
      };

      console.log('üìß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è email:');
      console.log(`   from: ${mailOptions.from}`);
      console.log(`   to: ${mailOptions.to}`);
      console.log(`   subject: ${mailOptions.subject}`);

      const info = await transporter.sendMail(mailOptions);
      
      console.log(`‚úÖ Email —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${email}`);
      console.log(`   Message ID: ${info.messageId}`);
      console.log('');
      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error.message);
      console.error('   Error Code:', error.code);
      console.error('   Command:', error.command);
      
      // üìù FALLBACK: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –≤ —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      console.log('üìù Fallback: –°–æ—Ö—Ä–∞–Ω—è—é –∫–æ–¥ –≤ —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...');
      try {
        const logEntry = {
          timestamp: new Date().toISOString(),
          email: email,
          username: username,
          code: code,
          note: '–ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª —Ç.–∫. email –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è'
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ñ–∞–π–ª
        const existingData = fs.existsSync(codesLogFile) ? fs.readFileSync(codesLogFile, 'utf8') : '[]';
        const codes = JSON.parse(existingData || '[]');
        codes.push(logEntry);
        fs.writeFileSync(codesLogFile, JSON.stringify(codes, null, 2));

        console.log(`üìù –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ ${codesLogFile}`);
        console.log(`   Email: ${email}`);
        console.log(`   –ö–æ–¥: ${code}`);
        console.log('');
        
        // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å—ë —Ä–∞–≤–Ω–æ —É—Å–ø–µ—à–Ω–∞
        return true;
      } catch (fileError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª:', fileError.message);
        return true; // –í—Å—ë —Ä–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true, –∫–æ–¥ –≤ –ë–î —Å–æ—Ö—Ä–∞–Ω—ë–Ω
      }
    }
  }

  // –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –∏–∑ —Ñ–∞–π–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è DEV)
  app.get('/api/dev/verification-codes', (req, res) => {
    const fs = require('fs');
    const path = require('path');
    const codesLogFile = path.join(__dirname, 'verification_codes.log');

    try {
      if (!fs.existsSync(codesLogFile)) {
        return res.json({ message: '–§–∞–π–ª –∫–æ–¥–æ–≤ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω', codes: [] });
      }

      const data = fs.readFileSync(codesLogFile, 'utf8');
      const codes = JSON.parse(data || '[]');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–¥–æ–≤
      const recentCodes = codes.slice(-10).map(c => ({
        email: c.email,
        code: c.code,
        time: c.timestamp
      }));

      res.json({
        message: 'üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–¥—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è DEV)',
        total: codes.length,
        recent: recentCodes
      });
    } catch (error) {
      res.status(500).json({ error: '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', details: error.message });
    }
  });

  // Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞
  function authenticateToken(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    
    if (!token) {
      return res.sendStatus(401);
    }
    
    jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
      if (err) return res.sendStatus(403);
      
      // ‚úÖ –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      db.query('SELECT is_banned, ban_reason FROM users WHERE id = ?', [user.id], (err, results) => {
        if (err) return res.sendStatus(500);
        
        if (results.length > 0 && results[0].is_banned) {
          return res.status(403).json({ 
            error: '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 
            reason: results[0].ban_reason || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤–∞'
          });
        }
        
        req.user = user;
        next();
      });
    });
  }

  // Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –º—É—Ç–µ
  function checkUserMuted(req, res, next) {
    if (global.mutedUsers) {
      const muteInfo = global.mutedUsers.get(String(req.user.id));
      
      if (muteInfo && new Date() < new Date(muteInfo.muteUntil)) {
        return res.status(403).json({ 
          error: '–í—ã –∑–∞–≥–ª—É—à–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
          until: muteInfo.muteUntil
        });
      } else if (muteInfo) {
        global.mutedUsers.delete(String(req.user.id));
      }
    }
    next();
  }

  // ========== HELPER FUNCTION: Transform posts data ==========
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –æ–¥–∏–Ω–æ—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  const transformPostsData = (posts) => {
    return posts.map(post => {
      let processedPost = { ...post };
      
      // –ï—Å–ª–∏ images —É–∂–µ –µ—Å—Ç—å - –ø—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –µ—Å–ª–∏ —ç—Ç–æ JSON —Å—Ç—Ä–æ–∫–∞
      if (processedPost.images && typeof processedPost.images === 'string') {
        try {
          processedPost.images = JSON.parse(processedPost.images);
          console.log(`‚úÖ –†–∞—Å–ø–∞—Ä—Å–µ–Ω—ã images –¥–ª—è –ø–æ—Å—Ç–∞ ${post.id}`);
        } catch (e) {
          console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ images –¥–ª—è –ø–æ—Å—Ç–∞ ${post.id}:`, e.message);
          processedPost.images = null;
        }
      }
      
      // –ö–õ–Æ–ß–ï–í–û–ï: –ï—Å–ª–∏ –µ—Å—Ç—å –æ–¥–∏–Ω–æ—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ image, –Ω–æ –Ω–µ—Ç –º–∞—Å—Å–∏–≤–∞ images - —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
      if (processedPost.image && (!processedPost.images || processedPost.images.length === 0)) {
        processedPost.images = [processedPost.image];
        console.log(`‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –æ–¥–∏–Ω–æ—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –ø–æ—Å—Ç–∞ ${post.id}`);
      }
      
      return processedPost;
    });
  };

  // ========== HELPER FUNCTION: Extract and save hashtags ==========

  const extractAndSaveHashtags = (content, postId) => {
    return new Promise((resolve, reject) => {
      // ‚ú® –ò–°–ü–†–ê–í–õ–ï–ù–û: Regex —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Unicode (Cyrillic, emojis –∏ —Ç.–¥.)
      // /#[\p{L}\p{N}_-]+/gu - —ç—Ç–æ Unicode Property Escapes
      // \p{L} = –ª—é–±–∞—è –±—É–∫–≤–∞ (Latin, Cyrillic, Greek –∏ —Ç.–¥.)
      // \p{N} = –ª—é–±–∞—è —Ü–∏—Ñ—Ä–∞
      // _- = –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ –∏ –¥–µ—Ñ–∏—Å
      const hashtags = (content.match(/#[\p{L}\p{N}_-]+/gu) || []).map(tag => tag.toLowerCase());
      
      console.log(`üè∑Ô∏è –ò–∑–≤–ª–µ—á–µ–Ω—ã —Ö–µ—à—Ç–µ–≥–∏ –¥–ª—è –ø–æ—Å—Ç–∞ ${postId}:`, hashtags);
      
      if (hashtags.length === 0) {
        resolve([]);
        return;
      }
      
      // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
      const uniqueHashtags = [...new Set(hashtags)];
      
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–µ—à—Ç–µ–≥–∞: —Å–æ–∑–¥–∞–µ–º/–ø–æ–ª—É—á–∞–µ–º ID –∏ —Å–≤—è–∑—ã–≤–∞–µ–º —Å –ø–æ—Å—Ç–æ–º
      const savedHashtags = [];
      let completed = 0;
      
      uniqueHashtags.forEach(hashtag => {
        // –í—Å—Ç–∞–≤–ª—è–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º —Ö–µ—à—Ç–µ–≥
        db.query(
          'INSERT INTO hashtags (name) VALUES (?) ON DUPLICATE KEY UPDATE id=LAST_INSERT_ID(id)',
          [hashtag],
          (err, result) => {
            if (err) {
              console.error('‚ùå Error saving hashtag:', err);
              completed++;
              if (completed === uniqueHashtags.length) {
                resolve(savedHashtags);
              }
              return;
            }
            
            const hashtagId = result.insertId;
            
            // –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑—å –ø–æ—Å—Ç-—Ö–µ—à—Ç–µ–≥
            db.query(
              'INSERT INTO post_hashtags (post_id, hashtag_id) VALUES (?, ?) ON DUPLICATE KEY UPDATE id=id',
              [postId, hashtagId],
              (err) => {
                if (err) console.error('‚ùå Error linking hashtag to post:', err);
                savedHashtags.push(hashtag);
                completed++;
                
                if (completed === uniqueHashtags.length) {
                  console.log(`‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${savedHashtags.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤`);
                  resolve(savedHashtags);
                }
              }
            );
          }
        );
      });
    });
  };

  // ========== CALL TRACKING WITH PUSH NOTIFICATIONS ==========
  // –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–≤–æ–Ω–∫–∏: { call_id: { from_user_id, to_user_id, status, started_at, socket_from } }
  const activeCalls = new Map();

  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ –∫ Socket.io: { user_id: [socket_id, ...] }
  const userSockets = new Map();

  const getUserSocketIds = (targetUserId) => {
    if (!targetUserId) return [];
    const sockets = userSockets.get(String(targetUserId));
    return Array.isArray(sockets) ? sockets : [];
  };

  const emitToUserSockets = (targetUserId, event, payload) => {
    const sockets = getUserSocketIds(targetUserId);
    sockets.forEach((socketId) => io.to(socketId).emit(event, payload));
    return sockets.length;
  };

  // –•—Ä–∞–Ω–∏–ª–∏—â–µ push-—Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: { user_id: push_token }
  // (–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–∞ push_tokens.json –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)

  // ==================== –§–£–ù–ö–¶–ò–ò PUSH-–£–í–ï–î–û–ú–õ–ï–ù–ò–ô ====================

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ
   */
  async function sendCallPushNotification(userId, callerName, callType, callData) {
    try {
      const pushToken = userPushTokens[String(userId)];
      
      if (!pushToken) {
        console.log(`‚ùå Push-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
        return false;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å Expo —Ç–æ–∫–µ–Ω–∞
      if (!Expo.isExpoPushToken(pushToken)) {
        console.log(`‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π push-—Ç–æ–∫–µ–Ω: ${pushToken}`);
        delete userPushTokens[String(userId)];
        saveTokensToFile(userPushTokens);
        return false;
      }
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      const message = {
        to: pushToken,
        sound: 'default',
        title: `${callType === 'video' ? 'üìπ' : 'üìû'} ${callerName}`,
        body: `${callType === 'video' ? '–í–∏–¥–µ–æ' : '–ê—É–¥–∏–æ'} –∑–≤–æ–Ω–æ–∫`,
        data: {
          type: 'incoming_call',
          callType: callType,
          callerId: callData.from_user_id,
          callerName: callerName,
          callId: callData.call_id,
        },
        badge: 1,
        priority: 'high',
      };

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º push —á–µ—Ä–µ–∑ Expo
      const tickets = await expo.sendPushNotificationsAsync([message]);
      console.log(`üì¨ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
      console.log(`   –ó–∞–≥–æ–ª–æ–≤–æ–∫: "${message.title}"`);
      console.log(`   –¢–æ–∫–µ–Ω: ${pushToken.slice(0, 40)}...`);
      
      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–≤–æ–Ω–∫–µ:', error.message);
      return false;
    }
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–º –∑–≤–æ–Ω–∫–µ
   */
  async function sendMissedCallNotification(userId, callerName, callType) {
    try {
      const pushToken = userPushTokens[String(userId)];
      
      if (!pushToken) return false;
      
      if (!Expo.isExpoPushToken(pushToken)) {
        delete userPushTokens[String(userId)];
        saveTokensToFile(userPushTokens);
        return false;
      }

      const message = {
        to: pushToken,
        sound: 'default',
        title: `üìû –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π ${callType === 'video' ? '–≤–∏–¥–µ–æ' : '–∞—É–¥–∏–æ'} –∑–≤–æ–Ω–æ–∫`,
        body: `–û—Ç: ${callerName}`,
        data: {
          type: 'missed_call',
          callType: callType,
          callerName: callerName,
        },
        badge: 1,
      };

      await expo.sendPushNotificationsAsync([message]);
      console.log(`üì¨ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–º –∑–≤–æ–Ω–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
      
      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–º –∑–≤–æ–Ω–∫–µ:', error.message);
      return false;
    }
  }

  // ‚≠ê –ü–û–ú–û–©–ù–ò–ö: –ü–æ–ª—É—á–∏—Ç—å push-—Ç–æ–∫–µ–Ω –∏–∑ –ë–î (MySQL)
  const getPushTokenFromDB = (userId) => {
    return new Promise((resolve, reject) => {
      db.query(
        'SELECT push_token, device_type, device_name, updated_at FROM push_tokens WHERE user_id = ? ORDER BY updated_at DESC LIMIT 1',
        [userId],
        (err, results) => {
          if (err) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ç–æ–∫–µ–Ω–∞ –∏–∑ –ë–î –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`, err.message);
            resolve(null);
            return;
          }
          
          if (results && results.length > 0) {
            const { push_token, device_type, device_name, updated_at } = results[0];
            console.log(`‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω –≤ –ë–î –¥–ª—è ${userId}:`);
            console.log(`   –¢–æ–∫–µ–Ω: ${push_token.slice(0, 40)}...`);
            console.log(`   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device_type} (${device_name})`);
            console.log(`   –û–±–Ω–æ–≤–ª–µ–Ω: ${updated_at}`);
            resolve(push_token);
          } else {
            console.log(`‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–æ–±—â–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
            db.query('SELECT COUNT(*) as count FROM push_tokens', (err, countResult) => {
              if (!err && countResult) {
                console.log(`   üìä –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ë–î: ${countResult[0].count}`);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ user_ids –≤ —Ç–∞–±–ª–∏—Ü–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                db.query('SELECT DISTINCT user_id FROM push_tokens LIMIT 10', (err, userIds) => {
                  if (!err && userIds) {
                    const ids = userIds.map(r => r.user_id).join(', ');
                    console.log(`   üìã User IDs —Å —Ç–æ–∫–µ–Ω–∞–º–∏: ${ids}`);
                  }
                });
              }
            });
            resolve(null);
          }
        }
      );
    });
  };

  // ============================================
  // üîÑ –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –ê–ö–¢–ò–í–ù–´–• –ß–ê–¢–û–í
  // ============================================

  // { userId: { chatId, chatType, timestamp } }
  const activeChats = new Map();

  // üîç –§–£–ù–ö–¶–ò–Ø –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ - –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ?
  function isUserInActiveChat(userId, chatId, chatType) {
    const activeChat = activeChats.get(userId);
    
    if (!activeChat) {
      // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ñ–ª–∞–π–Ω –∏–ª–∏ –≤—ã—à–µ–ª –∏–∑ –≤—Å–µ—Ö —á–∞—Ç–æ–≤
      return false;
    }
    
    const isInChat = 
      activeChat.chatId === chatId && 
      activeChat.chatType === chatType;
    
    if (isInChat) {
      console.log(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –≤ –∞–∫—Ç–∏–≤–Ω–æ–º ${chatType}-—á–∞—Ç–µ ${chatId} -> PUSH –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º`);
    }
    
    return isInChat;
  }

  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤
  function debugActiveChats() {
    console.log('üìä === –ê–ö–¢–ò–í–ù–´–ï –ß–ê–¢–´ ===');
    for (const [userId, chat] of activeChats) {
      console.log(`  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId}: ${chat.chatType}-—á–∞—Ç ${chat.chatId}`);
    }
    console.log('========================');
  }

  // ==================== SOCKET.IO CONNECTION ==========
  io.on('connection', (socket) => {
    console.log('üîå Socket –ø–æ–¥–∫–ª—é—á–µ–Ω:', socket.id);

    let userId = null;

    const attachUserToSocket = (incomingUserId) => {
      if (!incomingUserId) return;
      userId = incomingUserId;
      socket.join(`user_${userId}`);
      console.log(`‚úÖ Socket ${socket.id} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ user_${userId}`);
      
      const userKey = String(userId);
      if (!userSockets.has(userKey)) {
        userSockets.set(userKey, []);
      }
      const sockets = userSockets.get(userKey);
      if (!sockets.includes(socket.id)) {
        sockets.push(socket.id);
        
        // ‚úÖ –ò–ó–ú–ï–ù–ï–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ò —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞—Ö–æ–¥–∞
        db.query('UPDATE users SET is_online = 1, last_seen = NOW() WHERE id = ?', [userId], (err) => {
          if (err) console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
        });

        // ‚≠ê –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º timestamp –≤ —Å–æ–±—ã—Ç–∏–µ
        io.emit('user_status_changed', { 
          userId, 
          is_online: true,
          timestamp: new Date().toISOString()  // ‚≠ê –ù–û–í–û–ï –ü–û–õ–ï
        });
      }
    };

    // –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É –ø–æ –¥–∞–Ω–Ω—ã–º —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è
    const handshakeUserId = socket.handshake?.auth?.user_id || socket.handshake?.query?.user_id;
    if (handshakeUserId) {
      attachUserToSocket(handshakeUserId);
    }

    // ‚úÖ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –°–û–ö–ï–¢–ê
    socket.on('authenticate_socket', (data) => {
      const incomingUserId = data?.user_id;
      console.log(`üìç authenticate_socket –≤—ã–∑–≤–∞–Ω –¥–ª—è user_id=${incomingUserId}`);
      attachUserToSocket(incomingUserId);

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–Ω–∏–º–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤—Å–µ—Ö –¥—Ä—É–∑–µ–π –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
      if (incomingUserId) {
        db.query(`
          SELECT f.friend_id as user_id, u.is_online
          FROM friends f
          JOIN users u ON f.friend_id = u.id
          WHERE f.user_id = ? AND f.status = 'accepted'
          UNION ALL
          SELECT f.user_id as user_id, u.is_online
          FROM friends f
          JOIN users u ON f.user_id = u.id
          WHERE f.friend_id = ? AND f.status = 'accepted'
        `, [incomingUserId, incomingUserId], (err, results) => {
          if (err) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥—Ä—É–∑–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${incomingUserId}:`, err);
            return;
          }
          
          console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –¥—Ä—É–∑–µ–π: ${results?.length || 0} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${incomingUserId}`);
          
          if (results && results.length > 0) {
            const seen = new Set();
            const uniqueStatuses = results.filter(r => {
              if (seen.has(r.user_id)) return false;
              seen.add(r.user_id);
              return true;
            });

            console.log(`üì∏ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å–Ω–∏–º–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ ${uniqueStatuses.length} –¥—Ä—É–∑–µ–π:`, JSON.stringify(uniqueStatuses.slice(0, 3)));
            socket.emit('friends_status_snapshot', uniqueStatuses);
            console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–Ω–∏–º–æ–∫ —Å—Ç–∞—Ç—É—Å–æ–≤ ${uniqueStatuses.length} –¥—Ä—É–∑–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${incomingUserId}`);
          } else {
            console.log(`‚ÑπÔ∏è –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${incomingUserId} –Ω–µ—Ç –¥—Ä—É–∑–µ–π, –æ—Ç–ø—Ä–∞–≤–ª—è—é –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤`);
            socket.emit('friends_status_snapshot', []);
          }
        });
      } else {
        console.warn('‚ö†Ô∏è authenticate_socket: user_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω');
      }
    });

    // ‚úÖ –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–ï –ö –ì–†–£–ü–ü–û–í–û–ô –ö–û–ú–ù–ê–¢–ï
    socket.on('join_group_room', (groupId) => {
      socket.join(`group_${groupId}`);
      console.log(`‚úÖ Socket ${socket.id} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ group_${groupId}`);
    });

    // ‚úÖ –ü–û–ö–ò–î–ê–ù–ò–ï –ì–†–£–ü–ü–û–í–û–ô –ö–û–ú–ù–ê–¢–´
    socket.on('leave_group', (groupId) => {
      socket.leave(`group_${groupId}`);
      console.log(`‚úÖ Socket ${socket.id} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É group_${groupId}`);
    });

    // ‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê –ü–ï–ß–ê–¢–ê–ù–ò–Ø
    // ‚úÖ –û–ë–†–ê–ë–û–¢–ß–ò–ö: –õ–∏—á–Ω–æ–µ –ø–µ—á–∞—Ç–∞–Ω–∏–µ
    socket.on('user_typing', (data) => {
      if (!userId) {
        console.log('‚ö†Ô∏è user_typing: userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ auth');
        return;
      }

      const { to_user_id, from_user_id, from_user_username, is_typing } = data;

      if (!to_user_id) {
        console.log('‚ö†Ô∏è user_typing: to_user_id –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
        return;
      }

      // ‚úÖ –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
      const senderId = from_user_id || userId;
      const senderName = from_user_username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

      console.log(`üìù user_typing: ${senderId} –ø–µ—á–∞—Ç–∞–µ—Ç –¥–ª—è ${to_user_id}. is_typing=${is_typing}`);

      // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¢–û–õ–¨–ö–û –ø–æ–ª—É—á–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Room
      io.to(`user_${to_user_id}`).emit('user_typing', {
        from_user_id: senderId,
        from_user_username: senderName,
        to_user_id: to_user_id,
        is_typing: is_typing,
        timestamp: new Date().toISOString()
      });

      console.log(`üì§ user_typing –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${senderName}(${senderId}) ‚Üí user_${to_user_id}`);
    });

    // ‚úÖ –û–ë–†–ê–ë–û–¢–ß–ò–ö: –ì—Ä—É–ø–ø–æ–≤–æ–µ –ø–µ—á–∞—Ç–∞–Ω–∏–µ
    socket.on('group_user_typing', (data) => {
      if (!userId) {
        console.log('‚ö†Ô∏è group_user_typing: userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ auth');
        return;
      }

      const { group_id, is_typing } = data;

      if (!group_id) {
        console.log('‚ö†Ô∏è group_user_typing: group_id –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
        return;
      }

      console.log(`üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –ø–µ—á–∞—Ç–∞–µ—Ç –≤ –≥—Ä—É–ø–ø–µ ${group_id}. is_typing=${is_typing}`);

      // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
      db.query(
        'SELECT username FROM users WHERE id = ?',
        [userId],
        (err, results) => {
          if (err) {
            console.error('‚ùå Error fetching username:', err);
            return;
          }

          const username = results && results.length > 0 ? results[0].username : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤—Å–µ–π –≥—Ä—É–ø–ø–µ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          io.to(`group_${group_id}`).emit('group_user_typing', {
            group_id: group_id,
            user_id: userId,
            username: username,
            is_typing: is_typing
          });

          console.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ group_user_typing: ${username} –ø–µ—á–∞—Ç–∞–µ—Ç –≤ –≥—Ä—É–ø–ø–µ ${group_id}`);
        }
      );
    });

    // ‚úÖ –û–ë–†–ê–ë–û–¢–ß–ò–ö: –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
    socket.on('mark_message_read', (data) => {
      const { message_id } = data;
      
      if (!userId || !message_id) {
        console.warn('‚ö†Ô∏è mark_message_read: missing userId or message_id');
        return;
      }
      
      console.log(`\n${'='.repeat(70)}`);
      console.log(`üìñ mark_message_read: user_id=${userId}, message_id=${message_id}`);
      console.log(`${'='.repeat(70)}`);
      
      // –®–∞–≥ 1: –û–ü–†–ï–î–ï–õ–Ø–ï–ú –¢–ò–ü –°–û–û–ë–©–ï–ù–ò–Ø (–ª–∏—á–Ω–æ–µ –∏–ª–∏ –≥—Ä—É–ø–ø–æ–≤–æ–µ)
      // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä—É–ø–ø–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      db.query(
        'SELECT sender_id, group_id FROM group_messages WHERE id = ?',
        [message_id],
        (err, groupResults) => {
          if (err) {
            console.error('‚ùå Error checking group message:', err);
            return;
          }
          
          // –ï–°–õ–ò –ù–ê–ô–î–ï–ù–û –í –ì–†–£–ü–ü–û–í–´–• –°–û–û–ë–©–ï–ù–ò–Ø–•
          if (groupResults && groupResults.length > 0) {
            const { sender_id, group_id } = groupResults[0];
            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –ì–†–£–ü–ü–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ: sender_id=${sender_id}, group_id=${group_id}`);
            
            // –®–∞–≥ 2: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ group_message_read_status
            db.query(
              `INSERT INTO group_message_read_status (message_id, reader_id, is_read, read_at)
              VALUES (?, ?, TRUE, CURRENT_TIMESTAMP)
              ON DUPLICATE KEY UPDATE is_read = TRUE, read_at = CURRENT_TIMESTAMP`,
              [message_id, userId],
              (err) => {
                if (err) {
                  console.error('‚ùå Error updating group_message_read_status:', err);
                  return;
                }
                
                console.log(`‚úÖ group_message_read_status –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è message_id=${message_id}, reader_id=${userId}`);
                
                // –®–∞–≥ 3: –ü–û–õ–£–ß–ê–ï–ú –í–°–ï–• –ß–ò–¢–ê–¢–ï–õ–ï–ô —Å–æ–æ–±—â–µ–Ω–∏—è (–í–û–¢ –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï!)
                db.query(
                  `SELECT GROUP_CONCAT(reader_id) as reader_ids, COUNT(*) as reader_count
                  FROM group_message_read_status
                  WHERE message_id = ? AND is_read = TRUE`,
                  [message_id],
                  (err, readerResults) => {
                    if (err) {
                      console.error('‚ùå Error getting readers:', err);
                      return;
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤
                    const reader_ids = readerResults && readerResults[0].reader_ids 
                      ? readerResults[0].reader_ids.split(',').map(id => parseInt(id))
                      : [userId];
                    
                    console.log(`üìã –ß–∏—Ç–∞—Ç–µ–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è ${message_id}: [${reader_ids.join(', ')}]`);
                    
                    // –®–∞–≥ 4: –û–¢–ü–†–ê–í–õ–Ø–ï–ú –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –í–°–ï–ô –ì–†–£–ü–ü–ï –° –ú–ê–°–°–ò–í–û–ú –í–°–ï–• –ß–ò–¢–ê–¢–ï–õ–ï–ô
                    console.log(`üì¨ –û—Ç–ø—Ä–∞–≤–ª—è—é message_read_status_updated –≤ group_${group_id}`);
                    
                    // ‚úÖ –ì–õ–ê–í–ù–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ú–ê–°–°–ò–í –≤—Å–µ—Ö —á–∏—Ç–∞—Ç–µ–ª–µ–π, –∞ –Ω–µ –æ–¥–Ω–æ–≥–æ
                    io.to(`group_${group_id}`).emit('message_read_status_updated', {
                      message_id: message_id,
                      is_read: true,
                      read_by: reader_ids,  // ‚úÖ –ú–ê–°–°–ò–í —Å–æ –í–°–ï–ú–ò —á–∏—Ç–∞—Ç–µ–ª—è–º–∏ - –í–û–¢ –ì–õ–ê–í–ù–û–ï!
                      sender_id: sender_id,
                      group_id: group_id,
                      updated_by: userId,
                      reader_count: reader_ids.length
                    });
                    
                    console.log(`‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –≥—Ä—É–ø–ø—É. –ß–∏—Ç–∞—Ç–µ–ª–µ–π: ${reader_ids.length}\n`);
                  }
                );
              }
            );
            return;
          }
          
          // –ï–°–õ–ò –ù–ï –ù–ê–ô–î–ï–ù–û –í –ì–†–£–ü–ü–û–í–´–• - –∏—â–µ–º –≤ –ª–∏—á–Ω—ã—Ö
          console.log(`‚è≥ –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö, –ø—Ä–æ–≤–µ—Ä—è—é –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è...`);
          
          db.query(
            'SELECT sender_id, receiver_id FROM messages WHERE id = ?',
            [message_id],
            (err, personalResults) => {
              if (err) {
                console.error('‚ùå Error checking personal message:', err);
                return;
              }
              
              // –ï–°–õ–ò –ù–ê–ô–î–ï–ù–û –í –õ–ò–ß–ù–´–• –°–û–û–ë–©–ï–ù–ò–Ø–•
              if (personalResults && personalResults.length > 0) {
                const { sender_id, receiver_id } = personalResults[0];
                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –õ–ò–ß–ù–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ: sender_id=${sender_id}, receiver_id=${receiver_id}`);
                
                // –®–∞–≥ 2: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ message_read_status
                db.query(
                  `INSERT INTO message_read_status (message_id, reader_id, is_read, read_at)
                  VALUES (?, ?, TRUE, CURRENT_TIMESTAMP)
                  ON DUPLICATE KEY UPDATE is_read = TRUE, read_at = CURRENT_TIMESTAMP`,
                  [message_id, userId],
                  (err) => {
                    if (err) {
                      console.error('‚ùå Error updating message_read_status:', err);
                      return;
                    }
                    
                    console.log(`‚úÖ message_read_status –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è message_id=${message_id}, reader_id=${userId}`);
                    
                    // ‚≠ê –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ß–ï–†–ï–ó SOCKET
                    console.log(`üì¨ –û—Ç–ø—Ä–∞–≤–ª—è—é message_read_status_updated –∫ user_${sender_id} –∏ user_${receiver_id}`);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –û–ë–û–ò–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    io.to(`user_${sender_id}`).emit('message_read_status_updated', {
                      message_id: message_id,
                      is_read: true,
                      read_by: userId,  // ‚úÖ ID —á–∏—Ç–∞—Ç–µ–ª—è
                      sender_id: sender_id,
                      receiver_id: receiver_id,
                      timestamp: new Date().toISOString()
                    });
                    
                    io.to(`user_${receiver_id}`).emit('message_read_status_updated', {
                      message_id: message_id,
                      is_read: true,
                      read_by: userId,
                      sender_id: sender_id,
                      receiver_id: receiver_id,
                      timestamp: new Date().toISOString()
                    });
                    
                    console.log(`‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º\n`);
                  }
                );
                return;
              }
              
              // –ù–ï –ù–ê–ô–î–ï–ù–û –ù–ò –ì–î–ï
              console.warn(`‚ùå Message ${message_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –≤ –ª–∏—á–Ω—ã—Ö, –Ω–∏ –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö\n`);
            }
          );
        }
      );
    });

    // ‚úÖ –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø PUSH-–¢–û–ö–ï–ù–ê
    socket.on('register_push_token', (data) => {
      if (!userId) {
        console.log('‚ö†Ô∏è register_push_token: userId –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      const { pushToken, deviceType = 'unknown', deviceName = 'Unknown Device' } = data || {};
      if (pushToken && Expo.isExpoPushToken(pushToken)) {
        console.log(`üîç –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é —Ç–æ–∫–µ–Ω –¥–ª—è user_id=${userId}: ${pushToken.slice(0, 40)}...`);
        
        db.query(
          `INSERT INTO push_tokens (user_id, push_token, device_type, device_name) 
          VALUES (?, ?, ?, ?)
          ON DUPLICATE KEY UPDATE push_token = ?, device_type = ?, device_name = ?, updated_at = CURRENT_TIMESTAMP`,
          [userId, pushToken, deviceType, deviceName, pushToken, deviceType, deviceName],
          (err) => {
            if (err) {
              console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è push-—Ç–æ–∫–µ–Ω–∞ –¥–ª—è user_id=${userId}:`, err.message);
            } else {
              console.log(`‚úÖ Push-—Ç–æ–∫–µ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è ${userId} –≤ –ë–î: ${pushToken.slice(0, 40)}...`);
            }
          }
        );
      }
    });

    // ‚úÖ –ü–û–î–ü–ò–°–ö–ê –ù–ê –°–¢–ê–¢–£–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
    socket.on('subscribe_user_status', (userId) => {
      socket.join(`user_status_${userId}`);
      console.log(`‚úÖ Socket ${socket.id} –ø–æ–¥–ø–∏—Å–∞–ª—Å—è –Ω–∞ —Å—Ç–∞—Ç—É—Å user_${userId}`);
    });

    // ‚úÖ –û–ë–†–ê–ë–û–¢–ß–ò–ö: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    socket.on('user_status', (data) => {
      const { user_id, is_online } = data;
      
      console.log(`üìä user_status: user_id=${user_id}, is_online=${is_online}`);
      
      // ‚úÖ –û–¢–ü–†–ê–í–õ–Ø–ï–ú –í–°–ï–ú (broadcast)
      // –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
      io.emit('user_status_changed', {
        userId: user_id,
        is_online: is_online,
        timestamp: new Date().toISOString()
      });
      
      console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ 'user_status_changed' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user_id} ‚Üí ${is_online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ–ª–∞–π–Ω'}`);
    });

    // ========== CALL HANDLERS ==========
    
    // ========== –ò–ù–ò–¶–ò–ê–¶–ò–Ø –ó–í–û–ù–ö–ê (15 –°–ï–ö –î–û–ó–í–û–ù) ==========
    socket.on('call_initiate', async (data) => {
      const { from_user_id, to_user_id, call_type, from_user } = data;
      const callId = `${from_user_id}_${to_user_id}_${Date.now()}`;
      
      console.log(`\n${'='.repeat(70)}`);
      console.log(`üìû –ó–í–û–ù–û–ö –ò–ù–ò–¶–ò–ò–†–û–í–ê–ù`);
      console.log(`   –û—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${from_user_id} (${from_user?.username || 'Unknown'})`);
      console.log(`   –ö–æ–º—É: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${to_user_id}`);
      console.log(`   –¢–∏–ø: ${call_type}`);
      console.log(`   Call ID: ${callId}`);
      console.log(`   Socket ID –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: ${socket.id}`);
      
      // –ü–†–û–í–ï–†–ö–ê: –µ—Å—Ç—å –ª–∏ from_user_id?
      if (!from_user_id || !to_user_id) {
        console.error(`‚ùå –û–®–ò–ë–ö–ê: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç from_user_id (${from_user_id}) –∏–ª–∏ to_user_id (${to_user_id})`);
        socket.emit('call_error', {
          message: 'Invalid call data',
          details: 'from_user_id and to_user_id are required'
        });
        return;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–≤–æ–Ω–∫–µ
      activeCalls.set(callId, {
        call_id: callId,
        from_user_id,
        to_user_id,
        call_type,
        status: 'ringing',
        started_at: new Date(),
        socket_from: socket.id
      });
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –æ–Ω–ª–∞–π–Ω –ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å?
      const recipientSocketIds = getUserSocketIds(to_user_id);
      
      console.log(`üìä –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ:`);
      console.log(`   –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: ${userSockets.size}`);
      console.log(`   –°–ø–∏—Å–æ–∫: ${Array.from(userSockets.entries())
        .map(([uid, ids]) => `${uid}(${Array.isArray(ids) ? ids.length : 0})`)
        .join(', ') || '–ø—É—Å—Ç–æ'}`);
      console.log(`   Socket ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è ${to_user_id}: ${recipientSocketIds.length > 0 ? recipientSocketIds.join(', ') : '–ù–ï –ù–ê–ô–î–ï–ù'}`);
      
      if (recipientSocketIds.length > 0) {
        // ‚úÖ –û–ù–õ–ê–ô–ù - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º WebSocket
        console.log(`‚úÖ –ù–ê–ô–î–ï–ù –û–ù–õ–ê–ô–ù - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º WebSocket —Å–∏–≥–Ω–∞–ª`);
        
        recipientSocketIds.forEach((socketId) => {
          io.to(socketId).emit('call_incoming', {
            call_id: callId,
            from_user_id,
            call_type,
            from_user: {
              id: from_user_id,
              username: from_user?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
            }
          });
        });
        
        console.log(`‚úÖ –°–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ sockets: ${recipientSocketIds.join(', ')}`);

        // üîî –î–æ–∂–∏–¥–∞–µ–º—Å—è –æ—Ç–≤–µ—Ç–∞ 15 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          const call = activeCalls.get(callId);
          if (call && call.status === 'ringing') {
            console.log(`‚è∞ –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ (15 —Å–µ–∫): ${callId}`);
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –∑–≤–æ–Ω—è—â–µ–≥–æ
            io.to(socket.id).emit('call_missed', {
              call_id: callId,
              to_user_id
            });
            
            activeCalls.delete(callId);
          }
        }, 15000);
        
      } else {
        // ‚ùå –û–§–§–õ–ê–ô–ù - –ò–©–ï–ú PUSH-–¢–û–ö–ï–ù –í –ë–î
        console.log(`‚ùå –û–§–§–õ–ê–ô–ù - –ø—É—Å–∫–æ–Ω–∏—á–∞—Ç–µ–ª—å ${to_user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ userSockets`);
        console.log(`‚è≥ –ò—â–µ–º push-—Ç–æ–∫–µ–Ω –≤ –ë–î...`);
        
        try {
          const pushToken = await getPushTokenFromDB(to_user_id);
          
          if (pushToken) {
            try {
              // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
              const message = {
                to: pushToken,
                sound: 'default',
                title: `${call_type === 'video' ? 'üìπ' : 'üìû'} ${from_user?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}`,
                body: `${call_type === 'video' ? '–í–∏–¥–µ–æ' : '–ê—É–¥–∏–æ'} –∑–≤–æ–Ω–æ–∫`,
                data: {
                  type: 'incoming_call',
                  callType: call_type,
                  callerId: from_user_id,
                  callerName: from_user?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                  callId: callId,
                },
                badge: 1,
                priority: 'high',
              };

              // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º push
              const tickets = await expo.sendPushNotificationsAsync([message]);
              console.log(`üì¨ Push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
              console.log(`   –ó–∞–≥–æ–ª–æ–≤–æ–∫: "${message.title}"`);
              console.log(`   –¢–æ–∫–µ–Ω: ${pushToken.slice(0, 40)}...`);
              
              // –£–≤–µ–¥–æ–º–ª—è–µ–º –∑–≤–æ–Ω—è—â–µ–≥–æ —á—Ç–æ push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
              io.to(socket.id).emit('call_user_offline_push_sent', {
                message: 'Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ',
                callId
              });

              // ‚è≥ –î–û–ñ–ò–î–ê–ï–ú–°–Ø –û–¢–í–ï–¢–ê 15 –°–ï–ö–£–ù–î (–ü–û–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –û–¢–ö–†–û–ï–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï)
              const missedCallTimeout = setTimeout(() => {
                const call = activeCalls.get(callId);
                if (call && call.status === 'ringing') {
                  console.log(`‚è∞ –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ (15 —Å–µ–∫): ${callId}`);
                  
                  // –£–≤–µ–¥–æ–º–ª—è–µ–º –∑–≤–æ–Ω—è—â–µ–≥–æ
                  io.to(socket.id).emit('call_missed', {
                    call_id: callId,
                    to_user_id
                  });
                  
                  activeCalls.delete(callId);
                }
              }, 15000);

              // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª –≤—ã–∑–æ–≤ - –æ—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
              const handleCallAccepted = (callData) => {
                if (callData.call_id === callId) {
                  clearTimeout(missedCallTimeout);
                  socket.off('call_accepted_internal', handleCallAccepted);
                }
              };
              socket.on('call_accepted_internal', handleCallAccepted);

            } catch (error) {
              console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ push:`, error.message);
              io.to(socket.id).emit('call_user_offline', {
                message: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è'
              });
            }
          } else {
            console.log(`‚ùå Push-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è ${to_user_id} –≤ –ë–î`);
            console.log(`üì± –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${to_user_id} –î–û–õ–ñ–ï–ù –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å push-—Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ POST /api/users/push-token`);
            
            io.to(socket.id).emit('call_user_offline', {
              message: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${to_user_id} –æ—Ñ—Ñ–ª–∞–π–Ω –∏ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª push-—Ç–æ–∫–µ–Ω`
            });
          }
        } catch (error) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ push-—Ç–æ–∫–µ–Ω–∞:`, error.message);
          io.to(socket.id).emit('call_user_offline', {
            message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Ç–æ–∫–µ–Ω–∞'
          });
        }
      }
    });

    // –ü–†–ò–ù–Ø–¢–ò–ï –ó–í–û–ù–ö–ê
    socket.on('call_accepted', (data) => {
      const { call_id, to_user_id } = data;
      const call = activeCalls.get(call_id);
      
      if (call) {
        call.status = 'connected';
        call.connected_at = new Date();
        
        console.log(`‚úÖ –ü—Ä–∏–Ω—è—Ç: ${call.from_user_id} ‚Üî ${to_user_id}\n`);
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –∑–≤–æ–Ω—è—â–µ–≥–æ
        io.to(call.socket_from).emit('call_accepted', {
          call_id,
          from_user_id: call.from_user_id,
          to_user_id
        });
        
        // –°–∏–≥–Ω–∞–ª –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
        socket.emit('call_accepted_internal', { call_id });
      }
    });

    // –û–¢–ö–õ–û–ù–ï–ù–ò–ï –ó–í–û–ù–ö–ê
    socket.on('call_rejected', (data) => {
      const { call_id, to_user_id } = data;
      const call = activeCalls.get(call_id);
      
      if (call) {
        console.log(`‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω: ${call.from_user_id}\n`);
        
        io.to(call.socket_from).emit('call_rejected', {
          call_id,
          reason: 'user_declined'
        });
        
        activeCalls.delete(call_id);
      }
    });

    // –ó–ê–í–ï–†–®–ï–ù–ò–ï –ó–í–û–ù–ö–ê
    socket.on('call_end', (data) => {
      const { to_user_id } = data;
      
      // –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫
      let callToEnd = null;
      for (const [callId, call] of activeCalls) {
        if ((call.from_user_id === userId && call.to_user_id === to_user_id) ||
            (call.from_user_id === to_user_id && call.to_user_id === userId)) {
          callToEnd = { callId, call };
          break;
        }
      }
      
      if (callToEnd) {
        const duration = Math.floor((new Date() - callToEnd.call.started_at) / 1000);
        console.log(`üì¥ –ó–∞–≤–µ—Ä—à–µ–Ω (${duration}—Å–µ–∫)\n`);
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const otherUserId = callToEnd.call.from_user_id === userId 
          ? callToEnd.call.to_user_id 
          : callToEnd.call.from_user_id;
        
        const otherSocketIds = getUserSocketIds(otherUserId);
        if (otherSocketIds.length > 0) {
          otherSocketIds.forEach((socketId) => {
            io.to(socketId).emit('call_ended', {
              call_id: callToEnd.callId,
              duration
            });
          });
        }
        
        activeCalls.delete(callToEnd.callId);
      }
    });

    // –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ú–£–¢–ï
    socket.on('call_mute_toggle', (data) => {
      const { is_muted, to_user_id } = data;
      
      const otherSocketIds = getUserSocketIds(to_user_id);
      if (otherSocketIds.length > 0) {
        otherSocketIds.forEach((socketId) => {
          io.to(socketId).emit('call_mute_status', {
            is_muted
          });
        });
      }
    });

    // ‚úÖ –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–ª —á–∞—Ç
    socket.on('set_active_chat', (data) => {
      if (!userId) {
        console.log('‚ö†Ô∏è set_active_chat: user_id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ auth');
        return;
      }
      
      const { chat_id, chat_type, timestamp } = data;
      activeChats.set(userId, {
        chatId: chat_id,
        chatType: chat_type,
        timestamp: timestamp ? new Date(timestamp) : new Date()
      });
      
      console.log(`üìç –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}: ${chat_type} —á–∞—Ç_id=${chat_id}`);
    });
    
    // ‚úÖ –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —á–∞—Ç–∞
    socket.on('clear_active_chat', (data) => {
      if (!userId) {
        console.log('‚ö†Ô∏è clear_active_chat: user_id –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ auth');
        return;
      }
      
      activeChats.delete(userId);
      console.log(`üì≠ –û—á–∏—â–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
    });

    // ‚úÖ –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–ï –ö PERSONAL ROOM
    socket.on('join_personal_room', (other_user_id) => {
      if (userId) {
        socket.join(`user_${userId}`);
        console.log(`‚úÖ Socket ${socket.id} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ personal room: user_${userId}`);
      }
    });

    // ‚úÖ –ü–û–ö–ò–î–ê–ù–ò–ï PERSONAL ROOM
    socket.on('leave_personal_room', (other_user_id) => {
      if (userId) {
        socket.leave(`user_${userId}`);
        console.log(`‚úÖ Socket ${socket.id} –ø–æ–∫–∏–Ω—É–ª personal room: user_${userId}`);
      }
    });

    // –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï
    socket.on('disconnect', () => {
      console.log('‚ùå Socket –æ—Ç–∫–ª—é—á–µ–Ω:', socket.id);
      
      if (userId) {
        // –û—á–∏—â–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
        activeChats.delete(userId);
        console.log(`üì≠ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –æ—Ç–∫–ª—é—á–∏–ª—Å—è, –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –æ—á–∏—â–µ–Ω`);
        
        // –£–¥–∞–ª—è–µ–º —Å–æ–∫–µ—Ç –∏–∑ –≤—Å–µ—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤
        const userKey = String(userId);
        const sockets = userSockets.get(userKey);
        if (sockets) {
          const index = sockets.indexOf(socket.id);
          if (index > -1) {
            sockets.splice(index, 1);
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –±–æ–ª—å—à–µ —Å–æ–∫–µ—Ç–æ–≤ - —Å—Ç–∞–≤–∏–º –æ—Ñ–ª–∞–π–Ω –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è
            if (sockets.length === 0) {
              userSockets.delete(userKey);
              // ‚≠ê –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_seen
              db.query('UPDATE users SET is_online = 0, last_seen = NOW() WHERE id = ?', [userId], (err) => {
                if (err) console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
              });
              // ‚≠ê –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º timestamp –≤ —Å–æ–±—ã—Ç–∏–µ
              io.emit('user_status_changed', { 
                userId, 
                is_online: false,
                timestamp: new Date().toISOString()  // ‚≠ê –ù–û–í–û–ï –ü–û–õ–ï
              });
            }
          }
        }
        
        // –ó–∞–≤–µ—Ä—à–∞–µ–º –µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–≤–æ–Ω–∫–∏
        for (const [callId, call] of activeCalls) {
          if (call.from_user_id === userId || call.to_user_id === userId) {
            const otherUserId = call.from_user_id === userId 
              ? call.to_user_id 
              : call.from_user_id;
            
            const otherSocketIds = getUserSocketIds(otherUserId);
            if (otherSocketIds.length > 0) {
              otherSocketIds.forEach((socketId) => {
                io.to(socketId).emit('call_ended', {
                  call_id: callId,
                  reason: 'user_disconnected'
                });
              });
            }
            
            activeCalls.delete(callId);
          }
        }
      }
    });
  });

  // ‚≠ê Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è - –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å Email
  app.post('/api/register', async (req, res) => {
    const { username, email, password } = req.body;

    console.log('\n' + '='.repeat(70));
    console.log('üìù –ó–∞–ø—Ä–æ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', { username, email });
    console.log('='.repeat(70));

    try {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      if (!username || !email || !password) {
        console.log('‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
        return res.status(400).json({ 
          error: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' 
        });
      }

      console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–µ–π –ø—Ä–æ–π–¥–µ–Ω–∞');

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
      if (username.length < 3 || password.length < 6) {
        console.log('‚ùå –û—à–∏–±–∫–∞: –∏–º—è < 3 —Å–∏–º–≤–æ–ª–æ–≤ –∏–ª–∏ –ø–∞—Ä–æ–ª—å < 6 —Å–∏–º–≤–æ–ª–æ–≤');
        return res.status(400).json({ 
          error: '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞, –ø–∞—Ä–æ–ª—å 6 —Å–∏–º–≤–æ–ª–æ–≤' 
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        console.log('‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
        return res.status(400).json({ 
          error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email' 
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ email
      db.query(
        'SELECT id FROM users WHERE email = ?',
        [email],
        async (err, results) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ email:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ë–î' });
          }

          if (results.length > 0) {
            console.log('‚ùå Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', email);
            return res.status(400).json({ 
              error: 'Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' 
            });
          }

          console.log('‚úÖ Email –Ω–µ –∑–∞–Ω—è—Ç:', email);

          // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–Ω—è—Ç–æ –ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query(
            'SELECT id FROM users WHERE username = ?',
            [username],
            async (err, results) => {
              if (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ë–î –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ username:', err);
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ë–î' });
              }

              if (results.length > 0) {
                console.log('‚ùå Username —É–∂–µ –∑–∞–Ω—è—Ç:', username);
                return res.status(400).json({ 
                  error: '–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ' 
                });
              }

              console.log('‚úÖ Username –Ω–µ –∑–∞–Ω—è—Ç:', username);

              // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –∏ session token
              const code = generateVerificationCode();
              const sessionToken = generateSessionToken();
              const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç

              console.log(`‚è±Ô∏è  –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞: ${expiresAt.toISOString()}`);
              console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –≤ –ë–î...');

              // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ email
              db.query(
                'DELETE FROM verification_codes WHERE email = ? AND is_verified = FALSE',
                [email],
                async (err) => {
                  if (err) console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∫–æ–¥–æ–≤:', err);

                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                  db.query(
                    `INSERT INTO verification_codes (email, phone, code, session_token, expires_at) VALUES (?, ?, ?, ?, ?)`,
                    [email, '', code, sessionToken, expiresAt],
                    async (err) => {
                      if (err) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–¥–∞ –≤ –ë–î:', err);
                        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                      }

                      console.log('‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ –≤ –ë–î —É—Å–ø–µ—à–Ω–æ');

                      // ‚ö° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –í –§–û–ù–ï (–Ω–µ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞)
                      console.log('üìß –°—Ç–∞–≤–ª—é email –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏...');
                      sendVerificationEmail(email, code, username).catch(err => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email –≤ —Ñ–æ–Ω–µ:', err.message);
                      });

                      // ‚úÖ –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (–Ω–µ –∂–¥–µ–º email)
                      console.log('‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—é –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É');
                      console.log('üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ\n');
                      res.json({
                        success: true,
                        message: '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email',
                        sessionToken: sessionToken
                      });
                    }
                  );
                }
              );
            }
          );
        }
      );
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
      console.log('');
      res.status(500).json({ 
        error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' 
      });
    }
  });

  // ‚≠ê Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è - –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å Email
  app.post('/api/register', async (req, res) => {
    const { username, email, password } = req.body;

    try {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      if (!username || !email || !password) {
        return res.status(400).json({ 
          error: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' 
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã
      if (username.length < 3 || password.length < 6) {
        return res.status(400).json({ 
          error: '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞, –ø–∞—Ä–æ–ª—å 6 —Å–∏–º–≤–æ–ª–æ–≤' 
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        return res.status(400).json({ 
          error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email' 
        });
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ email
      db.query(
        'SELECT id FROM users WHERE email = ?',
        [email],
        async (err, results) => {
          if (err) {
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ë–î' });
          }

          if (results.length > 0) {
            return res.status(400).json({ 
              error: 'Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' 
            });
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –∑–∞–Ω—è—Ç–æ –ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query(
            'SELECT id FROM users WHERE username = ?',
            [username],
            async (err, results) => {
              if (err) {
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ë–î' });
              }

              if (results.length > 0) {
                return res.status(400).json({ 
                  error: '–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ' 
                });
              }

              // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –∏ session token
              const code = generateVerificationCode();
              const sessionToken = generateSessionToken();
              const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç

              // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ email
              db.query(
                'DELETE FROM verification_codes WHERE email = ? AND is_verified = FALSE',
                [email],
                async (err) => {
                  if (err) console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –∫–æ–¥–æ–≤:', err);

                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                  db.query(
                    `INSERT INTO verification_codes (email, phone, code, session_token, expires_at) VALUES (?, ?, ?, ?, ?)`,
                    [email, '', code, sessionToken, expiresAt],
                    async (err) => {
                      if (err) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–¥–∞:', err);
                        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                      }

                      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email —Å –∫–æ–¥–æ–º
                      try {
                        await sendVerificationEmail(email, code, username);
                        
                        res.json({
                          success: true,
                          message: '–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email',
                          sessionToken: sessionToken
                        });
                      } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email:', error);
                        res.status(500).json({ error: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å email' });
                      }
                    }
                  );
                }
              );
            }
          );
        }
      );
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
      res.status(500).json({ 
        error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' 
      });
    }
  });

  // ‚≠ê Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è - –®–∞–≥ 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–¥–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
  app.post('/api/verify-code', async (req, res) => {
    const { email, code, username, password } = req.body;

    console.log('\n' + '='.repeat(70));
    console.log('üîê –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–¥–∞:', { email, code });
    console.log('='.repeat(70));

    try {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!email || !code || !username || !password) {
        console.log('‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è: –Ω–µ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã');
        return res.status(400).json({ 
          error: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' 
        });
      }

      console.log('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞');

      // –ü–æ–∏—Å–∫ –∑–∞–ø–∏—Å–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      db.query(
        `SELECT * FROM verification_codes 
         WHERE email = ? AND is_verified = FALSE`,
        [email],
        async (err, results) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ë–î:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ë–î' });
          }

          if (results.length === 0) {
            console.log('‚ùå –ó–∞–ø–∏—Å—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è:', email);
            return res.status(400).json({ 
              error: '–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–µ –Ω–∞–π–¥–µ–Ω' 
            });
          }

          const record = results[0];
          console.log('‚úÖ –ó–∞–ø–∏—Å—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω–∞');
          console.log(`   –ü–æ–ø—ã—Ç–æ–∫: ${record.attempts}/${record.max_attempts}`);
          console.log(`   –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: ${record.expires_at}`);

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
          if (new Date() > new Date(record.expires_at)) {
            console.log('‚ùå –ö–æ–¥ –∏—Å—Ç—ë–∫');
            // –£–¥–∞–ª—è–µ–º –∏—Å—Ç–µ–∫—à—É—é –∑–∞–ø–∏—Å—å
            db.query(
              'DELETE FROM verification_codes WHERE id = ?',
              [record.id]
            );
            
            return res.status(400).json({ 
              error: '–ö–æ–¥ –∏—Å—Ç–µ–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥' 
            });
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞ –ø–æ–ø—ã—Ç–æ–∫
          if (record.attempts >= record.max_attempts) {
            console.log('‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫');
            return res.status(400).json({ 
              error: '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—ã–π –∫–æ–¥' 
            });
          }

          console.log(`üîç –ü—Ä–æ–≤–µ—Ä—è—é –∫–æ–¥: ${code} === ${record.code}`);

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
          if (record.code !== code.toString()) {
            console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥! –£–≤–µ–ª–∏—á–∏–≤–∞—é —Å—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫');
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
            db.query(
              'UPDATE verification_codes SET attempts = attempts + 1 WHERE id = ?',
              [record.id],
              () => {
                const remainingAttempts = record.max_attempts - record.attempts - 1;
                console.log(`   –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${remainingAttempts}`);
              }
            );
            
            return res.status(400).json({ 
              error: '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
              remainingAttempts: record.max_attempts - record.attempts - 1
            });
          }

          console.log('‚úÖ –ö–æ–¥ –≤–µ—Ä–Ω—ã–π!');
          console.log('üë§ –°–æ–∑–¥–∞—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');

          // –ö–æ–¥ –≤–µ—Ä–Ω—ã–π - —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          try {
            const hashedPassword = await bcrypt.hash(password, 10);

            db.query(
              `INSERT INTO users (username, email, password) 
               VALUES (?, ?, ?)`,
              [username, email, hashedPassword],
              (err, result) => {
                if (err) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
                  if (err.code === 'ER_DUP_ENTRY') {
                    if (err.sqlMessage.includes('username')) {
                      return res.status(400).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });
                    }
                    if (err.sqlMessage.includes('email')) {
                      return res.status(400).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });
                    }
                  }
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞' });
                }

                const userId = result.insertId;
                console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω. ID: ${userId}`);

                // –û—Ç–º–µ—á–∞–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
                db.query(
                  'UPDATE verification_codes SET is_verified = TRUE WHERE id = ?',
                  [record.id],
                  () => console.log('‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è')
                );

                // –°–æ–∑–¥–∞–µ–º JWT —Ç–æ–∫–µ–Ω
                const token = jwt.sign(
                  { id: userId, email: email, username: username },
                  process.env.JWT_SECRET || 'your_jwt_secret',
                  { expiresIn: '30d' }
                );

                console.log(`üé´ JWT —Ç–æ–∫–µ–Ω —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (30 –¥–Ω–µ–π)`);

                // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                db.query(
                  'SELECT id, username, email, avatar, bio, status, cardColor, is_banned FROM users WHERE id = ?',
                  [userId],
                  (err, userData) => {
                    if (err) {
                      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
                      return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                    }

                    console.log('üéâ –ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω\n');
                    res.json({
                      success: true,
                      message: '–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
                      token: token,
                      user: userData[0]
                    });
                  }
                );
              }
            );
          } catch (hashError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è:', hashError);
            console.log('');
            res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
        }
      );
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–¥–∞:', error);
      console.log('');
      res.status(500).json({ 
        error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' 
      });
    }
  });

  // ‚≠ê Email –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è - –ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
  app.post('/api/resend-verification-code', async (req, res) => {
    const { email } = req.body;

    console.log('\n' + '='.repeat(70));
    console.log('üîÑ –ó–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', { email });
    console.log('='.repeat(70));

    try {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!email) {
        console.log('‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è: email –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω');
        return res.status(400).json({ 
          error: 'Email –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' 
        });
      }

      // –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
      db.query(
        `SELECT * FROM verification_codes 
         WHERE email = ? AND is_verified = FALSE`,
        [email],
        async (err, results) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ë–î:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ë–î' });
          }

          if (results.length === 0) {
            console.log('‚ùå –ó–∞–ø–∏—Å—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è:', email);
            return res.status(400).json({ 
              error: '–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–µ –Ω–∞–π–¥–µ–Ω' 
            });
          }

          const record = results[0];

          console.log('‚úÖ –ó–∞–ø–∏—Å—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω–∞');
          console.log('üîÑ –ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞...');

          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–æ–¥
          const newCode = generateVerificationCode();
          const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // –ù–æ–≤—ã–π 5-–º–∏–Ω—É—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä

          console.log(`‚è±Ô∏è  –ù–æ–≤—ã–π —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: ${expiresAt.toISOString()}`);
          console.log('üíæ –û–±–Ω–æ–≤–ª—è—é –ë–î...');

          // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
          db.query(
            `UPDATE verification_codes 
             SET code = ?, expires_at = ?, attempts = 0 
             WHERE email = ?`,
            [newCode, expiresAt, email],
            async (err) => {
              if (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞:', err);
                console.log('');
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }

              console.log('‚úÖ –ë–î –æ–±–Ω–æ–≤–ª–µ–Ω–∞, —Å—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ —Å–±—Ä–æ—à–µ–Ω');

              // ‚ö° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –í –§–û–ù–ï (–Ω–µ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞)
              console.log('üìß –°—Ç–∞–≤–ª—é email –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏...');
              sendVerificationEmail(email, newCode, email.split('@')[0]).catch(err => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email –≤ —Ñ–æ–Ω–µ:', err.message);
              });

              // ‚úÖ –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (–Ω–µ –∂–¥–µ–º email)
              console.log('‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—é –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É');
              console.log('üéâ –ö–æ–¥ –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ\n');
              res.json({
                success: true,
                message: '–ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email'
              });
            }
          );
        }
      );
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', error);
      console.log('');
      res.status(500).json({ 
        error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' 
      });
    }
  });

  // –í—Ö–æ–¥
  app.post('/api/login', (req, res) => {
    const { email, password } = req.body;
    
    console.log('–î–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥–∞:', { email, password });
    
    if (!email || !password) {
      return res.status(400).json({ error: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    }
    
    db.query('SELECT * FROM users WHERE email = ?', [email], async (err, results) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ë–î:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length === 0) {
        return res.status(400).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      const user = results[0];
      
      // ‚úÖ –ü–†–û–í–ï–†–Ø–ï–ú: –ù–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      if (user.is_banned) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å—Ç–µ–∫–ª–∞ –ª–∏ –¥–∞—Ç–∞ —Ä–∞–∑–±–∞–Ω–∞
        if (user.banned_until && new Date() > new Date(user.banned_until)) {
          // –†–∞–∑–±–∞–Ω–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          db.query(
            'UPDATE users SET is_banned = FALSE, ban_reason = NULL, banned_at = NULL, banned_until = NULL, banned_by = NULL WHERE id = ?',
            [user.id],
            (err) => {
              if (err) console.error('‚ùå Error auto-unbanning user:', err);
              else console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.id} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∞–Ω–µ–Ω (–∏—Å—Ç–µ–∫–ª–∞ –¥–∞—Ç–∞ —Ä–∞–∑–±–∞–Ω–∞)`);
            }
          );
          // –ü–æ–∑–≤–æ–ª—è–µ–º –≤–æ–π—Ç–∏ - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–ª—å—à–µ
        } else {
          console.log(`‚ùå –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –∑–∞–±–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${user.username}`);
          
          // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–Ω–µ
          let banMessage = '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
          let remainingDays = null;
          
          if (user.banned_until) {
            const now = new Date();
            const bannedUntil = new Date(user.banned_until);
            const daysRemaining = Math.ceil((bannedUntil - now) / (1000 * 60 * 60 * 24));
            
            if (daysRemaining > 0) {
              remainingDays = daysRemaining;
              banMessage = `–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${daysRemaining} –¥–Ω–µ–π`;
            }
          }
          
          return res.status(403).json({ 
            error: banMessage,
            reason: user.ban_reason || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤–∞',
            banned_at: user.banned_at,
            banned_until: user.banned_until,
            remainingDays: remainingDays,
            is_permanent: !user.banned_until
          });
        }
      }
      
      const validPassword = await bcrypt.compare(password, user.password);
      
      if (!validPassword) {
        return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å' });
      }
      
      const token = jwt.sign({ id: user.id, username: user.username }, process.env.JWT_SECRET);
      res.json({ 
        token, 
        user: { 
          id: user.id, 
          username: user.username, 
          email: user.email, 
          avatar: user.avatar, 
          bio: user.bio, 
          status: user.status,
          is_admin: user.is_admin || false,
          is_banned: user.is_banned || false
        } 
      });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/groups', authenticateToken, (req, res) => {
    const userId = req.user.id;
    
    db.query(`
      SELECT 
        g.*,
        COUNT(gm.user_id) as member_count,
        (SELECT gm2.message FROM group_messages gm2
        WHERE gm2.group_id = g.id
        ORDER BY gm2.created_at DESC
        LIMIT 1) as last_message,
        (SELECT gm2.id FROM group_messages gm2
        WHERE gm2.group_id = g.id
        ORDER BY gm2.created_at DESC
        LIMIT 1) as last_message_id,
        (SELECT gm2.created_at FROM group_messages gm2
        WHERE gm2.group_id = g.id
        ORDER BY gm2.created_at DESC
        LIMIT 1) as last_message_time,
        (SELECT COALESCE(MAX(CASE WHEN gmrs.is_read = TRUE THEN 1 ELSE 0 END), 0)
        FROM group_messages gm2
        LEFT JOIN group_message_read_status gmrs ON gm2.id = gmrs.message_id AND gmrs.reader_id = ?
        WHERE gm2.group_id = g.id
        ORDER BY gm2.created_at DESC
        LIMIT 1) as last_message_is_read,
        (SELECT COUNT(*) FROM group_messages gm3
        WHERE gm3.group_id = g.id AND NOT EXISTS (
          SELECT 1 FROM group_message_read_status
          WHERE message_id = gm3.id AND reader_id = ? AND is_read = TRUE
        )) as unread_count
      FROM groups g 
      LEFT JOIN group_members gm ON g.id = gm.group_id 
      WHERE g.id IN (
        SELECT group_id FROM group_members WHERE user_id = ?
      ) 
      GROUP BY g.id
      ORDER BY last_message_time DESC
    `, [userId, userId, userId], (err, results) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–ø–ø:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      const groups = (results || []).map(group => ({
        ...group,
        last_message_is_read: group.last_message_is_read === 1,  // ‚úÖ –ù–û–í–û–ï: –°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è
        unread_count: group.unread_count || 0
      }));
      
      console.log(`‚úÖ Loaded ${groups.length} groups for user ${userId}`);
      
      res.json(groups);
    });
  });

  // –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
  app.post('/api/groups', authenticateToken, (req, res) => {
    const { name, description, avatar, members = [] } = req.body;
    
    console.log(`[DEBUG] Creating group: name="${name}", members=${JSON.stringify(members)}`);
    
    if (!name || name.trim().length === 0) {
      return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    }
    
    db.query(
      'INSERT INTO groups (name, description, avatar, created_by) VALUES (?, ?, ?, ?)',
      [name, description || null, avatar || null, req.user.id],
      (err, result) => {
        if (err) {
          console.error('[ERROR] Failed to create group:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const groupId = result.insertId;
        console.log(`[DEBUG] Group created with ID ${groupId}`);
        
        // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–∞–∫ –∞–¥–º–∏–Ω–∞
        db.query(
          'INSERT INTO group_members (group_id, user_id, role) VALUES (?, ?, ?)',
          [groupId, req.user.id, 'admin'],
          (err) => {
            if (err) {
              console.error('[ERROR] Failed to add creator as admin:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            // –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            if (members && members.length > 0) {
              console.log(`[DEBUG] Adding ${members.length} members to group ${groupId}`);
              const memberValues = members.map(memberId => [groupId, memberId]);
              db.query(
                'INSERT INTO group_members (group_id, user_id) VALUES ?',
                [memberValues],
                (err) => {
                  if (err) {
                    console.error('[ERROR] Failed to add members:', err);
                  } else {
                    console.log(`[DEBUG] Successfully added ${members.length} members`);
                  }
                }
              );
            }
            
            console.log(`[DEBUG] Group ${groupId} created successfully`);
            res.json({ 
              id: groupId, 
              name, 
              description, 
              avatar, 
              created_by: req.user.id, 
              message: '–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞' 
            });
          }
        );
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/users/:userId/status', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    db.query('SELECT is_online, last_seen FROM users WHERE id = ?', [userId], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: 'Server error' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: 'User not found' });
      }
      
      res.json({ 
        is_online: results[0].is_online || false,
        last_seen: results[0].last_seen  // ‚≠ê –î–û–ë–ê–í–õ–ï–ù–û
      });
    });
  });

  // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
  app.post('/api/users/status', authenticateToken, (req, res) => {
    try {
      // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ req.body —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (!req.body || typeof req.body !== 'object') {
        console.warn('‚ö†Ô∏è req.body is not an object:', typeof req.body, req.body);
        req.body = {};
      }
      
      const { is_online } = req.body;
      
      // –õ–æ–≥–∏—Ä—É–µ–º –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      console.log('DEBUG /api/users/status:', {
        is_online,
        type: typeof is_online,
        body: req.body,
        user_id: req.user.id
      });
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ boolean
      let statusValue = false;
      if (typeof is_online === 'boolean') {
        statusValue = is_online;
      } else if (typeof is_online === 'string') {
        statusValue = is_online === 'true' || is_online === '1';
      } else if (typeof is_online === 'number') {
        statusValue = is_online === 1 || is_online === true;
      }
      
      console.log('Converted status value:', statusValue);
      
      // ‚≠ê –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ last_seen –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –≤ –æ—Ñ–ª–∞–π–Ω
      const query = statusValue 
        ? 'UPDATE users SET is_online = 1 WHERE id = ?'
        : 'UPDATE users SET is_online = 0, last_seen = NOW() WHERE id = ?';
      
      db.query(
        query,
        [req.user.id],
        (err, result) => {
          if (err) {
            console.error('Database error:', err);
            return res.status(500).json({ error: 'Server error', details: err.message });
          }
          
          console.log(`‚úÖ User ${req.user.id} status updated to ${statusValue}`);
          
          // ‚≠ê –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º timestamp –≤ —Å–æ–±—ã—Ç–∏–µ
          io.emit('user_status_changed', {
            user_id: req.user.id,
            is_online: statusValue,
            timestamp: new Date().toISOString()  // ‚≠ê –ù–û–í–û–ï –ü–û–õ–ï
          });
          
          res.json({ success: true, status: statusValue });
        }
      );
    } catch (error) {
      console.error('Unexpected error in /api/users/status:', error);
      res.status(500).json({ error: 'Server error', message: error.message });
    }
  });

  // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
  // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
  // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
  app.get('/api/groups/:groupId/messages', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    
    console.log(`[DEBUG] Loading messages for group ${groupId}, user ${req.user.id}`);
    
    db.query(`
      SELECT gm.*, u.username as sender_username, u.avatar as sender_avatar,
            rm.message as reply_to_message,
            rm.sender_id as reply_to_sender_id,
            ru.username as reply_to_sender
      FROM group_messages gm 
      JOIN users u ON gm.sender_id = u.id 
      LEFT JOIN group_messages rm ON gm.reply_to = rm.id
      LEFT JOIN users ru ON rm.sender_id = ru.id
      WHERE gm.group_id = ? 
      ORDER BY gm.created_at ASC
    `, [groupId], (err, results) => {
      if (err) {
        console.error(`[ERROR] Failed to load group messages: ${err.message}`);
        console.error(err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', details: err.message });
      }
      
      console.log(`[DEBUG] Loaded ${results ? results.length : 0} messages for group ${groupId}`);
      if (results && results.length > 0) {
        results.forEach((msg, idx) => {
          console.log(`[DEBUG] [${idx}] id=${msg.id}, sender=${msg.sender_username}, has_avatar=${!!msg.sender_avatar}`);
        });
      }
      
      res.json(results || []);
    });
  });

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É
  app.post('/api/groups/:groupId/messages', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    const { message, reply_to, media_type = 'text', media_url, duration, caption } = req.body;
    const sender_id = req.user.id;

    // üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (global.mutedUsers) {
      const muteInfo = global.mutedUsers.get(String(sender_id));
      
      if (muteInfo && new Date() < new Date(muteInfo.muteUntil)) {
        return res.status(403).json({ 
          error: '–í—ã –∑–∞–≥–ª—É—à–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
          until: muteInfo.muteUntil
        });
      } else if (muteInfo) {
        global.mutedUsers.delete(String(sender_id));
      }
    }
    
    // üîç –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –û–¢–ü–†–ê–í–ö–ò –ì–†–£–ü–ü–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø
    console.log(`\n${'='.repeat(70)}`);
    console.log(`üì§ –û–¢–ü–†–ê–í–ö–ê –ì–†–£–ü–ü–û–í–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø:`);
    console.log(`   –ì—Ä—É–ø–ø–∞: ${groupId}`);
    console.log(`   –û—Ç: ${sender_id}`);
    console.log(`   –¢–µ–∫—Å—Ç: ${(message || '').slice(0, 50)}...`);
    console.log(`   –¢–∏–ø: ${media_type}`);
    console.log(`${'='.repeat(70)}`);
    
    db.query(
      'INSERT INTO group_messages (group_id, sender_id, message, reply_to, media_type, media_url, duration, caption) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
      [groupId, sender_id, message, reply_to || null, media_type, media_url || null, duration || null, caption || null],
      (err, result) => {
        if (err) {
          console.error('‚ùå Error inserting group message:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const messageId = result.insertId;
        console.log(`‚úÖ –ì—Ä—É–ø–ø–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ${messageId} –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –ë–î`);
        
        // ‚≠ê –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users
        db.query(
          'SELECT avatar FROM users WHERE id = ?',
          [sender_id],
          (err, userResults) => {
            if (err) {
              console.error('‚ùå Error fetching user avatar:', err);
            }
            
            const userAvatar = userResults && userResults.length > 0 ? userResults[0].avatar : null;
            
            console.log(`üìù New group message: id=${messageId}, sender_id=${sender_id}, has_avatar=${!!userAvatar}`);
            
            const messageData = {
              id: messageId,
              group_id: groupId,
              sender_id: sender_id,
              message,
              reply_to: reply_to || null,
              media_type,
              media_url: media_url || null,
              duration: duration || null,
              caption: caption || null,
              sender_username: req.user.username,
              sender_avatar: userAvatar,  // ‚≠ê –ì–õ–ê–í–ù–û–ï: –ü–µ—Ä–µ–¥–∞–µ–º –∞–≤–∞—Ç–∞—Ä—É –∏–∑ –ë–î
              created_at: new Date()
            };
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ–º –≥—Ä—É–ø–ø–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            db.query(
              `INSERT INTO group_message_read_status (message_id, reader_id, is_read, read_at)
              VALUES (?, ?, TRUE, CURRENT_TIMESTAMP)`,
              [messageId, sender_id],
              (err) => {
                if (err) console.error('Error marking group message as read for sender:', err);
              }
            );
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
            res.json(messageData);
            console.log(`üì§ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É`);

            // üî¥ –û–¢–ü–†–ê–í–õ–Ø–ï–ú SOCKET.IO –°–û–ë–´–¢–ò–ï
            console.log(`\nüîå Socket.io EVENTS:`);
            
            // üîß –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Socket.io –≤ –∫–æ–º–Ω–∞—Ç—É –≥—Ä—É–ø–ø—ã
            io.to(`group_${groupId}`).emit('new_group_message', messageData);
            console.log(`   ‚úÖ –≠–º–∏—Ç 'new_group_message' –≤ –∫–æ–º–Ω–∞—Ç—É: group_${groupId}`);
            
            console.log(`‚úÖ Group message sent via Socket.io`);
            console.log(`${'='.repeat(70)}\n`);
            
            // üîî –û–¢–ü–†–ê–í–ö–ê PUSH –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –ì–†–£–ü–ü–ï (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ)
            (async () => {
              try {
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —á–ª–µ–Ω–æ–≤ –≥—Ä—É–ø–ø—ã –∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                db.query(`
                  SELECT DISTINCT gm.user_id, pt.push_token
                  FROM group_members gm
                  LEFT JOIN push_tokens pt ON gm.user_id = pt.user_id
                  WHERE gm.group_id = ? AND gm.user_id != ?
                `, [groupId, sender_id], async (err, members) => {
                  if (err) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–ª–µ–Ω–æ–≤ –≥—Ä—É–ø–ø—ã:', err);
                    return;
                  }
                  
                  if (!members || members.length === 0) {
                    console.log(`‚ö†Ô∏è –ù–µ—Ç —á–ª–µ–Ω–æ–≤ –≥—Ä—É–ø–ø—ã ${groupId} –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ push`);
                    return;
                  }
                  
                  // –§–∏–ª—å—Ç—Ä—É–µ–º —á–ª–µ–Ω–æ–≤: —Ç–æ–ª—å–∫–æ —Ç–µ, –∫—Ç–æ –û–§–õ–ê–ô–ù –∏–ª–∏ –∏–º–µ–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
                  const validMembers = members.filter(m => {
                    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
                    if (!m.push_token || !Expo.isExpoPushToken(m.push_token)) {
                      console.log(`   ‚è≠Ô∏è –ß–ª–µ–Ω ${m.user_id}: –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞`);
                      return false;
                    }
                    
                    // –ì–õ–ê–í–ù–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const memberSockets = getUserSocketIds(m.user_id);
                    const isMemberOnline = memberSockets.length > 0;
                    
                    if (!isMemberOnline) {
                      // –û–§–õ–ê–ô–ù - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º push –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
                      console.log(`   ‚úÖ –ß–ª–µ–Ω ${m.user_id} –û–§–õ–ê–ô–ù ‚Üí –æ—Ç–ø—Ä–∞–≤–∏–º push`);
                      return true;
                    }
                    
                    // –û–ù–õ–ê–ô–ù - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∞–∫—Ç–∏–≤–Ω–æ–º –ª–∏ —á–∞—Ç–µ –≥—Ä—É–ø–ø—ã
                    if (isUserInActiveChat(m.user_id, groupId, 'group')) {
                      // –í –∞–∫—Ç–∏–≤–Ω–æ–º —á–∞—Ç–µ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º push
                      console.log(`   ‚ÑπÔ∏è –ß–ª–µ–Ω ${m.user_id} –û–ù–õ–ê–ô–ù –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ ‚Üí push –Ω–µ –Ω—É–∂–µ–Ω`);
                      return false;
                    }
                    
                    // –û–ù–õ–ê–ô–ù –Ω–æ –≤ –¥—Ä—É–≥–æ–º —á–∞—Ç–µ - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º push (–ø—É—Å—Ç—å —Å–ª—ã—à–∏—Ç –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
                    console.log(`   ‚ÑπÔ∏è –ß–ª–µ–Ω ${m.user_id} –û–ù–õ–ê–ô–ù –Ω–æ –≤ –¥—Ä—É–≥–æ–º —á–∞—Ç–µ ‚Üí –∑–≤—É–∫ –≤ app`);
                    return false;
                  });
                  
                  if (validMembers.length === 0) {
                    console.log(`‚ö†Ô∏è –ù–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –¥–ª—è push –≤ –≥—Ä—É–ø–ø–µ ${groupId} (–≤—Å–µ –ª–∏–±–æ –≤ —á–∞—Ç–µ, –ª–∏–±–æ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞)`);
                    return;
                  }
                  
                  // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≥—Ä—É–ø–ø—ã –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                  db.query('SELECT name FROM groups WHERE id = ?', [groupId], async (err, groupResults) => {
                    if (err) {
                      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã:', err);
                      return;
                    }
                    
                    const groupName = groupResults && groupResults.length > 0 ? groupResults[0].name : '–ì—Ä—É–ø–ø–∞';
                    
                    const pushMessages = validMembers.map(m => ({
                      to: m.push_token,
                      sound: 'default',
                      title: `üí¨ ${groupName}`,
                      body: `${req.user.username}: ${message.slice(0, 100)}`,
                      data: {
                        type: 'new_group_message',
                        group_id: groupId,
                        sender_id: req.user.id,
                        senderId: req.user.id,
                        senderName: req.user.username,
                        message_id: result.insertId,
                        message: message.slice(0, 100),
                        isGroup: true
                      },
                      badge: 1,
                      priority: 'high'
                    }));
                    
                    try {
                      const tickets = await expo.sendPushNotificationsAsync(pushMessages);
                      console.log(`‚úÖ Push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã ${pushMessages.length} —á–ª–µ–Ω–∞–º –≥—Ä—É–ø–ø—ã ${groupId}`);
                    } catch (error) {
                      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ group push:', error.message);
                    }
                  });
                });
              } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ push:', error.message);
              }
            })();
          }
        );
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π
  app.get('/api/friends', authenticateToken, (req, res) => {
    db.query(`
      SELECT u.id, u.username, u.email, u.avatar, f.status
      FROM friends f
      JOIN users u ON (f.friend_id = u.id OR f.user_id = u.id)
      WHERE (f.user_id = ? OR f.friend_id = ?) AND u.id != ? AND u.is_admin = FALSE
      ORDER BY f.created_at DESC
    `, [req.user.id, req.user.id, req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json(results);
    });
  });

  // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ò–°–ö–õ–Æ–ß–ê–ï–ú –ê–î–ú–ò–ù–û–í)
  app.get('/api/users/search', authenticateToken, (req, res) => {
    const { q } = req.query;
    
    if (!q || q.trim().length < 2) {
      return res.status(400).json({ error: '–ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞' });
    }
    
    db.query(`
      SELECT u.id, u.username, u.email, u.avatar,
            f.status as friend_status,
            CASE 
              WHEN f.user_id = ? THEN 'sent'
              WHEN f.friend_id = ? THEN 'received'
              ELSE NULL
            END as request_direction
      FROM users u
      LEFT JOIN friends f ON (f.user_id = ? AND f.friend_id = u.id) OR (f.friend_id = ? AND f.user_id = u.id)
      WHERE (u.username LIKE ? OR u.email LIKE ?) AND u.id != ? AND u.is_admin = FALSE
      LIMIT 20
    `, [req.user.id, req.user.id, req.user.id, req.user.id, `%${q}%`, `%${q}%`, req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json(results);
    });
  });

  app.post('/api/users/push-token', authenticateToken, (req, res) => {
    // Debug: –ª–æ–≥–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—Ç–æ–∫–µ–Ω –º–∞—Å–∫–∏—Ä—É–µ–º)
    try {
      const safeAuth = (req.headers && req.headers.authorization)
        ? req.headers.authorization.replace(/Bearer\s+(.{4}).+/, 'Bearer $1...')
        : 'none';
      console.log(`\n[DEBUG /api/users/push-token]`);
      console.log(`  Authorization: ${safeAuth}`);
      console.log(`  Body keys: ${Object.keys(req.body || {}).join(', ')}`);
    } catch (e) {
      // skip
    }

    const { deviceType, deviceName } = req.body || {};

    // –î–æ–ø—É—Å–∫–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞—Ü–∏–π –∫–ª—é—á–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–π—Ç–∏ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    const pushToken = (req.body && (req.body.pushToken || req.body.push_token || req.body.token || req.body.expoPushToken)) || null;

    if (!pushToken) {
      console.log(`  ‚ùå Push token is required`);
      return res.status(400).json({ error: 'Push token is required' });
    }

    // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ JWT —Ç–æ–∫–µ–Ω–∞ (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞)
    const userId = req.user?.id;

    if (!userId) {
      console.log(`  ‚ùå user_id not found in JWT token`);
      return res.status(401).json({ error: 'User not authenticated' });
    }

    console.log(`  ‚úì user_id from JWT: ${userId}`);
    console.log(`  ‚úì pushToken: ${String(pushToken).slice(0, 40)}...`);
    console.log(`  ‚úì deviceType: ${deviceType || 'unknown'}`);

    // ‚ú® –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º INSERT...ON DUPLICATE KEY UPDATE —Å –∫–ª—é—á–æ–º (user_id)
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ —É –∫–∞–∂–¥–æ–≥–æ user_id –±—É–¥–µ—Ç —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω
    db.query(
      `INSERT INTO push_tokens (user_id, push_token, device_type, device_name) 
      VALUES (?, ?, ?, ?)
      ON DUPLICATE KEY UPDATE 
        push_token = VALUES(push_token),
        device_type = VALUES(device_type),
        device_name = VALUES(device_name),
        updated_at = CURRENT_TIMESTAMP`,
      [userId, pushToken, deviceType || 'unknown', deviceName || 'Unknown Device'],
      (err) => {
        if (err) {
          console.error(`  ‚ùå Database error:`, err.message);
          return res.status(500).json({ error: 'Server error', details: err.message });
        }
        
        console.log(`  ‚úÖ Push token saved for user_id=${userId}: ${String(pushToken).slice(0, 40)}...`);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±—ã–ª–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ
        db.query(
          'SELECT user_id, push_token FROM push_tokens WHERE user_id = ?',
          [userId],
          (err, results) => {
            if (!err && results.length > 0) {
              console.log(`  ‚úì Verification: found ${results.length} token(s) for user_id=${userId}`);
              results.forEach((row, idx) => {
                console.log(`    [${idx}] token=${row.push_token.slice(0, 40)}...`);
              });
            }
          }
        );

        res.json({ 
          message: 'Push token registered successfully', 
          user_id: userId,
          token_prefix: String(pushToken).slice(0, 40)
        });
      }
    );
  });

  // –£–¥–∞–ª–µ–Ω–∏–µ push-—Ç–æ–∫–µ–Ω–∞
  app.delete('/api/users/push-token', authenticateToken, (req, res) => {
    const { pushToken } = req.body;

    if (!pushToken) {
      return res.status(400).json({ error: 'Push token is required' });
    }

    db.query(
      'DELETE FROM push_tokens WHERE push_token = ? AND user_id = ?',
      [pushToken, req.user.id],
      (err, result) => {
        if (err) {
          console.error('Database error:', err);
          return res.status(500).json({ error: 'Server error' });
        }
        res.json({ message: 'Push token removed successfully' });
      }
    );
  });

  // –ü–æ–ª—É—á–µ–Ω–∏–µ push-—Ç–æ–∫–µ–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/users/push-tokens', authenticateToken, (req, res) => {
    db.query(
      `SELECT push_token, device_type, device_name, created_at, updated_at
      FROM push_tokens
      WHERE user_id = ?
      ORDER BY updated_at DESC`,
      [req.user.id],
      (err, results) => {
        if (err) {
          console.error('Database error:', err);
          return res.status(500).json({ error: 'Server error' });
        }
        res.json(results);
      }
    );
  });

  // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  async function sendPushNotifications(userId, title, body, data = {}) {
    db.query(
      'SELECT push_token FROM push_tokens WHERE user_id = ?',
      [userId],
      async (err, results) => {
        if (err) {
          console.error('Error fetching push tokens:', err);
          return;
        }

        const tokens = results.map(row => row.push_token);
        
        if (tokens.length === 0) {
          console.log('No push tokens found for user:', userId);
          return;
        }

        try {
          // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ Expo Push API
          console.log('Sending push notifications to tokens:', tokens);
          console.log('Notification:', { title, body, data });
        } catch (error) {
          console.error('Error sending push notifications:', error);
        }
      }
    );
  }

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –≤ –¥—Ä—É–∑—å—è
  app.post('/api/friends/request/:userId', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    console.log(`[DEBUG] Friend request endpoint - userId: "${userId}", type: ${typeof userId}, req.user.id: ${req.user.id}`);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è userId
    if (!userId || userId === 'undefined' || isNaN(parseInt(userId))) {
      console.error('‚ùå Invalid userId:', userId);
      return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
    }
    
    const parsedUserId = parseInt(userId);
    
    if (parsedUserId == req.user.id) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    db.query('SELECT id FROM users WHERE id = ?', [parsedUserId], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∂–µ –ª–∏ –µ—Å—Ç—å —Ç–∞–∫–∞—è –∑–∞—è–≤–∫–∞ –∏–ª–∏ –¥—Ä—É–∂–±–∞
      db.query(`
        SELECT status FROM friends 
        WHERE (user_id = ? AND friend_id = ?) 
          OR (user_id = ? AND friend_id = ?)
      `, [req.user.id, parsedUserId, parsedUserId, req.user.id], (err, existingResults) => {
        if (err) {
          console.error('Database error:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (existingResults.length > 0) {
          const existingFriendship = existingResults[0];
          if (existingFriendship.status === 'accepted') {
            return res.status(400).json({ error: '–í—ã —É–∂–µ –¥—Ä—É–∑—å—è' });
          } else {
            return res.status(400).json({ error: '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' });
          }
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É
        db.query(
          'INSERT INTO friends (user_id, friend_id, status) VALUES (?, ?, "pending")',
          [req.user.id, parsedUserId],
          (err, result) => {
            if (err) {
              console.error('Database error:', err);
              if (err.code === 'ER_DUP_ENTRY') {
                return res.status(400).json({ error: '–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' });
              }
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ Friend request sent from ${req.user.id} to ${parsedUserId}`);
            res.json({ success: true, message: '–ó–∞—è–≤–∫–∞ –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' });
          }
        );
      });
    });
  });

  // –ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É –≤ –¥—Ä—É–∑—å—è
  app.post('/api/friends/accept/:userId', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    db.query(
      'UPDATE friends SET status = "accepted" WHERE user_id = ? AND friend_id = ? AND status = "pending"',
      [userId, req.user.id],
      (err, result) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        if (result.affectedRows === 0) {
          return res.status(404).json({ error: '–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
        }
        res.json({ message: '–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞' });
      }
    );
  });

  // –£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π
  app.delete('/api/friends/:userId', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    db.query(
      'DELETE FROM friends WHERE (user_id = ? AND friend_id = ?) OR (user_id = ? AND friend_id = ?)',
      [req.user.id, userId, userId, req.user.id],
      (err, result) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json({ message: '–£–¥–∞–ª–µ–Ω–æ –∏–∑ –¥—Ä—É–∑–µ–π' });
      }
    );
  });

  app.post('/api/groups/:groupId/members', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    const { userId } = req.body;

    if (!userId) {
      return res.status(400).json({ error: 'userId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }

    if (Number(userId) === req.user.id) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞' });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º –≥—Ä—É–ø–ø—ã
    db.query(
      'SELECT role FROM group_members WHERE group_id = ? AND user_id = ?',
      [groupId, req.user.id],
      (err, results) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        if (results.length === 0 || results[0].role !== 'admin') {
          return res.status(403).json({ error: '–î–æ–±–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –≥—Ä—É–ø–ø—ã' });
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–∏—Å—Ç–µ–º–µ
        db.query('SELECT id FROM users WHERE id = ?', [userId], (err, userResults) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }

          if (userResults.length === 0) {
            return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
          }

          // –ü—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
          db.query(
            `INSERT INTO group_members (group_id, user_id, role)
            VALUES (?, ?, 'member')`,
            [groupId, userId],
            (err) => {
              if (err) {
                if (err.code === 'ER_DUP_ENTRY') {
                  return res.status(400).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –≥—Ä—É–ø–ø–µ' });
                }
                console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:', err);
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }

              res.json({ success: true, message: '–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω' });
            }
          );
        });
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–∫–ª—é—á–∞—è —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –≤ –¥—Ä—É–∑—å—è—Ö)
  app.get('/api/chats', authenticateToken, (req, res) => {
    const userId = req.user.id;

    // SQL –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —É —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞ –µ—Å—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫–∞
    // –í–∫–ª—é—á–∞–µ—Ç –¥–∞–∂–µ —Ç–µ—Ö, –∫—Ç–æ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –¥—Ä—É–∑–µ–π
    const query = `
      SELECT 
        u.id,
        u.username,
        u.avatar,
        u.is_online,
        u.status,
        u.bio,
        u.email,
        u.created_at,
        MAX(m.created_at) as last_message_time,
        (SELECT m2.id FROM messages m2 
        WHERE ((m2.sender_id = ? AND m2.receiver_id = u.id) OR 
                (m2.sender_id = u.id AND m2.receiver_id = ?))
        ORDER BY m2.created_at DESC 
        LIMIT 1) as last_message_id,
        (SELECT m2.message FROM messages m2 
        WHERE ((m2.sender_id = ? AND m2.receiver_id = u.id) OR 
                (m2.sender_id = u.id AND m2.receiver_id = ?))
        ORDER BY m2.created_at DESC 
        LIMIT 1) as last_message,
        (SELECT COALESCE(MAX(CASE WHEN mrs.is_read = TRUE THEN 1 ELSE 0 END), 0)
        FROM messages m2
        LEFT JOIN message_read_status mrs ON m2.id = mrs.message_id AND mrs.reader_id = ?
        WHERE ((m2.sender_id = ? AND m2.receiver_id = u.id) OR 
                (m2.sender_id = u.id AND m2.receiver_id = ?))
        ORDER BY m2.created_at DESC 
        LIMIT 1) as last_message_is_read,
        (SELECT COUNT(*) FROM messages m3 
        WHERE m3.sender_id = u.id AND m3.receiver_id = ? AND NOT EXISTS (
          SELECT 1 FROM message_read_status 
          WHERE message_id = m3.id AND reader_id = ? AND is_read = TRUE
        )) as unread_count,
        MAX(CASE WHEN f.status = 'accepted' THEN 1 ELSE 0 END) AS is_friend
      FROM users u
      INNER JOIN messages m ON 
        (m.sender_id = u.id AND m.receiver_id = ?) OR 
        (m.sender_id = ? AND m.receiver_id = u.id)
      LEFT JOIN friends f ON (
        (f.user_id = ? AND f.friend_id = u.id)
        OR
        (f.friend_id = ? AND f.user_id = u.id)
      )
      WHERE u.id != ?
      GROUP BY u.id, u.username, u.avatar, u.is_online, u.status, u.bio, u.email, u.created_at
      ORDER BY last_message_time DESC
    `;

    db.query(query, [userId, userId, userId, userId, userId, userId, userId, userId, userId, userId, userId, userId, userId, userId], (err, results) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–µ—Ä–µ–ø–∏—Å–æ–∫:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
      const conversations = (results || []).map(user => ({
        id: user.id,
        username: user.username,
        avatar: user.avatar,
        is_online: user.is_online,
        status: user.status,
        bio: user.bio,
        email: user.email,
        created_at: user.created_at,
        last_message: user.last_message,
        last_message_id: user.last_message_id,
        last_message_time: user.last_message_time,
        last_message_is_read: user.last_message_is_read === 1,  // ‚úÖ –ù–û–í–û–ï: –°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è
        unread_count: user.unread_count || 0,
        is_friend: user.is_friend,
        type: 'personal'  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
      }));

      console.log(`‚úÖ Loaded ${conversations.length} conversations for user ${userId}`);

      res.json(conversations);
    });
  });

  // GET /api/pinned-chats
  app.get('/api/pinned-chats', authenticateToken, (req, res) => {
    const userId = req.user.id;
    db.query(
      `SELECT id, user_id, chat_type, chat_id, pinned_at
      FROM pinned_chats
      WHERE user_id = ?
      ORDER BY pinned_at DESC`,
      [userId],
      (err, results) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–π' });
        }
        res.json({ success: true, data: results });
      }
    );
  });

  // POST /api/pinned-chats
  app.post('/api/pinned-chats', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const { chat_type, chat_id } = req.body;

    if (!chat_type || !chat_id) {
      return res.status(400).json({ error: 'chat_type –∏ chat_id –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    }

    const chatType = chat_type === 'group' ? 'group' : 'personal';
    const chatId = parseInt(chat_id, 10);
    if (!Number.isInteger(chatId) || chatId <= 0) {
      return res.status(400).json({ error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π chat_id' });
    }

    db.query(
      `INSERT INTO pinned_chats (user_id, chat_type, chat_id, pinned_at)
      VALUES (?, ?, ?, NOW())
      ON DUPLICATE KEY UPDATE pinned_at = NOW()`,
      [userId, chatType, chatId],
      (err, result) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è' });
        }

        db.query(
          `SELECT id, user_id, chat_type, chat_id, pinned_at
          FROM pinned_chats
          WHERE user_id = ? AND chat_type = ? AND chat_id = ?`,
          [userId, chatType, chatId],
          (err, rows) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–∞ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            res.json({ success: true, data: rows.length ? rows[0] : null });
          }
        );
      }
    );
  });

  // DELETE /api/pinned-chats/:chatType/:chatId
  app.delete('/api/pinned-chats/:chatType/:chatId', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const chatType = req.params.chatType === 'group' ? 'group' : 'personal';
    const chatId = parseInt(req.params.chatId, 10);

    if (!Number.isInteger(chatId) || chatId <= 0) {
      return res.status(400).json({ error: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π chatId' });
    }

    db.query(
      `DELETE FROM pinned_chats
      WHERE user_id = ? AND chat_type = ? AND chat_id = ?`,
      [userId, chatType, chatId],
      (err, result) => {
        if (err) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫—Ä–µ–ø–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è' });
        }
        res.json({ success: true });
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≥—Ä—É–ø–ø—ã
  app.get('/api/groups/:groupId/members', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    
    db.query(`
      SELECT u.id, u.username, u.avatar, gm.role 
      FROM group_members gm 
      JOIN users u ON gm.user_id = u.id 
      WHERE gm.group_id = ?
      ORDER BY gm.role DESC, u.username ASC
    `, [groupId], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json(results);
    });
  });

  // –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä—É–ø–ø—É
  app.put('/api/groups/:groupId', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    const { name, description, avatar } = req.body;
    
    db.query(
      'UPDATE groups SET name = ?, description = ?, avatar = ? WHERE id = ?',
      [name, description || null, avatar || null, groupId],
      (err, result) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json({ success: true, message: '–ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞' });
      }
    );
  });

  // –£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≥—Ä—É–ø–ø—ã
  app.delete('/api/groups/:groupId/members/:userId', authenticateToken, (req, res) => {
    const { groupId, userId } = req.params;
    
    db.query(
      'DELETE FROM group_members WHERE group_id = ? AND user_id = ?',
      [groupId, userId],
      (err, result) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json({ success: true, message: '–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω' });
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  app.get('/api/users', authenticateToken, (req, res) => {
    db.query('SELECT id, username, email, avatar, bio, status, cardColor FROM users WHERE id != ? AND is_admin = FALSE', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json(results);
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
  app.get('/api/users/:userId', (req, res) => {
    const userId = req.params.userId;
    
    if (!userId) {
      return res.status(400).json({ error: 'userId is required' });
    }
    
    const query = 'SELECT id, username, email, avatar, bio, status, is_online, cardColor, created_at FROM users WHERE id = ?';
    
    db.query(query, [userId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
        return res.status(500).json({ error: err.message });
      }
      
      if (!results || results.length === 0) {
        return res.status(404).json({ error: 'User not found' });
      }
      
      console.log(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –∑–∞–≥—Ä—É–∂–µ–Ω`);
      res.json(results[0]);
    });
  });

  // ========== BAN ENDPOINTS ==========

  // –ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ADMIN)
  app.post('/api/admin/users/:userId/ban', authenticateToken, (req, res) => {
    const { userId } = req.params;
    const { reason = '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤–∞', ban_duration_days } = req.body;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–¥–º–∏–Ω –Ω–µ –∑–∞–±–∞–Ω–∏–≤–∞–µ—Ç —Å–∞–º —Å–µ–±—è
      if (parseInt(userId) === req.user.id) {
        return res.status(400).json({ error: '–ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è' });
      }
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É —Ä–∞–∑–±–∞–Ω–∞
      let bannedUntil = null;
      if (ban_duration_days !== null && ban_duration_days !== undefined && ban_duration_days > 0) {
        const now = new Date();
        bannedUntil = new Date(now.getTime() + ban_duration_days * 24 * 60 * 60 * 1000);
      }
      // –ï—Å–ª–∏ null –∏–ª–∏ undefined - –±–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞, banned_until –æ—Å—Ç–∞–µ—Ç—Å—è null
      
      // –ó–∞–±–∞–Ω–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      db.query(
        'UPDATE users SET is_banned = TRUE, ban_reason = ?, banned_at = CURRENT_TIMESTAMP, banned_until = ?, banned_by = ? WHERE id = ?',
        [reason, bannedUntil, req.user.id, userId],
        (err, result) => {
          if (err) {
            console.error('‚ùå Error banning user:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          if (result.affectedRows === 0) {
            return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
          }
          
          const durationText = ban_duration_days === null || ban_duration_days === undefined
            ? '–Ω–∞–≤—Å–µ–≥–¥–∞'
            : `–Ω–∞ ${ban_duration_days} –¥–Ω–µ–π`;
          
          console.log(`üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∑–∞–±–∞–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id} ${durationText}. –ü—Ä–∏—á–∏–Ω–∞: ${reason}`);
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–∞–Ω–µ —á–µ—Ä–µ–∑ WebSocket –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω
          const userSocketIds = getUserSocketIds(userId);
          if (userSocketIds.length > 0) {
            userSocketIds.forEach((socketId) => {
              io.to(socketId).emit('user_banned', {
                reason: reason,
                message: '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
                bannedUntil: bannedUntil
              });
            });
          }
          
          res.json({ 
            success: true, 
            message: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ –∑–∞–±–∞–Ω–µ–Ω ${durationText}`,
            reason: reason,
            bannedUntil: bannedUntil
          });
        }
      );
    });
  });

  // –†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ADMIN)
  app.post('/api/admin/users/:userId/unban', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –†–∞–∑–±–∞–Ω–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      db.query(
        'UPDATE users SET is_banned = FALSE, ban_reason = NULL, banned_at = NULL, banned_until = NULL, banned_by = NULL WHERE id = ?',
        [userId],
        (err, result) => {
          if (err) {
            console.error('‚ùå Error unbanning user:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          if (result.affectedRows === 0) {
            return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
          }
          
          console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —Ä–∞–∑–±–∞–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id}`);
          
          res.json({ 
            success: true, 
            message: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–∞–Ω–µ–Ω`
          });
        }
      );
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ADMIN)
  app.get('/api/admin/users/:userId/ban-info', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–Ω–µ
      db.query(
        `SELECT u.id, u.username, u.email, u.is_banned, u.ban_reason, u.banned_at, u.banned_by,
                admin.username as banned_by_username
        FROM users u
        LEFT JOIN users admin ON u.banned_by = admin.id
        WHERE u.id = ?`,
        [userId],
        (err, results) => {
          if (err) {
            console.error('‚ùå Error fetching ban info:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          if (results.length === 0) {
            return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
          }
          
          res.json({ 
            success: true,
            data: results[0]
          });
        }
      );
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (ADMIN)
  app.get('/api/admin/banned-users', authenticateToken, (req, res) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∑–∞–±–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      db.query(
        `SELECT u.id, u.username, u.email, u.ban_reason, u.banned_at,
                admin.username as banned_by_username
        FROM users u
        LEFT JOIN users admin ON u.banned_by = admin.id
        WHERE u.is_banned = TRUE
        ORDER BY u.banned_at DESC`,
        (err, results) => {
          if (err) {
            console.error('‚ùå Error fetching banned users:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          res.json({ 
            success: true,
            count: results.length,
            data: results
          });
        }
      );
    });
  });

  // Health check endpoint
  app.get('/api/health', (req, res) => {
    res.status(200).json({
      status: 'OK',
      message: 'Server is running',
      timestamp: new Date().toISOString()
    });
  });

  // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É uploads –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
  const uploadsDir = path.join(__dirname, 'uploads');
  if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ multer –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
  const storage = multer.diskStorage({
    destination: function (req, file, cb) {
      cb(null, 'uploads/');
    },
    filename: function (req, file, cb) {
      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
      cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
  });

  const upload = multer({ 
    storage: storage,
    limits: {
      fileSize: 50 * 1024 * 1024 // 50MB –ª–∏–º–∏—Ç
    },
    fileFilter: function (req, file, cb) {
      // –†–∞–∑—Ä–µ—à–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ
      if (file.mimetype.startsWith('image/') || file.mimetype.startsWith('video/') || file.mimetype.startsWith('audio/')) {
        cb(null, true);
      } else {
        cb(null, true); // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      }
    }
  });

  // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤
  app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

  // Endpoint –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
  app.post('/api/upload', authenticateToken, upload.single('media'), (req, res) => {
    try {
      if (!req.file) {
        return res.status(400).json({ error: '–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }

      const fileUrl = `http://151.241.228.247:3001/uploads/${req.file.filename}`;
      
      res.json({
        success: true,
        url: fileUrl,
        filename: req.file.filename,
        originalName: req.file.originalname,
        size: req.file.size
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:', error);
      res.status(500).json({ error: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞' });
    }
  });

  // –ü–æ–ª—É—á–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  app.get('/api/messages/:userId', authenticateToken, (req, res) => {
    const { userId } = req.params;
    const currentUserId = req.user.id;
    
    db.query(`
      SELECT m.*, 
            su.username as sender_username,
            su.avatar as sender_avatar,
            rm.message as reply_to_message,
            rm.sender_id as reply_to_sender_id,
            ru.username as reply_to_sender,
            COALESCE(mrs.is_read, 0) as is_read
      FROM messages m
      JOIN users su ON m.sender_id = su.id
      LEFT JOIN messages rm ON m.reply_to = rm.id
      LEFT JOIN users ru ON rm.sender_id = ru.id
      LEFT JOIN message_read_status mrs ON m.id = mrs.message_id AND mrs.reader_id = ?
      WHERE (m.sender_id = ? AND m.receiver_id = ?) 
        OR (m.sender_id = ? AND m.receiver_id = ?)
      ORDER BY m.created_at ASC
    `, [currentUserId, currentUserId, userId, userId, currentUserId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      console.log(`üì§ GET /api/messages/${userId}: –í–æ–∑–≤—Ä–∞—â–∞—é ${results.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
      if (results.length > 0) {
        const lastMsg = results[results.length - 1];
        console.log(`   –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: id=${lastMsg.id}, sender_id=${lastMsg.sender_id}, is_read=${lastMsg.is_read}`);
      }
      
      res.json(results);
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/messages/:userId/unread-count', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    db.query(`
      SELECT COUNT(*) as unread_count
      FROM messages m
      WHERE m.receiver_id = ?
      AND NOT EXISTS (
        SELECT 1 FROM message_read_status 
        WHERE message_id = m.id AND reader_id = ? AND is_read = TRUE
      )
    `, [req.user.id, req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json({ unread_count: results[0].unread_count });
    });
  });

  // –û—Ç–º–µ—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
  app.post('/api/messages/:messageId/read', authenticateToken, (req, res) => {
    const { messageId } = req.params;
    
    db.query(
      `INSERT INTO message_read_status (message_id, reader_id, is_read, read_at)
      VALUES (?, ?, TRUE, CURRENT_TIMESTAMP)
      ON DUPLICATE KEY UPDATE is_read = TRUE, read_at = CURRENT_TIMESTAMP`,
      [messageId, req.user.id],
      (err) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json({ success: true });
      }
    );
  });

  // –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
  app.post('/api/messages/:userId/read-all', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    db.query(`
      INSERT INTO message_read_status (message_id, reader_id, is_read, read_at)
      SELECT m.id, ?, TRUE, CURRENT_TIMESTAMP
      FROM messages m
      WHERE m.sender_id = ? AND m.receiver_id = ?
      ON DUPLICATE KEY UPDATE is_read = TRUE, read_at = CURRENT_TIMESTAMP
    `, [req.user.id, userId, req.user.id], (err) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json({ success: true });
    });
  });

  // –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
  app.post('/api/groups/:groupId/read-all', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    
    db.query(`
      INSERT INTO group_message_read_status (message_id, reader_id, is_read, read_at)
      SELECT gm.id, ?, TRUE, CURRENT_TIMESTAMP
      FROM group_messages gm
      WHERE gm.group_id = ? AND gm.sender_id != ?
      ON DUPLICATE KEY UPDATE is_read = TRUE, read_at = CURRENT_TIMESTAMP
    `, [req.user.id, groupId, req.user.id], (err) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json({ success: true });
    });
  });

  // POST /api/groups/:groupId/leave
  // –í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥—Ä—É–ø–ø—ã
  app.post('/api/groups/:groupId/leave', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    const userId = req.user.id;

    // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≥—Ä—É–ø–ø–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    db.query(
      'SELECT id FROM groups WHERE id = ?',
      [groupId],
      (err, groups) => {
        if (err) {
          console.error('‚ùå Error checking group:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        if (groups.length === 0) {
          return res.status(404).json({ error: '–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
        }

        // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –≥—Ä—É–ø–ø–µ
        db.query(
          'SELECT id FROM group_members WHERE group_id = ? AND user_id = ?',
          [groupId, userId],
          (err, members) => {
            if (err) {
              console.error('‚ùå Error checking membership:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }

            if (members.length === 0) {
              return res.status(400).json({ error: '–í—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã' });
            }

            // –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥—Ä—É–ø–ø—ã
            db.query(
              'DELETE FROM group_members WHERE group_id = ? AND user_id = ?',
              [groupId, userId],
              (err) => {
                if (err) {
                  console.error('‚ùå Error removing member:', err);
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                }

                console.log(`‚úÖ User ${userId} left group ${groupId}`);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
                io.emit('user_left_group', {
                  group_id: groupId,
                  user_id: userId
                });

                res.json({ 
                  success: true, 
                  message: '–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É–ø–ø—É' 
                });
              }
            );
          }
        );
      }
    );
  });

  // ========== –û–ë–ù–û–í–ò–¢–¨ –ê–í–ê–¢–ê–† –ì–†–£–ü–ü–´ ==========
  app.post('/api/groups/:groupId/avatar', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    const { avatar } = req.body;
    
    if (!avatar) {
      return res.status(400).json({ error: '–ê–≤–∞—Ç–∞—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º –≥—Ä—É–ø–ø—ã
    db.query(
      'SELECT role FROM group_members WHERE group_id = ? AND user_id = ?',
      [groupId, req.user.id],
      (err, results) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (results.length === 0 || results[0].role !== 'admin') {
          return res.status(403).json({ error: '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –≥—Ä—É–ø–ø—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –∞–≤–∞—Ç–∞—Ä' });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã
        db.query(
          'UPDATE groups SET avatar = ? WHERE id = ?',
          [avatar, groupId],
          (err, result) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            if (result.affectedRows === 0) {
              return res.status(404).json({ error: '–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
            }
            
            console.log(`‚úÖ –ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã ${groupId} –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${req.user.id}`);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Socket.io
            io.to(`group_${groupId}`).emit('group_avatar_updated', {
              group_id: groupId,
              avatar: avatar
            });
            
            res.json({ 
              success: true, 
              message: '–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω',
              avatar: avatar
            });
          }
        );
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≥—Ä—É–ø–ø–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  app.get('/api/groups/:groupId/unread-count', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    
    db.query(`
      SELECT COUNT(*) as unread_count
      FROM group_messages gm
      WHERE gm.group_id = ?
      AND NOT EXISTS (
        SELECT 1 FROM group_message_read_status 
        WHERE message_id = gm.id AND reader_id = ? AND is_read = TRUE
      )
    `, [groupId, req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json({ unread_count: results[0].unread_count });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ª–∏—á–Ω–æ–º —á–∞—Ç–µ
  app.get('/api/chats/:chatId/pinned-messages', authenticateToken, (req, res) => {
    const { chatId } = req.params;

    db.query(`
      SELECT DISTINCT pm.id, pm.message_id, pm.chat_type, pm.chat_id, pm.pinned_at, pm.user_id, pm.is_visible_to_all
      FROM pinned_messages pm
      WHERE pm.chat_id = ? AND pm.chat_type = 'personal'
      AND (
        pm.is_visible_to_all = 1
        OR pm.user_id = ?
      )
      ORDER BY pm.pinned_at DESC
    `, [chatId, req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json(results);
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–æ–≤–æ–º —á–∞—Ç–µ
  app.get('/api/groups/:groupId/pinned-messages', authenticateToken, (req, res) => {
    const { groupId } = req.params;

    db.query(`
      SELECT DISTINCT pm.id, pm.message_id, pm.chat_type, pm.chat_id, pm.pinned_at, pm.user_id, pm.is_visible_to_all
      FROM pinned_messages pm
      WHERE pm.chat_id = ? AND pm.chat_type = 'group'
      ORDER BY pm.pinned_at DESC
    `, [groupId], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json(results);
    });
  });

  // –ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  app.post('/api/pinned-messages', authenticateToken, (req, res) => {
    const { message_id, chat_type, chat_id, is_visible_to_all } = req.body;

    console.log(`\nüìå POST /api/pinned-messages: message_id=${message_id}, chat_type=${chat_type}, chat_id=${chat_id}, is_visible_to_all=${is_visible_to_all}`);

    if (!message_id || !chat_type || !chat_id) {
      return res.status(400).json({ error: '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    }

    if (!['personal', 'group'].includes(chat_type)) {
      return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —á–∞—Ç–∞' });
    }

    db.query(
      `INSERT INTO pinned_messages (user_id, message_id, chat_type, chat_id, is_visible_to_all)
      VALUES (?, ?, ?, ?, ?)`,
      [req.user.id, message_id, chat_type, chat_id, is_visible_to_all ? 1 : 0],
      (err, result) => {
        if (err) {
          if (err.code === 'ER_DUP_ENTRY') {
            console.log(`‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ`);
            return res.status(400).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ' });
          }
          console.error('‚ùå Database error:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        console.log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ: id=${result.insertId}, is_visible_to_all=${is_visible_to_all ? 1 : 0}`);
        res.json({ success: true, id: result.insertId });
      }
    );
  });

  // –û—Ç–∫—Ä–µ–ø–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  app.delete('/api/pinned-messages/:messageId', authenticateToken, (req, res) => {
    const { messageId } = req.params;

    db.query(
      `DELETE FROM pinned_messages 
      WHERE user_id = ? AND message_id = ?`,
      [req.user.id, messageId],
      (err, result) => {
        if (err) {
          console.error('Database error:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        if (result.affectedRows === 0) {
          return res.status(404).json({ error: '–ó–∞–∫—Ä–µ–ø –Ω–µ –Ω–∞–π–¥–µ–Ω' });
        }
        res.json({ success: true });
      }
    );
  });

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
  app.post('/api/messages', authenticateToken, (req, res) => {
    const { receiver_id, message, reply_to, media_type = 'text', media_url, duration, caption } = req.body;
    const sender_id = req.user.id;

    // üîí –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if (global.mutedUsers) {
      const muteInfo = global.mutedUsers.get(String(sender_id));
      
      if (muteInfo && new Date() < new Date(muteInfo.muteUntil)) {
        return res.status(403).json({ 
          error: '–í—ã –∑–∞–≥–ª—É—à–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
          until: muteInfo.muteUntil
        });
      } else if (muteInfo) {
        global.mutedUsers.delete(String(sender_id));
      }
    }
    
    // üîç –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –û–¢–ü–†–ê–í–ö–ò
    console.log(`\n${'='.repeat(70)}`);
    console.log(`üì§ –û–¢–ü–†–ê–í–ö–ê –õ–ò–ß–ù–û–ì–û –°–û–û–ë–©–ï–ù–ò–Ø:`);
    console.log(`   –û—Ç: ${sender_id}`);
    console.log(`   –ö–æ–º—É: ${receiver_id}`);
    console.log(`   –¢–µ–∫—Å—Ç: ${(message || '').slice(0, 50)}...`);
    console.log(`   –¢–∏–ø: ${media_type}`);
    console.log(`${'='.repeat(70)}`);
    
    db.query(
      'INSERT INTO messages (sender_id, receiver_id, message, reply_to, media_type, media_url, duration, caption) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
      [sender_id, receiver_id, message, reply_to || null, media_type, media_url || null, duration || null, caption || null],
      (err, result) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const insertedMessageId = result.insertId;
        console.log(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ ${insertedMessageId} –≤—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –ë–î`);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        db.query(
          `INSERT INTO message_read_status (message_id, reader_id, is_read, read_at)
          VALUES (?, ?, TRUE, CURRENT_TIMESTAMP)`,
          [insertedMessageId, sender_id],
          (err) => {
            if (err) console.error('Error marking message as read for sender:', err);
          }
        );

        const sendResponseAndEvents = (messageData) => {
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
          res.json(messageData);
          console.log(`üì§ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É`);

          // üî¥ –û–¢–ü–†–ê–í–õ–Ø–ï–ú SOCKET.IO –°–û–ë–´–¢–ò–ï
          console.log(`\nüîå Socket.io EVENTS:`);
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
          io.to(`user_${sender_id}`).emit('new_message', messageData);
          console.log(`   ‚úÖ –≠–º–∏—Ç 'new_message' –≤ –∫–æ–º–Ω–∞—Ç—É: user_${sender_id}`);
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—é
          io.to(`user_${receiver_id}`).emit('new_message', messageData);
          console.log(`   ‚úÖ –≠–º–∏—Ç 'new_message' –≤ –∫–æ–º–Ω–∞—Ç—É: user_${receiver_id}`);
          
          console.log(`‚úÖ Personal message sent via Socket.io`);
          console.log(`${'='.repeat(70)}\n`);

          // üîî –û–¢–ü–†–ê–í–ö–ê PUSH –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –í–°–ï–ì–î–ê (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω)
          (async () => {
            try {
              console.log(`\n${'='.repeat(70)}`);
              console.log(`üì± PUSH –û–¢–ü–†–ê–í–ö–ê –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è ${receiver_id}:`);

              const receiverToken = await getPushTokenFromDB(receiver_id);

              if (!receiverToken) {
                console.log(`   ‚ö†Ô∏è Push-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${receiver_id}`);
                console.log(`${'='.repeat(70)}\n`);
                return;
              }

              if (!Expo.isExpoPushToken(receiverToken)) {
                console.log(`   ‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω: ${receiverToken}`);
                console.log(`${'='.repeat(70)}\n`);
                return;
              }

              const senderName = messageData?.sender_username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

              const pushMessage = {
                to: receiverToken,
                sound: 'default',
                title: `üì® ${senderName}`,
                body: (message || '').slice(0, 100),
                data: {
                  type: 'new_message',
                  sender_id: sender_id,
                  senderId: sender_id,
                  senderName: senderName,
                  message_id: insertedMessageId,
                  message: (message || '').slice(0, 100),
                  isGroup: false
                },
                badge: 1,
                priority: 'high'
              };

              try {
                const tickets = await expo.sendPushNotificationsAsync([pushMessage]);
                console.log(`   ‚úÖ Push —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`);
                console.log(`   üì≤ –¢–æ–∫–µ–Ω: ${receiverToken.slice(0, 40)}...`);
                console.log(`${'='.repeat(70)}\n`);
              } catch (error) {
                console.error('   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ push:', error.message);
                console.log(`${'='.repeat(70)}\n`);
              }
            } catch (error) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ push:', error.message);
            }
          })();
        };

        db.query(`
          SELECT m.*, 
                su.username as sender_username,
                su.avatar as sender_avatar,
                rm.message as reply_to_message,
                rm.sender_id as reply_to_sender_id,
                ru.username as reply_to_sender
          FROM messages m
          JOIN users su ON m.sender_id = su.id
          LEFT JOIN messages rm ON m.reply_to = rm.id
          LEFT JOIN users ru ON rm.sender_id = ru.id
          WHERE m.id = ?
        `, [insertedMessageId], (err, rows) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
            return sendResponseAndEvents({
              id: insertedMessageId,
              sender_id: sender_id,
              receiver_id,
              message,
              reply_to,
              media_type,
              media_url,
              duration: duration || null,
              caption: caption || null,
              created_at: new Date()
            });
          }

          const enrichedMessage = rows && rows[0] ? rows[0] : {
            id: insertedMessageId,
            sender_id: sender_id,
            receiver_id,
            message,
            reply_to,
            media_type,
            media_url,
            duration: duration || null,
            caption: caption || null,
            created_at: new Date()
          };

          sendResponseAndEvents(enrichedMessage);
        });
      }
    );
  });

  // –£–¥–∞–ª–∏—Ç—å –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  app.delete('/api/messages/:messageId', authenticateToken, (req, res) => {
    const { messageId } = req.params;
    
    db.query(
      'SELECT sender_id, receiver_id FROM messages WHERE id = ?',
      [messageId],
      (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        if (results.length === 0) return res.status(404).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
        
        const message = results[0];
        if (message.sender_id !== req.user.id) {
          return res.status(403).json({ error: '–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è' });
        }
        
        db.query(
          'DELETE FROM messages WHERE id = ?',
          [messageId],
          (err, result) => {
            if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ –≤ –∫–æ–º–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            io.to(`user_${message.sender_id}`).emit('message_deleted', { messageId });
            io.to(`user_${message.receiver_id}`).emit('message_deleted', { messageId });
            
            console.log(`‚úÖ Message delete notification sent to user_${message.sender_id} and user_${message.receiver_id}`);
            
            res.json({ success: true, message: '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ' });
          }
        );
      }
    );
  });

  // –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  app.delete('/api/groups/messages/:messageId', authenticateToken, (req, res) => {
    const { messageId } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    db.query(
      'SELECT sender_id, group_id FROM group_messages WHERE id = ?',
      [messageId],
      (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        if (results.length === 0) return res.status(404).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
        
        const message = results[0];
        if (message.sender_id !== req.user.id) {
          return res.status(403).json({ error: '–ù–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è' });
        }
        
        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        db.query(
          'DELETE FROM group_messages WHERE id = ?',
          [messageId],
          (err, result) => {
            if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –≤ –∫–æ–º–Ω–∞—Ç—É –≥—Ä—É–ø–ø—ã
            io.to(`group_${message.group_id}`).emit('group_message_deleted', { messageId });
            
            console.log(`‚úÖ Group message delete notification sent to group_${message.group_id}`);
            
            res.json({ success: true, message: '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ' });
          }
        );
      }
    );
  });

  // ========== –≠–ù–î–ü–û–ò–ù–¢–´ –î–õ–Ø –û–ß–ò–°–¢–ö–ò –ò –£–î–ê–õ–ï–ù–ò–Ø –ß–ê–¢–ê ==========

  // –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç (—É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
  app.post('/api/messages/clear-chat/:userId', authenticateToken, (req, res) => {
    const { userId } = req.params;
    const currentUserId = req.user.id;
    
    if (!userId || isNaN(parseInt(userId))) {
      return res.status(400).json({ error: 'userId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' });
    }
    
    const parsedUserId = parseInt(userId);
    
    if (parsedUserId === currentUserId) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π' });
    }
    
    // –®–∞–≥ 1: –û–±–Ω—É–ª–∏—Ç—å reply_to –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
    db.query(`
      UPDATE messages SET reply_to = NULL
      WHERE (sender_id = ? AND receiver_id = ?) 
        OR (sender_id = ? AND receiver_id = ?)
    `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err) => {
      if (err) {
        console.error('‚ö†Ô∏è Error clearing reply_to:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
      db.query(`
        SELECT id FROM messages 
        WHERE (sender_id = ? AND receiver_id = ?) 
          OR (sender_id = ? AND receiver_id = ?)
      `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err, messages) => {
        if (err) {
          console.error('‚ùå Error fetching messages:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const messageIds = messages.map(m => m.id);
        
        // –®–∞–≥ 2: –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (messageIds.length > 0) {
          db.query(`DELETE FROM pinned_messages WHERE message_id IN (${messageIds.join(',')})`, (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting pinned messages:', err);
            deleteReadStatus();
          });
        } else {
          deleteReadStatus();
        }
        
        function deleteReadStatus() {
          // –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
          db.query(`
            DELETE FROM message_read_status 
            WHERE message_id IN (
              SELECT id FROM messages 
              WHERE (sender_id = ? AND receiver_id = ?) 
                OR (sender_id = ? AND receiver_id = ?)
            )
          `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting read status:', err);
            deleteMessages();
          });
        }
        
        function deleteMessages() {
          // –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
          db.query(`
            DELETE FROM messages 
            WHERE (sender_id = ? AND receiver_id = ?) 
              OR (sender_id = ? AND receiver_id = ?)
          `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err, result) => {
            if (err) {
              console.error('‚ùå Error deleting messages:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ Chat cleared between users ${currentUserId} and ${parsedUserId}. Deleted ${result.affectedRows} messages.`);
            
            // üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Socket.IO —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞ –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            const chatClearedData = {
              initiatorId: currentUserId,
              otherUserId: parsedUserId,
              timestamp: new Date().toISOString()
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            io.to(`user_${currentUserId}`).emit('chat_cleared', chatClearedData);
            io.to(`user_${parsedUserId}`).emit('chat_cleared', chatClearedData);
            
            console.log(`üì° Socket.IO: chat_cleared –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º ${currentUserId} –∏ ${parsedUserId}`);
            
            res.json({ 
              success: true, 
              message: '–ß–∞—Ç –æ—á–∏—â–µ–Ω',
              deletedCount: result.affectedRows
            });
          });
        }
      });
    });
  });

  // –£–¥–∞–ª–∏—Ç—å —á–∞—Ç (—Å–∏–Ω–æ–Ω–∏–º –¥–ª—è –æ—á–∏—Å—Ç–∫–∏, –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —É–¥–∞–ª–µ–Ω–∏–µ)
  app.post('/api/messages/delete-chat/:userId', authenticateToken, (req, res) => {
    const { userId } = req.params;
    const currentUserId = req.user.id;
    
    if (!userId || isNaN(parseInt(userId))) {
      return res.status(400).json({ error: 'userId –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º' });
    }
    
    const parsedUserId = parseInt(userId);
    
    if (parsedUserId === currentUserId) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —á–∞—Ç —Å —Å–∞–º–∏–º —Å–æ–±–æ–π' });
    }
    
    // –®–∞–≥ 1: –û–±–Ω—É–ª–∏—Ç—å reply_to –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
    db.query(`
      UPDATE messages SET reply_to = NULL
      WHERE (sender_id = ? AND receiver_id = ?) 
        OR (sender_id = ? AND receiver_id = ?)
    `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err) => {
      if (err) {
        console.error('‚ö†Ô∏è Error clearing reply_to:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
      db.query(`
        SELECT id FROM messages 
        WHERE (sender_id = ? AND receiver_id = ?) 
          OR (sender_id = ? AND receiver_id = ?)
      `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err, messages) => {
        if (err) {
          console.error('‚ùå Error fetching messages:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const messageIds = messages.map(m => m.id);
        
        // –®–∞–≥ 2: –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (messageIds.length > 0) {
          db.query(`DELETE FROM pinned_messages WHERE message_id IN (${messageIds.join(',')})`, (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting pinned messages:', err);
            deleteReadStatus();
          });
        } else {
          deleteReadStatus();
        }
        
        function deleteReadStatus() {
          // –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
          db.query(`
            DELETE FROM message_read_status 
            WHERE message_id IN (
              SELECT id FROM messages 
              WHERE (sender_id = ? AND receiver_id = ?) 
                OR (sender_id = ? AND receiver_id = ?)
            )
          `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting read status:', err);
            deleteMessages();
          });
        }
        
        function deleteMessages() {
          // –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
          db.query(`
            DELETE FROM messages 
            WHERE (sender_id = ? AND receiver_id = ?) 
              OR (sender_id = ? AND receiver_id = ?)
          `, [currentUserId, parsedUserId, parsedUserId, currentUserId], (err, result) => {
            if (err) {
              console.error('‚ùå Error deleting messages:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ Chat deleted between users ${currentUserId} and ${parsedUserId}. Deleted ${result.affectedRows} messages.`);
            
            res.json({ 
              success: true, 
              message: '–ß–∞—Ç —É–¥–∞–ª–µ–Ω',
              deletedCount: result.affectedRows
            });
          });
        }
      });
    });
  });

  // WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/profile', authenticateToken, (req, res) => {
    db.query('SELECT id, username, email, avatar, bio, status, cardColor FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0) return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      res.json(results[0]);
    });
  });

  // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
  app.put('/api/profile', authenticateToken, (req, res) => {
    const { username, bio, status, avatar, cardColor } = req.body;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è username –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω
    if (username !== undefined && username !== null && username.length < 3) {
      return res.status(400).json({ error: '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞' });
    }
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º SQL –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    const updates = [];
    const values = [];
    
    if (username !== undefined && username !== null) {
      updates.push('username = ?');
      values.push(username);
    }
    if (bio !== undefined) {
      updates.push('bio = ?');
      values.push(bio || null);
    }
    if (status !== undefined) {
      updates.push('status = ?');
      values.push(status || '–û–Ω–ª–∞–π–Ω');
    }
    if (avatar !== undefined) {
      updates.push('avatar = ?');
      values.push(avatar || null);
    }
    if (cardColor !== undefined) {
      updates.push('cardColor = ?');
      values.push(cardColor);
    }
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –±—ã–ª–æ –ø–µ—Ä–µ–¥–∞–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
    if (updates.length === 0) {
      return res.status(400).json({ error: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' });
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω–µ—Ü
    values.push(req.user.id);
    
    const query = `UPDATE users SET ${updates.join(', ')} WHERE id = ?`;
    
    console.log('üîß SQL Query:', query);
    console.log('üìä Values:', values);
    
    db.query(query, values, (err, result) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', err);
        if (err.code === 'ER_DUP_ENTRY') {
          return res.status(400).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' });
        }
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', details: err.message });
      }
      
      console.log(`‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${req.user.id} –æ–±–Ω–æ–≤–ª–µ–Ω`);
      if (cardColor) console.log(`   –¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏: ${cardColor}`);
      
      res.json({ 
        success: true,
        message: '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω' 
      });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/user/preferences', authenticateToken, (req, res) => {
    db.query(
      'SELECT chat_background FROM user_preferences WHERE user_id = ?',
      [req.user.id],
      (err, results) => {
        if (err) {
          console.error('Database error:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (results.length === 0) {
          return res.json({ chat_background: 'default' });
        }
        
        res.json({ chat_background: results[0].chat_background });
      }
    );
  });

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.post('/api/user/preferences', authenticateToken, (req, res) => {
    const { chat_background } = req.body;
    
    if (!chat_background) {
      return res.status(400).json({ error: 'chat_background –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }
    
    db.query(
      `INSERT INTO user_preferences (user_id, chat_background) 
      VALUES (?, ?)
      ON DUPLICATE KEY UPDATE 
        chat_background = ?,
        updated_at = CURRENT_TIMESTAMP`,
      [req.user.id, chat_background, chat_background],
      (err) => {
        if (err) {
          console.error('Database error:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        res.json({ 
          success: true, 
          message: '–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã',
          chat_background 
        });
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ—Å—Ç—ã
  app.get('/api/posts', authenticateToken, (req, res) => {
    db.query(`
      SELECT p.*, u.username, u.avatar,
            COUNT(DISTINCT l.id) as likes_count,
            COUNT(DISTINCT c.id) as comments_count,
            EXISTS(SELECT 1 FROM likes WHERE user_id = ? AND post_id = p.id) as is_liked,
            CASE WHEN p.user_id = ? THEN true ELSE false END as is_owner,
            p.created_at,
            p.updated_at
      FROM posts p
      JOIN users u ON p.user_id = u.id
      LEFT JOIN likes l ON p.id = l.post_id
      LEFT JOIN comments c ON p.id = c.post_id
      GROUP BY p.id
      ORDER BY p.created_at DESC
    `, [req.user.id, req.user.id], async (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      
      // ‚ú® –ü–†–ò–ú–ï–ù–Ø–ï–ú –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Æ
      const transformedPosts = transformPostsData(results || []);
      
      // ‚ú® –ù–û–í–û–ï: –ü–æ–ª—É—á–∞–µ–º —Ö–µ—à—Ç–µ–≥–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞
      const postsWithHashtags = await Promise.all(
        transformedPosts.map(post => {
          return new Promise((resolve) => {
            db.query(`
              SELECT h.id, h.name
              FROM hashtags h
              JOIN post_hashtags ph ON h.id = ph.hashtag_id
              WHERE ph.post_id = ?
            `, [post.id], (err, hashtags) => {
              post.hashtags = hashtags || [];
              resolve(post);
            });
          });
        })
      );
      
      res.json(postsWithHashtags);
    });
  });

  // –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç - –û–ë–ù–û–í–õ–ï–ù–û (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
  app.post('/api/posts', authenticateToken, (req, res) => {
    const { content, image, images } = req.body;
    
    console.log('\n' + '='.repeat(70));
    console.log('üì§ –°–û–ó–î–ê–ù–ò–ï –ü–û–°–¢–ê');
    console.log('   –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:', content ? content.substring(0, 50) + '...' : '–ø—É—Å—Ç–æ');
    console.log('   –û–¥–∏–Ω–æ—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:', !!image);
    console.log('   –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', Array.isArray(images) ? `${images.length} —à—Ç` : '–Ω–µ—Ç');
    console.log('='.repeat(70));
    
    if (!content || content.trim().length === 0) {
      return res.status(400).json({ error: '–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–∞–∫ JSON —Å—Ç—Ä–æ–∫—É
    const imagesJson = Array.isArray(images) && images.length > 0 
      ? JSON.stringify(images) 
      : null;
    
    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –≤ –ë–î:');
    console.log('   image (–ø–µ—Ä–≤–æ–µ):', image ? image.substring(0, 40) + '...' : 'null');
    console.log('   images (–º–∞—Å—Å–∏–≤):', imagesJson ? `JSON —Å ${images.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏` : 'null');
    
    db.query(
      'INSERT INTO posts (user_id, content, image, images) VALUES (?, ?, ?, ?)',
      [req.user.id, content, image || null, imagesJson],
      (err, result) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const postId = result.insertId;
        console.log(`‚úÖ –ü–æ—Å—Ç ${postId} —Å–æ–∑–¥–∞–Ω`);
        console.log('='.repeat(70) + '\n');
        
        // ‚ú® –¢–†–ê–ù–°–§–û–†–ú–ò–†–£–ï–ú: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        const transformedImages = Array.isArray(images) ? images : (image ? [image] : []);
        
        res.json({ 
          id: postId, 
          message: '–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω',
          images: transformedImages
        });
      }
    );
  });

  // ========== HASHTAG ENDPOINTS ==========

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ö–µ—à—Ç–µ–≥–∏
  app.get('/api/hashtags', authenticateToken, (req, res) => {
    db.query(`
      SELECT 
        h.id,
        h.name,
        COUNT(ph.post_id) as post_count,
        h.created_at
      FROM hashtags h
      LEFT JOIN post_hashtags ph ON h.id = ph.hashtag_id
      GROUP BY h.id, h.name, h.created_at
      ORDER BY post_count DESC, h.created_at DESC
      LIMIT 100
    `, (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      res.json({ success: true, data: results });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ö–µ—à—Ç–µ–≥–∏
  app.get('/api/hashtags/trending', authenticateToken, (req, res) => {
    const limit = req.query.limit ? parseInt(req.query.limit) : 10;
    
    db.query(`
      SELECT 
        h.id,
        h.name,
        COUNT(ph.post_id) as post_count
      FROM hashtags h
      LEFT JOIN post_hashtags ph ON h.id = ph.hashtag_id
      GROUP BY h.id, h.name
      ORDER BY post_count DESC
      LIMIT ?
    `, [limit], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      res.json({ success: true, data: results });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å—Ç—ã –ø–æ —Ö–µ—à—Ç–µ–≥—É
  app.get('/api/hashtags/:hashtag/posts', authenticateToken, (req, res) => {
    const { hashtag } = req.params;
    const limit = req.query.limit ? parseInt(req.query.limit) : 20;
    const offset = req.query.offset ? parseInt(req.query.offset) : 0;
    
    const hashtagName = hashtag.startsWith('#') ? hashtag.toLowerCase() : '#' + hashtag.toLowerCase();
    
    db.query(`
      SELECT 
        p.id,
        p.content,
        p.image,
        p.user_id,
        u.username as author_name,
        u.avatar,
        COUNT(DISTINCT l.id) as likes_count,
        COUNT(DISTINCT c.id) as comments_count,
        EXISTS(SELECT 1 FROM likes WHERE user_id = ? AND post_id = p.id) as is_liked,
        p.created_at,
        p.updated_at
      FROM posts p
      JOIN users u ON p.user_id = u.id
      LEFT JOIN likes l ON p.id = l.post_id
      LEFT JOIN comments c ON p.id = c.post_id
      WHERE p.id IN (
        SELECT ph.post_id 
        FROM post_hashtags ph
        JOIN hashtags h ON ph.hashtag_id = h.id
        WHERE h.name = ?
      )
      GROUP BY p.id
      ORDER BY p.created_at DESC
      LIMIT ? OFFSET ?
    `, [req.user.id, hashtagName, limit, offset], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤
      db.query(`
        SELECT COUNT(DISTINCT ph.post_id) as total
        FROM post_hashtags ph
        JOIN hashtags h ON ph.hashtag_id = h.id
        WHERE h.name = ?
      `, [hashtagName], (err, countResults) => {
        if (err) console.error('Error getting count:', err);
        
        const total = countResults && countResults.length > 0 ? countResults[0].total : 0;
        
        res.json({
          success: true,
          data: results,
          total: total,
          limit: limit,
          offset: offset
        });
      });
    });
  });

  // –£–¥–∞–ª–∏—Ç—å —Ö–µ—à—Ç–µ–≥ (ADMIN)
  app.delete('/api/admin/hashtags/:hashtagId', authenticateToken, (req, res) => {
    const { hashtagId } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      // –£–¥–∞–ª—è–µ–º —Ö–µ—à—Ç–µ–≥ (cascade —É–¥–∞–ª–∏—Ç post_hashtags)
      db.query('DELETE FROM hashtags WHERE id = ?', [hashtagId], (err, result) => {
        if (err) {
          console.error('Error deleting hashtag:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (result.affectedRows === 0) {
          return res.status(404).json({ error: '–•–µ—à—Ç–µ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
        }
        
        res.json({ success: true, message: '–•–µ—à—Ç–µ–≥ —É–¥–∞–ª–µ–Ω' });
      });
    });
  });

  // –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –∞–¥–º–∏–Ω–∞) - –ù–û–í–´–ô –≠–ù–î–ü–û–ò–ù–¢
  app.delete('/api/admin/users/:userId', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–¥–º–∏–Ω –Ω–µ —É–¥–∞–ª—è–µ—Ç —Å–∞–º —Å–µ–±—è
      if (parseInt(userId) === req.user.id) {
        return res.status(400).json({ error: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è' });
      }
      
      // –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –º–µ–¥–∏–∞
      db.query('SELECT id FROM posts WHERE user_id = ?', [userId], (err, posts) => {
        if (err) {
          console.error('‚ùå Error fetching user posts:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const postIds = posts.map(p => p.id);
        
        // –®–∞–≥ 2: –£–¥–∞–ª—è–µ–º –ª–∞–π–∫–∏ –ø–æ—Å—Ç–æ–≤
        if (postIds.length > 0) {
          db.query(`DELETE FROM likes WHERE post_id IN (${postIds.join(',')})`, (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting likes:', err);
            deleteComments();
          });
        } else {
          deleteComments();
        }
        
        function deleteComments() {
          // –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ—Å—Ç–æ–≤
          if (postIds.length > 0) {
            db.query(`DELETE FROM comments WHERE post_id IN (${postIds.join(',')})`, (err) => {
              if (err) console.error('‚ö†Ô∏è Error deleting comments:', err);
              deletePostHashtags();
            });
          } else {
            deletePostHashtags();
          }
        }
        
        function deletePostHashtags() {
          // –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∏ —Ö–µ—à—Ç–µ–≥–æ–≤ —Å –ø–æ—Å—Ç–∞–º–∏
          if (postIds.length > 0) {
            db.query(`DELETE FROM post_hashtags WHERE post_id IN (${postIds.join(',')})`, (err) => {
              if (err) console.error('‚ö†Ô∏è Error deleting post hashtags:', err);
              deletePosts();
            });
          } else {
            deletePosts();
          }
        }
        
        function deletePosts() {
          // –®–∞–≥ 5: –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query('DELETE FROM posts WHERE user_id = ?', [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting posts:', err);
            deleteMessages();
          });
        }
        
        function deleteMessages() {
          // –®–∞–≥ 6: –£–¥–∞–ª—è–µ–º –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ)
          db.query(`
            SELECT id FROM messages 
            WHERE sender_id = ? OR receiver_id = ?
          `, [userId, userId], (err, messages) => {
            if (err) console.error('‚ö†Ô∏è Error fetching messages:', err);
            
            const messageIds = messages ? messages.map(m => m.id) : [];
            
            if (messageIds.length > 0) {
              db.query(`DELETE FROM message_read_status WHERE message_id IN (${messageIds.join(',')})`, (err) => {
                if (err) console.error('‚ö†Ô∏è Error deleting message read status:', err);
                deleteMessagesPinned();
              });
            } else {
              deleteMessagesPinned();
            }
          });
        }
        
        function deleteMessagesPinned() {
          // –®–∞–≥ 7: –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query('DELETE FROM pinned_messages WHERE user_id = ?', [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting pinned messages:', err);
            deleteMessages2();
          });
        }
        
        function deleteMessages2() {
          // –®–∞–≥ 8: –£–¥–∞–ª—è–µ–º –≤—Å–µ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          db.query('DELETE FROM messages WHERE sender_id = ? OR receiver_id = ?', [userId, userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting messages:', err);
            deleteGroupMessages();
          });
        }
        
        function deleteGroupMessages() {
          // –®–∞–≥ 9: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query(`
            SELECT id FROM group_messages WHERE sender_id = ?
          `, [userId], (err, groupMessages) => {
            if (err) console.error('‚ö†Ô∏è Error fetching group messages:', err);
            
            const groupMessageIds = groupMessages ? groupMessages.map(m => m.id) : [];
            
            if (groupMessageIds.length > 0) {
              db.query(`DELETE FROM group_message_read_status WHERE message_id IN (${groupMessageIds.join(',')})`, (err) => {
                if (err) console.error('‚ö†Ô∏è Error deleting group message read status:', err);
                deletePinnedGroupMessages();
              });
            } else {
              deletePinnedGroupMessages();
            }
          });
        }
        
        function deletePinnedGroupMessages() {
          // –®–∞–≥ 10: –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          // (–æ–Ω–∏ —Ö—Ä–∞–Ω—è—Ç message_id, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º —Å–∞–º–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
          db.query(`
            DELETE FROM pinned_messages 
            WHERE message_id IN (
              SELECT id FROM group_messages WHERE sender_id = ?
            )
          `, [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting pinned group messages:', err);
            deleteGroupMessages2();
          });
        }
        
        function deleteGroupMessages2() {
          // –®–∞–≥ 11: –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query('DELETE FROM group_messages WHERE sender_id = ?', [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting group messages:', err);
            deleteGroupMembers();
          });
        }
        
        function deleteGroupMembers() {
          // –®–∞–≥ 12: –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥—Ä—É–ø–ø
          db.query('DELETE FROM group_members WHERE user_id = ?', [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting from groups:', err);
            deleteFriends();
          });
        }
        
        function deleteFriends() {
          // –®–∞–≥ 13: –£–¥–∞–ª—è–µ–º –¥—Ä—É–∑–µ–π
          db.query('DELETE FROM friends WHERE user_id = ? OR friend_id = ?', [userId, userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting friends:', err);
            deletePushTokens();
          });
        }
        
        function deletePushTokens() {
          // –®–∞–≥ 14: –£–¥–∞–ª—è–µ–º push-—Ç–æ–∫–µ–Ω—ã
          db.query('DELETE FROM push_tokens WHERE user_id = ?', [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting push tokens:', err);
            deleteUserPreferences();
          });
        }
        
        function deleteUserPreferences() {
          // –®–∞–≥ 15: –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query('DELETE FROM user_preferences WHERE user_id = ?', [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting user preferences:', err);
            deleteCallsAndParticipants();
          });
        }
        
        function deleteCallsAndParticipants() {
          // –®–∞–≥ 16: –£–¥–∞–ª—è–µ–º –∑–≤–æ–Ω–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query(`
            SELECT id FROM calls 
            WHERE caller_id = ? OR receiver_id = ?
          `, [userId, userId], (err, calls) => {
            if (err) console.error('‚ö†Ô∏è Error fetching calls:', err);
            
            const callIds = calls ? calls.map(c => c.id) : [];
            
            if (callIds.length > 0) {
              db.query(`DELETE FROM call_participants WHERE call_id IN (${callIds.join(',')})`, (err) => {
                if (err) console.error('‚ö†Ô∏è Error deleting call participants:', err);
                deleteCalls();
              });
            } else {
              deleteCalls();
            }
          });
        }
        
        function deleteCalls() {
          // –®–∞–≥ 17: –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –∑–≤–æ–Ω–∫–æ–≤
          db.query('DELETE FROM calls WHERE caller_id = ? OR receiver_id = ?', [userId, userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting calls:', err);
            deletePinnedChats();
          });
        }
        
        function deletePinnedChats() {
          // –®–∞–≥ 18: –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —á–∞—Ç—ã
          db.query('DELETE FROM pinned_chats WHERE user_id = ?', [userId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting pinned chats:', err);
            deleteUser();
          });
        }
        
        function deleteUser() {
          // –®–∞–≥ 19: –£–¥–∞–ª—è–µ–º —Å–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          db.query('DELETE FROM users WHERE id = ?', [userId], (err, result) => {
            if (err) {
              console.error('‚ùå Error deleting user:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            if (result.affectedRows === 0) {
              return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
            }
            
            console.log(`üóëÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id}`);
            
            res.json({ 
              success: true, 
              message: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`
            });
          });
        }
      });
    });
  });

  // –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç (–¥–ª—è –∞–¥–º–∏–Ω–∞) - –ù–û–í–´–ô –≠–ù–î–ü–û–ò–ù–¢
  app.delete('/api/admin/posts/:postId', authenticateToken, (req, res) => {
    const { postId } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ—Å—Ç
      db.query('SELECT user_id FROM posts WHERE id = ?', [postId], (err, results) => {
        if (err) {
          console.error('‚ùå Error checking post:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (results.length === 0) {
          return res.status(404).json({ error: '–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
        }
        
        // –®–∞–≥ 1: –£–¥–∞–ª—è–µ–º –ª–∞–π–∫–∏
        db.query('DELETE FROM likes WHERE post_id = ?', [postId], (err) => {
          if (err) console.error('‚ö†Ô∏è Error deleting likes:', err);
          
          // –®–∞–≥ 2: –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
          db.query('DELETE FROM comments WHERE post_id = ?', [postId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error deleting comments:', err);
            
            // –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º —Ö–µ—à—Ç–µ–≥–∏
            db.query('DELETE FROM post_hashtags WHERE post_id = ?', [postId], (err) => {
              if (err) console.error('‚ö†Ô∏è Error deleting post hashtags:', err);
              
              // –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç
              db.query('DELETE FROM posts WHERE id = ?', [postId], (err, result) => {
                if (err) {
                  console.error('‚ùå Error deleting post:', err);
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                }
                
                console.log(`üóëÔ∏è –ü–æ—Å—Ç ${postId} —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id}`);
                
                res.json({ 
                  success: true, 
                  message: '–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω'
                });
              });
            });
          });
        });
      });
    });
  });

  // ========== –ö–û–ù–ï–¶ HASHTAG ENDPOINTS ==========;

  // GET /api/posts/authors/:authorId - –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ—Å—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–≤—Ç–æ—Ä–∞
  app.get('/api/posts/authors/:authorId', authenticateToken, (req, res) => {
    const { authorId } = req.params;
    const userId = req.user.id;
    
    if (!authorId) {
      return res.status(400).json({ error: 'authorId is required' });
    }
    
    const query = `
      SELECT 
        p.id,
        p.content,
        p.image,
        p.images,
        p.created_at,
        p.updated_at,
        p.user_id,
        u.username,
        u.avatar,
        (SELECT COUNT(*) FROM likes WHERE post_id = p.id) as likes_count,
        (SELECT COUNT(*) FROM comments WHERE post_id = p.id) as comments_count,
        CASE WHEN EXISTS(SELECT 1 FROM likes WHERE post_id = p.id AND user_id = ?) THEN true ELSE false END as is_liked,
        CASE WHEN EXISTS(SELECT 1 FROM bookmarks WHERE post_id = p.id AND user_id = ?) THEN true ELSE false END as is_bookmarked
      FROM posts p
      LEFT JOIN users u ON p.user_id = u.id
      WHERE p.user_id = ?
      ORDER BY p.created_at DESC
    `;
    
    db.query(query, [userId, userId, parseInt(authorId)], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤ –∞–≤—Ç–æ—Ä–∞:', err);
        return res.status(500).json({ error: err.message });
      }
      
      // ‚ú® –¢–†–ê–ù–°–§–û–†–ú–ò–†–£–ï–ú (–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º images –ø–æ–ª–µ)
      const transformedPosts = transformPostsData(results || []);
      
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${results.length} –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${authorId}`);
      res.json(transformedPosts);
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ—Å—Ç –ø–æ ID
  app.get('/api/posts/:id', authenticateToken, (req, res) => {
    const { id } = req.params;
    
    const query = `
      SELECT 
        p.id, 
        p.content, 
        p.image,
        p.images,
        p.user_id,
        u.username as author_name,
        u.avatar,
        (SELECT COUNT(*) FROM likes WHERE post_id = p.id) as likes_count,
        (SELECT COUNT(*) FROM comments WHERE post_id = p.id) as comments_count,
        CASE WHEN EXISTS(SELECT 1 FROM likes WHERE post_id = p.id AND user_id = ?) THEN true ELSE false END as is_liked,
        p.created_at,
        p.updated_at
      FROM posts p
      JOIN users u ON p.user_id = u.id
      WHERE p.id = ?
    `;
    
    db.query(query, [req.user.id, id], async (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      const post = results[0];
      
      // ‚ú® –¢–†–ê–ù–°–§–û–†–ú–ò–†–£–ï–ú
      const transformedPost = transformPostsData([post])[0];
      
      // ‚ú® –ù–û–í–û–ï: –ü–æ–ª—É—á–∞–µ–º —Ö–µ—à—Ç–µ–≥–∏ –ø–æ—Å—Ç–∞
      db.query(`
        SELECT h.id, h.name
        FROM hashtags h
        JOIN post_hashtags ph ON h.id = ph.hashtag_id
        WHERE ph.post_id = ?
      `, [id], (err, hashtags) => {
        transformedPost.hashtags = hashtags || [];
        res.json(transformedPost);
      });
    });
  });

  // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å—Ç (—Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä) - –û–ë–ù–û–í–õ–ï–ù–û (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
  app.put('/api/posts/:id', authenticateToken, (req, res) => {
    const { id } = req.params;
    const { content, image, images } = req.body;
    
    if (!content && !image && !images) {
      return res.status(400).json({ error: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º
    const checkQuery = 'SELECT user_id FROM posts WHERE id = ?';
    
    db.query(checkQuery, [id], async (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∞:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      if (results[0].user_id !== req.user.id) {
        return res.status(403).json({ error: '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–æ–π –ø–æ—Å—Ç' });
      }
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      const imagesJson = Array.isArray(images) && images.length > 0 
        ? JSON.stringify(images) 
        : null;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å—Ç
      const updateQuery = 'UPDATE posts SET content = ?, image = ?, images = ?, updated_at = NOW() WHERE id = ?';
      
      db.query(updateQuery, [content || null, image || null, imagesJson, id], async (err) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞' });
        }
        
        // ‚ú® –ù–û–í–û–ï: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ö–µ—à—Ç–µ–≥–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ
        db.query('DELETE FROM post_hashtags WHERE post_id = ?', [id], async (err) => {
          if (err) console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤:', err);
          
          try {
            await extractAndSaveHashtags(content, id);
          } catch (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ö–µ—à—Ç–µ–≥–æ–≤:', err);
          }
          
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Å—Ç
          const getQuery = `
            SELECT 
              p.id, 
              p.content, 
              p.image,
              p.images,
              p.user_id,
              u.username as author_name,
              u.avatar,
              (SELECT COUNT(*) FROM likes WHERE post_id = p.id) as likes_count,
              (SELECT COUNT(*) FROM comments WHERE post_id = p.id) as comments_count,
              CASE WHEN EXISTS(SELECT 1 FROM likes WHERE post_id = p.id AND user_id = ?) THEN true ELSE false END as is_liked,
              p.created_at,
              p.updated_at
            FROM posts p
            JOIN users u ON p.user_id = u.id
            WHERE p.id = ?
          `;
          
          db.query(getQuery, [req.user.id, id], (err, results) => {
            if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞' });
            
            const post = results[0];
            const transformedPost = transformPostsData([post])[0];
            
            db.query(`
              SELECT h.id, h.name
              FROM hashtags h
              JOIN post_hashtags ph ON h.id = ph.hashtag_id
              WHERE ph.post_id = ?
            `, [id], (err, hashtags) => {
              transformedPost.hashtags = hashtags || [];
              res.json(transformedPost);
            });
          });
        });
      });
    });
  });

  // –£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç (—Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä)
  app.delete('/api/posts/:id', authenticateToken, (req, res) => {
    const { id } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º
    const checkQuery = 'SELECT user_id FROM posts WHERE id = ?';
    
    db.query(checkQuery, [id], (err, results) => {
      if (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∞:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      if (results[0].user_id !== req.user.id) {
        return res.status(403).json({ error: '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —á—É–∂–æ–π –ø–æ—Å—Ç' });
      }
      
      // –£–¥–∞–ª—è–µ–º –ª–∞–π–∫–∏
      db.query('DELETE FROM likes WHERE post_id = ?', [id], (err) => {
        if (err) console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ª–∞–π–∫–æ–≤:', err);
        
        // –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        db.query('DELETE FROM comments WHERE post_id = ?', [id], (err) => {
          if (err) console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', err);
          
          // –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç
          db.query('DELETE FROM posts WHERE id = ?', [id], (err) => {
            if (err) {
              console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞' });
            }
            
            res.json({ success: true, message: '–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω' });
          });
        });
      });
    });
  });

  // –õ–∞–π–∫–Ω—É—Ç—å/—É–±—Ä–∞—Ç—å –ª–∞–π–∫
  app.post('/api/posts/:postId/like', authenticateToken, (req, res) => {
    const { postId } = req.params;
    
    console.log(`[DEBUG] Like endpoint - postId: ${postId}, userId: ${req.user.id}`);
    
    db.query('SELECT * FROM likes WHERE user_id = ? AND post_id = ?', [req.user.id, postId], (err, results) => {
      if (err) {
        console.error('Database error in like endpoint:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length > 0) {
        // –£–±—Ä–∞—Ç—å –ª–∞–π–∫
        db.query('DELETE FROM likes WHERE user_id = ? AND post_id = ?', [req.user.id, postId], (err) => {
          if (err) {
            console.error('Error removing like:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          res.json({ liked: false, message: '–õ–∞–π–∫ —É–±—Ä–∞–Ω' });
        });
      } else {
        // –ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫
        db.query('INSERT INTO likes (user_id, post_id) VALUES (?, ?)', [req.user.id, postId], (err) => {
          if (err) {
            console.error('Error adding like:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          res.json({ liked: true, message: '–õ–∞–π–∫ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω' });
        });
      }
    });
  });

  // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  app.post('/api/posts/:postId/comments', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const { comment } = req.body;
    
    if (!comment || comment.trim().length === 0) {
      return res.status(400).json({ error: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' });
    }
    
    db.query(
      'INSERT INTO comments (user_id, post_id, comment) VALUES (?, ?, ?)',
      [req.user.id, postId, comment],
      (err, result) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json({ id: result.insertId, message: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω' });
      }
    );
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç—É
  app.get('/api/posts/:postId/comments', authenticateToken, (req, res) => {
    const { postId } = req.params;
    
    db.query(`
      SELECT c.*, u.username, u.avatar
      FROM comments c
      JOIN users u ON c.user_id = u.id
      WHERE c.post_id = ?
      ORDER BY c.created_at ASC
    `, [postId], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      res.json(results);
    });
  });

  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä)
  app.put('/api/comments/:id', authenticateToken, (req, res) => {
    const { id } = req.params;
    const { comment } = req.body;
    
    if (!comment || !comment.trim()) {
      return res.status(400).json({ error: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º
    const checkQuery = 'SELECT user_id FROM comments WHERE id = ?';
    
    db.query(checkQuery, [id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞' });
      if (results.length === 0) return res.status(404).json({ error: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      if (results[0].user_id !== req.user.id) {
        return res.status(403).json({ error: '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' });
      }
      
      db.query('UPDATE comments SET comment = ?, updated_at = NOW() WHERE id = ?', 
        [comment.trim(), id], 
        (err) => {
          if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' });
          res.json({ success: true });
        }
      );
    });
  });

  // –£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä)
  app.delete('/api/comments/:id', authenticateToken, (req, res) => {
    const { id } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º
    const checkQuery = 'SELECT user_id FROM comments WHERE id = ?';
    
    db.query(checkQuery, [id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞' });
      if (results.length === 0) return res.status(404).json({ error: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      if (results[0].user_id !== req.user.id) {
        return res.status(403).json({ error: '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —á—É–∂–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' });
      }
      
      db.query('DELETE FROM comments WHERE id = ?', [id], (err) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è' });
        res.json({ success: true });
      });
    });
  });

  // ============================================
  // üìå API ENDPOINTS –î–õ–Ø –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô –ü–û–°–¢–û–í
  // ============================================

  // üîß –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
  function updateUserInterests(userId, postId) {
    db.query(
      `SELECT hashtag_id FROM post_hashtags WHERE post_id = ?`,
      [postId],
      (err, hashtags) => {
        if (err || !hashtags) return;

        hashtags.forEach(({ hashtag_id }) => {
          db.query(
            `INSERT INTO user_interests (user_id, hashtag_id, interest_score) VALUES (?, ?, 1.0)
            ON DUPLICATE KEY UPDATE interest_score = interest_score + 0.5`,
            [userId, hashtag_id]
          );
        });

        db.query(
          'UPDATE users SET interests_updated_at = NOW() WHERE id = ?',
          [userId]
        );
      }
    );
  }

  function trackPostView(userId, postId) {
    db.query(
      `INSERT INTO post_views (post_id, user_id) VALUES (?, ?)
      ON DUPLICATE KEY UPDATE viewed_at = NOW()`,
      [postId, userId],
      (err) => {
        if (!err) {
          db.query(
            `UPDATE posts SET views_count = (SELECT COUNT(*) FROM post_views WHERE post_id = ?) WHERE id = ?`,
            [postId, postId]
          );
          updateUserInterests(userId, postId);
        }
      }
    );
  }

  // 1Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ü–û–°–¢–´ –° –°–û–†–¢–ò–†–û–í–ö–û–ô –ò –§–ò–õ–¨–¢–†–ê–¶–ò–ï–ô
  app.get('/api/posts/feed', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const { 
      sort = 'newest',
      filter = 'all',
      search = '',
      author_id = null,
      page = 1,
      limit = 20
    } = req.query;

    const offset = (parseInt(page) - 1) * parseInt(limit);
    let whereConditions = [];
    let params = [];

    if (filter === 'friends') {
      whereConditions.push(`p.user_id IN (
        SELECT CASE 
          WHEN f.user_id = ? THEN f.friend_id 
          ELSE f.user_id 
        END
        FROM friends f 
        WHERE (f.user_id = ? OR f.friend_id = ?) AND f.status = 'accepted'
      )`);
      params.push(userId, userId, userId);
    } else if (author_id) {
      whereConditions.push('p.user_id = ?');
      params.push(parseInt(author_id));
    }

    if (search && search.trim()) {
      const searchTerm = `%${search.trim()}%`;
      whereConditions.push(`(
        p.content LIKE ? OR 
        u.username LIKE ?
      )`);
      params.push(searchTerm, searchTerm);
    }

    let query = `
      SELECT 
        p.*,
        u.username,
        u.avatar,
        (SELECT COUNT(*) FROM likes WHERE post_id = p.id) as likes_count,
        (SELECT COUNT(*) FROM comments WHERE post_id = p.id) as comments_count,
        (SELECT COUNT(*) FROM post_views WHERE post_id = p.id) as views_count,
        EXISTS(SELECT 1 FROM likes WHERE user_id = ? AND post_id = p.id) as is_liked,
        EXISTS(SELECT 1 FROM bookmarks WHERE user_id = ? AND post_id = p.id) as is_bookmarked,
        CASE WHEN p.user_id = ? THEN true ELSE false END as is_owner
      FROM posts p
      JOIN users u ON p.user_id = u.id
    `;

    params.unshift(userId, userId, userId);

    if (whereConditions.length > 0) {
      query += ' WHERE ' + whereConditions.join(' AND ');
    }

    if (sort === 'popular') {
      query += ` ORDER BY (SELECT COUNT(*) FROM likes WHERE post_id = p.id) DESC, p.created_at DESC`;
    } else {
      query += ` ORDER BY p.created_at DESC`;
    }

    query += ` LIMIT ? OFFSET ?`;
    params.push(parseInt(limit), offset);

    db.query(query, params, (err, posts) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      // ‚ú® –¢–†–ê–ù–°–§–û–†–ú–ò–†–£–ï–ú
      const transformedPosts = transformPostsData(posts || []);

      let countQuery = `SELECT COUNT(*) as total FROM posts p JOIN users u ON p.user_id = u.id`;
      if (whereConditions.length > 0) {
        countQuery += ' WHERE ' + whereConditions.join(' AND ');
      }

      db.query(countQuery, params.slice(0, params.length - 2), (err, countResult) => {
        const total = countResult?.[0]?.total || 0;

        res.json({
          success: true,
          data: transformedPosts,
          pagination: {
            total,
            page: parseInt(page),
            limit: parseInt(limit),
            pages: Math.ceil(total / parseInt(limit))
          }
        });
      });
    });
  });

  // 2Ô∏è‚É£ –ü–û–ò–°–ö –ü–û–°–¢–û–í
  app.get('/api/posts/search', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const { q = '', limit = 20 } = req.query;

    if (!q || q.trim().length < 2) {
      return res.status(400).json({ error: '–ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞' });
    }

    const searchTerm = `%${q.trim()}%`;
    let query = `
      SELECT DISTINCT
        p.*,
        u.username,
        u.avatar,
        EXISTS(SELECT 1 FROM likes WHERE user_id = ? AND post_id = p.id) as is_liked,
        EXISTS(SELECT 1 FROM bookmarks WHERE user_id = ? AND post_id = p.id) as is_bookmarked
      FROM posts p
      JOIN users u ON p.user_id = u.id
      WHERE 
        p.content LIKE ? OR
        u.username LIKE ?
      ORDER BY p.created_at DESC
      LIMIT ?
    `;

    db.query(query, [userId, userId, searchTerm, searchTerm, parseInt(limit)], 
      (err, results) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        // ‚ú® –¢–†–ê–ù–°–§–û–†–ú–ò–†–£–ï–ú
        const transformedResults = transformPostsData(results || []);

        res.json({
          success: true,
          query: q,
          results: transformedResults,
          count: transformedResults?.length || 0
        });
      }
    );
  });

  // 3Ô∏è‚É£ –ó–ê–ö–õ–ê–î–ö–ò (–°–û–•–†–ê–ù–ï–ù–ò–ï –ü–û–°–¢–û–í)
  app.post('/api/posts/:postId/bookmark', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const userId = req.user.id;

    db.query(
      'INSERT INTO bookmarks (user_id, post_id) VALUES (?, ?)',
      [userId, postId],
      (err, result) => {
        if (err) {
          if (err.code === 'ER_DUP_ENTRY') {
            return res.status(400).json({ error: '–ü–æ—Å—Ç —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–∫–ª–∞–¥–∫–∏' });
          }
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        updateUserInterests(userId, postId);
        console.log(`‚úÖ –ü–æ—Å—Ç ${postId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–∫–ª–∞–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
        res.json({ success: true, message: '–ü–æ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–∫–ª–∞–¥–∫–∏' });
      }
    );
  });

  app.delete('/api/posts/:postId/bookmark', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const userId = req.user.id;

    db.query(
      'DELETE FROM bookmarks WHERE user_id = ? AND post_id = ?',
      [userId, postId],
      (err) => {
        if (err) {
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        console.log(`‚úÖ –ü–æ—Å—Ç ${postId} —É–¥–∞–ª–µ–Ω –∏–∑ –∑–∞–∫–ª–∞–¥–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
        res.json({ success: true, message: '–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∑–∞–∫–ª–∞–¥–æ–∫' });
      }
    );
  });

  app.get('/api/posts/bookmarks/my', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const { page = 1, limit = 20 } = req.query;
    const offset = (parseInt(page) - 1) * parseInt(limit);

    const query = `
      SELECT 
        p.*,
        u.username,
        u.avatar,
        (SELECT COUNT(*) FROM likes WHERE post_id = p.id) as likes_count,
        (SELECT COUNT(*) FROM comments WHERE post_id = p.id) as comments_count,
        EXISTS(SELECT 1 FROM likes WHERE user_id = ? AND post_id = p.id) as is_liked,
        EXISTS(SELECT 1 FROM bookmarks WHERE user_id = ? AND post_id = p.id) as is_bookmarked,
        b.bookmarked_at
      FROM bookmarks b
      JOIN posts p ON b.post_id = p.id
      JOIN users u ON p.user_id = u.id
      WHERE b.user_id = ?
      ORDER BY b.bookmarked_at DESC
      LIMIT ? OFFSET ?
    `;

    db.query(query, [userId, userId, userId, parseInt(limit), offset], (err, bookmarks) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–∫–ª–∞–¥–æ–∫:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      // ‚ú® –¢–†–ê–ù–°–§–û–†–ú–ò–†–£–ï–ú
      const transformedBookmarks = transformPostsData(bookmarks || []);

      db.query(
        'SELECT COUNT(*) as total FROM bookmarks WHERE user_id = ?',
        [userId],
        (err, countResult) => {
          const total = countResult?.[0]?.total || 0;

          res.json({
            success: true,
            data: transformedBookmarks,
            pagination: {
              total,
              page: parseInt(page),
              limit: parseInt(limit),
              pages: Math.ceil(total / parseInt(limit))
            }
          });
        }
      );
    });
  });

  // 4Ô∏è‚É£ –§–ò–õ–¨–¢–† –ü–û –ê–í–¢–û–†–ê–ú (–î–†–£–ó–¨–Ø)
  app.get('/api/posts/authors/friends', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const { page = 1, limit = 20 } = req.query;
    const offset = (parseInt(page) - 1) * parseInt(limit);

    const query = `
      SELECT 
        p.*,
        u.username,
        u.avatar,
        (SELECT COUNT(*) FROM likes WHERE post_id = p.id) as likes_count,
        (SELECT COUNT(*) FROM comments WHERE post_id = p.id) as comments_count,
        EXISTS(SELECT 1 FROM likes WHERE user_id = ? AND post_id = p.id) as is_liked,
        EXISTS(SELECT 1 FROM bookmarks WHERE user_id = ? AND post_id = p.id) as is_bookmarked
      FROM posts p
      JOIN users u ON p.user_id = u.id
      WHERE p.user_id IN (
        SELECT CASE 
          WHEN f.user_id = ? THEN f.friend_id 
          ELSE f.user_id 
        END as friend_id
        FROM friends f 
        WHERE (f.user_id = ? OR f.friend_id = ?) 
        AND f.status = 'accepted'
      )
      ORDER BY p.created_at DESC
      LIMIT ? OFFSET ?
    `;

    db.query(query, [userId, userId, userId, userId, userId, parseInt(limit), offset], 
      (err, posts) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤ –¥—Ä—É–∑–µ–π:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        // ‚ú® –¢–†–ê–ù–°–§–û–†–ú–ò–†–£–ï–ú
        const transformedPosts = transformPostsData(posts || []);

        res.json({
          success: true,
          data: transformedPosts,
          filter: 'friends_only',
          count: transformedPosts.length
        });
      }
    );
  });

  // 5Ô∏è‚É£ –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –ü–†–û–°–ú–û–¢–†–û–í
  app.post('/api/posts/:postId/view', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const userId = req.user.id;

    trackPostView(userId, postId);
    res.json({ success: true, message: '–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω' });
  });

  // ========== ADMIN ENDPOINTS ==========

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
  app.get('/api/admin/check', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0) return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      res.json({ is_admin: results[0].is_admin || false });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø—ã (–¥–ª—è –∞–¥–º–∏–Ω–∞)
  app.get('/api/admin/groups', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      db.query(`
        SELECT g.*, COUNT(gm.user_id) as member_count, u.username as creator_name
        FROM groups g
        LEFT JOIN group_members gm ON g.id = gm.group_id
        LEFT JOIN users u ON g.created_by = u.id
        GROUP BY g.id
        ORDER BY g.created_at DESC
      `, (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json(results);
      });
    });
  });

  // –£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É (–¥–ª—è –∞–¥–º–∏–Ω–∞)
  app.delete('/api/admin/groups/:groupId', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) {
        console.error('‚ùå Admin check error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
      db.query('SELECT id FROM group_messages WHERE group_id = ?', [groupId], (err, messages) => {
        if (err) {
          console.error('‚ùå Error fetching group messages:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const messageIds = messages.map(m => m.id);
        
        // –®–∞–≥ 1: –û–±–Ω—É–ª–∏—Ç—å reply_to –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
        if (messageIds.length > 0) {
          db.query(`UPDATE group_messages SET reply_to = NULL WHERE group_id = ?`, [groupId], (err) => {
            if (err) console.error('‚ö†Ô∏è Error clearing reply_to:', err);
            continueGroupDeletion();
          });
        } else {
          continueGroupDeletion();
        }
        
        function continueGroupDeletion() {
          // –®–∞–≥ 2: –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
          if (messageIds.length > 0) {
            db.query(`DELETE FROM pinned_messages WHERE message_id IN (${messageIds.join(',')})`, (err) => {
              if (err) console.error('‚ö†Ô∏è Error deleting pinned messages:', err);
              deleteReadStatus();
            });
          } else {
            deleteReadStatus();
          }
        }
        
        function deleteReadStatus() {
          // –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≥—Ä—É–ø–ø—ã (–ø–æ message_id)
          if (messageIds.length > 0) {
            db.query(`DELETE FROM group_message_read_status WHERE message_id IN (${messageIds.join(',')})`, (err) => {
              if (err) console.error('‚ö†Ô∏è Error deleting read status:', err);
              deleteMembers();
            });
          } else {
            deleteMembers();
          }
        }
        
        function deleteMembers() {
          // –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º —á–ª–µ–Ω–æ–≤ –≥—Ä—É–ø–ø—ã
          db.query('DELETE FROM group_members WHERE group_id = ?', [groupId], (err) => {
            if (err) {
              console.error('‚ùå Error deleting group members:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            deleteMessages();
          });
        }
        
        function deleteMessages() {
          // –®–∞–≥ 5: –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã
          db.query('DELETE FROM group_messages WHERE group_id = ?', [groupId], (err) => {
            if (err) {
              console.error('‚ùå Error deleting group messages:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            deleteGroup();
          });
        }
        
        function deleteGroup() {
          // –®–∞–≥ 6: –£–¥–∞–ª—è–µ–º —Å–∞–º—É –≥—Ä—É–ø–ø—É
          db.query('DELETE FROM groups WHERE id = ?', [groupId], (err) => {
            if (err) {
              console.error('‚ùå Error deleting group:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            console.log(`‚úÖ Group ${groupId} deleted successfully`);
            res.json({ success: true, message: '–ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞' });
          });
        }
      });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã (–¥–ª—è –∞–¥–º–∏–Ω–∞)
  app.get('/api/admin/chats', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      db.query(`
        SELECT DISTINCT
          LEAST(m.sender_id, m.receiver_id) as user1_id,
          GREATEST(m.sender_id, m.receiver_id) as user2_id,
          MAX(m.created_at) as last_message_time,
          COUNT(m.id) as message_count
        FROM messages m
        GROUP BY user1_id, user2_id
        ORDER BY last_message_time DESC
      `, (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
        const chatsWithUsers = results.map(chat => {
          return new Promise((resolve, reject) => {
            db.query(`
              SELECT id, username, avatar FROM users WHERE id IN (?, ?)
            `, [chat.user1_id, chat.user2_id], (err, users) => {
              if (err) reject(err);
              resolve({
                user1: users.find(u => u.id === chat.user1_id),
                user2: users.find(u => u.id === chat.user2_id),
                message_count: chat.message_count,
                last_message_time: chat.last_message_time
              });
            });
          });
        });
        
        Promise.all(chatsWithUsers)
          .then(chats => res.json(chats))
          .catch(err => res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
      });
    });
  });

  // –£–¥–∞–ª–∏—Ç—å —á–∞—Ç (–¥–ª—è –∞–¥–º–∏–Ω–∞)
  app.delete('/api/admin/chats/:userId1/:userId2', authenticateToken, (req, res) => {
    const { userId1, userId2 } = req.params;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) {
        console.error('‚ùå Admin check error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      // –®–∞–≥ 1: –û–±–Ω—É–ª–∏—Ç—å reply_to –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å—Å—ã–ª–æ–∫
      db.query(`
        UPDATE messages SET reply_to = NULL
        WHERE (sender_id = ? AND receiver_id = ?) 
          OR (sender_id = ? AND receiver_id = ?)
      `, [userId1, userId2, userId2, userId1], (err) => {
        if (err) console.error('‚ö†Ô∏è Error clearing reply_to:', err);
        fetchAndDelete();
      });
      
      function fetchAndDelete() {
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        db.query(`
          SELECT id FROM messages 
          WHERE (sender_id = ? AND receiver_id = ?) 
            OR (sender_id = ? AND receiver_id = ?)
        `, [userId1, userId2, userId2, userId1], (err, messages) => {
          if (err) {
            console.error('‚ùå Error fetching messages:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          const messageIds = messages.map(m => m.id);
          
          // –®–∞–≥ 2: –£–¥–∞–ª—è–µ–º –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          if (messageIds.length > 0) {
            db.query(`DELETE FROM pinned_messages WHERE message_id IN (${messageIds.join(',')})`, (err) => {
              if (err) console.error('‚ö†Ô∏è Error deleting pinned messages:', err);
              deleteReadStatus();
            });
          } else {
            deleteReadStatus();
          }
          
          function deleteReadStatus() {
            // –®–∞–≥ 3: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            db.query(`
              DELETE FROM message_read_status 
              WHERE message_id IN (
                SELECT id FROM messages 
                WHERE (sender_id = ? AND receiver_id = ?) 
                  OR (sender_id = ? AND receiver_id = ?)
              )
            `, [userId1, userId2, userId2, userId1], (err) => {
              if (err) console.error('‚ö†Ô∏è Error deleting read status:', err);
              deleteMessages();
            });
          }
          
          function deleteMessages() {
            // –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É —ç—Ç–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            db.query(`
              DELETE FROM messages 
              WHERE (sender_id = ? AND receiver_id = ?) 
                OR (sender_id = ? AND receiver_id = ?)
            `, [userId1, userId2, userId2, userId1], (err) => {
              if (err) {
                console.error('‚ùå Error deleting messages:', err);
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }
              console.log(`‚úÖ Chat between users ${userId1} and ${userId2} deleted successfully`);
              res.json({ success: true, message: '–ß–∞—Ç —É–¥–∞–ª–µ–Ω' });
            });
          }
        });
      }
    });
  });

  // ========== CALL ENDPOINTS ==========

  // –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫
  app.post('/api/calls/audio/initiate', authenticateToken, (req, res) => {
    const { receiver_id } = req.body;
    const caller_id = req.user.id;
    
    if (!receiver_id) {
      return res.status(400).json({ error: 'receiver_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }
    
    if (receiver_id == caller_id) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è –ø–æ–∑–≤–æ–Ω–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å
    db.query('SELECT id FROM users WHERE id = ?', [receiver_id], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –∑–≤–æ–Ω–∫–∞
      db.query(
        'INSERT INTO calls (caller_id, receiver_id, call_type, status) VALUES (?, ?, ?, ?)',
        [caller_id, receiver_id, 'audio', 'pending'],
        (err, result) => {
          if (err) {
            console.error('Database error:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          const callId = result.insertId;
          
          // –î–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∑–≤–æ–Ω–∫–∞
          const participants = [
            [callId, caller_id],
            [callId, receiver_id]
          ];
          
          db.query(
            'INSERT INTO call_participants (call_id, user_id) VALUES ?',
            [participants],
            (err) => {
              if (err) console.error('Error adding participants:', err);
            }
          );
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
          io.emit('incoming_call', {
            call_id: callId,
            caller_id,
            receiver_id,
            call_type: 'audio',
            caller_name: req.user.username,
            created_at: new Date()
          });
          
          console.log(`‚úÖ Audio call initiated: ${caller_id} -> ${receiver_id} (Call ID: ${callId})`);
          
          res.json({
            success: true,
            call_id: callId,
            call_type: 'audio',
            receiver_id,
            status: 'pending',
            message: '–ê—É–¥–∏–æ–∑–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω'
          });
        }
      );
    });
  });

  // –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫
  app.post('/api/calls/video/initiate', authenticateToken, (req, res) => {
    const { receiver_id } = req.body;
    const caller_id = req.user.id;
    
    if (!receiver_id) {
      return res.status(400).json({ error: 'receiver_id –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' });
    }
    
    if (receiver_id == caller_id) {
      return res.status(400).json({ error: '–ù–µ–ª—å–∑—è –ø–æ–∑–≤–æ–Ω–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å
    db.query('SELECT id FROM users WHERE id = ?', [receiver_id], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –∑–≤–æ–Ω–∫–∞
      db.query(
        'INSERT INTO calls (caller_id, receiver_id, call_type, status) VALUES (?, ?, ?, ?)',
        [caller_id, receiver_id, 'video', 'pending'],
        (err, result) => {
          if (err) {
            console.error('Database error:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          const callId = result.insertId;
          
          // –î–æ–±–∞–≤–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∑–≤–æ–Ω–∫–∞
          const participants = [
            [callId, caller_id],
            [callId, receiver_id]
          ];
          
          db.query(
            'INSERT INTO call_participants (call_id, user_id) VALUES ?',
            [participants],
            (err) => {
              if (err) console.error('Error adding participants:', err);
            }
          );
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
          io.emit('incoming_call', {
            call_id: callId,
            caller_id,
            receiver_id,
            call_type: 'video',
            caller_name: req.user.username,
            created_at: new Date()
          });
          
          console.log(`‚úÖ Video call initiated: ${caller_id} -> ${receiver_id} (Call ID: ${callId})`);
          
          res.json({
            success: true,
            call_id: callId,
            call_type: 'video',
            receiver_id,
            status: 'pending',
            message: '–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω'
          });
        }
      );
    });
  });

  // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫
  app.post('/api/calls/:callId/respond', authenticateToken, (req, res) => {
    const { callId } = req.params;
    const { accept = true } = req.body;
    const userId = req.user.id;
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–≤–æ–Ω–∫–µ
    db.query('SELECT * FROM calls WHERE id = ?', [callId], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ó–≤–æ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      const call = results[0];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å –∑–≤–æ–Ω–∫–∞
      if (call.receiver_id != userId) {
        return res.status(403).json({ error: '–≠—Ç–æ –Ω–µ –≤–∞—à –∑–≤–æ–Ω–æ–∫' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
      if (call.status !== 'pending') {
        return res.status(400).json({ error: '–ó–≤–æ–Ω–æ–∫ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω' });
      }
      
      const newStatus = accept ? 'accepted' : 'rejected';
      const startedAt = accept ? new Date() : null;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
      db.query(
        'UPDATE calls SET status = ?, started_at = ? WHERE id = ?',
        [newStatus, startedAt, callId],
        (err) => {
          if (err) {
            console.error('Database error:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          // –£–≤–µ–¥–æ–º–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
          io.emit('call_response', {
            call_id: callId,
            status: newStatus,
            receiver_id: userId,
            caller_id: call.caller_id
          });
          
          console.log(`‚úÖ Call ${callId} ${newStatus} by user ${userId}`);
          
          res.json({
            success: true,
            call_id: callId,
            status: newStatus,
            message: accept ? '–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç' : '–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω'
          });
        }
      );
    });
  });

  // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
  app.post('/api/calls/:callId/end', authenticateToken, (req, res) => {
    const { callId } = req.params;
    const userId = req.user.id;
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–≤–æ–Ω–∫–µ
    db.query('SELECT * FROM calls WHERE id = ?', [callId], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ó–≤–æ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      const call = results[0];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫ –∑–≤–æ–Ω–∫–∞
      if (call.caller_id != userId && call.receiver_id != userId) {
        return res.status(403).json({ error: '–í—ã –Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫ —ç—Ç–æ–≥–æ –∑–≤–æ–Ω–∫–∞' });
      }
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–≤–æ–Ω–∫–∞
      let duration = 0;
      if (call.started_at) {
        const endTime = new Date();
        const startTime = new Date(call.started_at);
        duration = Math.floor((endTime - startTime) / 1000); // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
      const finalStatus = call.status === 'pending' ? 'missed' : 'ended';
      
      db.query(
        'UPDATE calls SET status = ?, ended_at = ?, duration = ? WHERE id = ?',
        [finalStatus, new Date(), duration, callId],
        (err) => {
          if (err) {
            console.error('Database error:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          // –£–≤–µ–¥–æ–º–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
          io.emit('call_ended', {
            call_id: callId,
            status: finalStatus,
            duration,
            ended_by: userId
          });
          
          console.log(`‚úÖ Call ${callId} ended. Duration: ${duration}s`);
          
          res.json({
            success: true,
            call_id: callId,
            status: finalStatus,
            duration,
            message: '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω'
          });
        }
      );
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–≤–æ–Ω–∫–∞
  app.get('/api/calls/:callId/status', authenticateToken, (req, res) => {
    const { callId } = req.params;
    
    db.query('SELECT * FROM calls WHERE id = ?', [callId], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (results.length === 0) {
        return res.status(404).json({ error: '–ó–≤–æ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      const call = results[0];
      
      res.json({
        call_id: call.id,
        caller_id: call.caller_id,
        receiver_id: call.receiver_id,
        call_type: call.call_type,
        status: call.status,
        duration: call.duration,
        started_at: call.started_at,
        ended_at: call.ended_at,
        created_at: call.created_at
      });
    });
  });

  // –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–≤–æ–Ω–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/calls/history', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const limit = req.query.limit ? parseInt(req.query.limit) : 50;
    
    db.query(`
      SELECT 
        c.*,
        u_caller.username as caller_name,
        u_caller.avatar as caller_avatar,
        u_receiver.username as receiver_name,
        u_receiver.avatar as receiver_avatar
      FROM calls c
      LEFT JOIN users u_caller ON c.caller_id = u_caller.id
      LEFT JOIN users u_receiver ON c.receiver_id = u_receiver.id
      WHERE c.caller_id = ? OR c.receiver_id = ?
      ORDER BY c.created_at DESC
      LIMIT ?
    `, [userId, userId, limit], (err, results) => {
      if (err) {
        console.error('Database error:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json(results);
    });
  });

  // ========== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï PUSH-–£–í–ï–î–û–ú–õ–ï–ù–ò–ô ==========
  app.post('/api/test-push/:userId', async (req, res) => {
    const { userId } = req.params;
    
    try {
      const pushToken = await getPushTokenFromDB(userId);
      
      if (!pushToken) {
        return res.status(400).json({ error: 'Push —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      if (!Expo.isExpoPushToken(pushToken)) {
        return res.status(400).json({ error: '–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π push —Ç–æ–∫–µ–Ω' });
      }
      
      const message = {
        to: pushToken,
        sound: 'default',
        title: 'üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
        body: '–ï—Å–ª–∏ —Ç—ã —ç—Ç–æ –≤–∏–¥–∏—à—å - push —Ä–∞–±–æ—Ç–∞—é—Ç! üéâ',
        data: {
          type: 'test',
          timestamp: new Date().toISOString()
        },
        badge: 1,
        priority: 'high'
      };
      
      const tickets = await expo.sendPushNotificationsAsync([message]);
      console.log(`üì¨ –¢–µ—Å—Ç–æ–≤—ã–π push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}`);
      
      res.json({ 
        success: true, 
        message: '–¢–µ—Å—Ç–æ–≤—ã–π push –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω',
        token: pushToken.slice(0, 40) + '...'
      });
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ push:', error);
      res.status(500).json({ error: error.message });
    }
  });

  // üîç –û–¢–õ–ê–î–û–ß–ù–´–ô –≠–ù–î–ü–û–ò–ù–¢: –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ push-—Ç–æ–∫–µ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  app.get('/api/debug/push-token/:userId', (req, res) => {
    const { userId } = req.params;
    
    console.log(`\nüìä [DEBUG] –ó–∞–ø—Ä–æ—Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ push-—Ç–æ–∫–µ–Ω–µ –¥–ª—è user_id=${userId}`);
    
    db.query(
      'SELECT id, user_id, push_token, device_type, device_name, updated_at FROM push_tokens WHERE user_id = ?',
      [userId],
      (err, results) => {
        if (err) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ë–î:`, err.message);
          return res.status(500).json({ error: err.message });
        }
        
        if (!results || results.length === 0) {
          console.log(`‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è user_id=${userId}`);
          return res.status(404).json({ 
            error: '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω',
            userId,
            message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª push-—Ç–æ–∫–µ–Ω'
          });
        }
        
        const token = results[0];
        const pushToken = token.push_token;
        const isValid = Expo.isExpoPushToken(pushToken);
        
        console.log(`‚úÖ –ù–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –¥–ª—è user_id=${userId}:`);
        console.log(`   –¢–æ–∫–µ–Ω: ${pushToken.substring(0, 50)}...`);
        console.log(`   –í–∞–ª–∏–¥–µ–Ω: ${isValid}`);
        console.log(`   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${token.device_type} (${token.device_name})`);
        console.log(`   –û–±–Ω–æ–≤–ª–µ–Ω: ${token.updated_at}`);
        
        res.json({
          userId,
          found: true,
          token: {
            tokenPrefix: pushToken.substring(0, 50) + '...',
            fullToken: pushToken,
            isValid: isValid,
            deviceType: token.device_type,
            deviceName: token.device_name,
            updatedAt: token.updated_at
          },
          message: isValid ? '‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é' : '‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω'
        });
      }
    );
  });

  // üîç –û–¢–õ–ê–î–û–ß–ù–´–ô –≠–ù–î–ü–û–ò–ù–¢: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ push-—Ç–æ–∫–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ
  app.get('/api/debug/push-tokens/all', (req, res) => {
    console.log(`\nüìä [DEBUG] –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö push-—Ç–æ–∫–µ–Ω–æ–≤`);
    
    db.query(
      'SELECT id, user_id, push_token, device_type, device_name, updated_at FROM push_tokens ORDER BY updated_at DESC',
      [],
      (err, results) => {
        if (err) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ë–î:`, err.message);
          return res.status(500).json({ error: err.message });
        }
        
        const tokenStats = {
          totalTokens: results ? results.length : 0,
          validTokens: 0,
          invalidTokens: 0,
          tokens: []
        };
        
        if (results && results.length > 0) {
          results.forEach((token) => {
            const isValid = Expo.isExpoPushToken(token.push_token);
            if (isValid) tokenStats.validTokens++;
            else tokenStats.invalidTokens++;
            
            tokenStats.tokens.push({
              userId: token.user_id,
              tokenPrefix: token.push_token.substring(0, 40) + '...',
              isValid: isValid,
              deviceType: token.device_type,
              deviceName: token.device_name,
              updatedAt: token.updated_at
            });
          });
        }
        
        console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ push-—Ç–æ–∫–µ–Ω–æ–≤:`);
        console.log(`   –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: ${tokenStats.totalTokens}`);
        console.log(`   –í–∞–ª–∏–¥–Ω—ã—Ö: ${tokenStats.validTokens}`);
        console.log(`   –ù–µ–≤–∞–ª–∏–¥–Ω—ã—Ö: ${tokenStats.invalidTokens}`);
        
        res.json(tokenStats);
      }
    );
  });

  // ========== –ê–í–¢–û–°–û–•–†–ê–ù–ï–ù–ò–ï –¢–û–ö–ï–ù–û–í –ö–ê–ñ–î–´–ï 5 –ú–ò–ù–£–¢ ==========
  setInterval(() => {
    saveTokensToFile(userPushTokens);
    console.log(`üíæ –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª (${Object.keys(userPushTokens).length} —Ç–æ–∫–µ–Ω–æ–≤)`);
  }, 5 * 60 * 1000);

  // ========== –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–ï–†–í–ï–†–ê: –°—Ç–∞—Ç—É—Å ==========
  const serverStartTime = Date.now();
  const serverLogs = [];

  // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥ –≤ –æ—á–µ—Ä–µ–¥—å
  const addLog = (message, level = 'info') => {
    const log = {
      timestamp: new Date().toISOString(),
      message,
      level
    };
    serverLogs.push(log);
    // –•—Ä–∞–Ω–∏–º–º –º–∞–∫—Å–∏–º—É–º 200 –ª–æ–≥–æ–≤
    if (serverLogs.length > 200) {
      serverLogs.shift();
    }
    console.log(`[${level.toUpperCase()}] ${message}`);
  };

  // –≠–Ω–¥–ø–æ–∏–Ω—Ç: –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
  app.get('/api/server/status', authenticateToken, (req, res) => {
    const uptime = Math.floor((Date.now() - serverStartTime) / 1000);
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤ Socket.io –∫–æ–º–Ω–∞—Ç–∞—Ö)
    const activeUsers = userSockets.size;
    
    // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –ë–î
    db.query('SELECT COUNT(*) as count FROM groups', (err, groupResults) => {
      const activeGroups = groupResults?.[0]?.count || 0;
      
      db.query('SELECT COUNT(*) as count FROM messages UNION ALL SELECT COUNT(*) as count FROM group_messages', (err, messageResults) => {
        const totalMessages = messageResults?.reduce((sum, row) => sum + (row.count || 0), 0) || 0;
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ø–∞–º—è—Ç–∏
        const memUsage = process.memoryUsage();
        const memMB = (memUsage.heapUsed / 1024 / 1024).toFixed(2);
        
        res.json({
          status: 'online',
          uptime,
          activeUsers,
          activeGroups,
          totalMessages,
          memory: `${memMB} MB`,
          nodeVersion: process.version,
          platform: process.platform
        });
      });
    });
  });

  // –≠–Ω–¥–ø–æ–∏–Ω—Ç: –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
  app.get('/api/admin/server/logs', authenticateToken, (req, res) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err || !results?.length || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      res.json({ logs: serverLogs });
    });
  });

  // –≠–Ω–¥–ø–æ–∏–Ω—Ç: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
  app.post('/api/admin/server/restart', authenticateToken, (req, res) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err || !results?.length || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      addLog('–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ –∫–æ–º–∞–Ω–¥–µ –∞–¥–º–∏–Ω–∞', 'warning');
      res.json({ message: '–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω...' });
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
      io.emit('server_restarting', { message: '–°–µ—Ä–≤–µ—Ä —Å–µ–π—á–∞—Å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è' });
      
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        process.exit(0);
      }, 2000);
    });
  });

  // üîë –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø PUSH –¢–û–ö–ï–ù–ê (REST API)
  app.post('/users/push-token', authenticateToken, (req, res) => {
    const { pushToken, deviceType, deviceName } = req.body;
    const userId = req.user.id;
    
    if (!pushToken) {
      console.log('‚ùå Push-—Ç–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
      return res.status(400).json({ error: 'Push —Ç–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω' });
    }
    
    console.log(`üîë –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è push-—Ç–æ–∫–µ–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
    console.log(`   –¢–æ–∫–µ–Ω: ${String(pushToken).slice(0, 40)}...`);
    console.log(`   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${deviceType || 'unknown'}`);
    
    db.query(
      `INSERT INTO push_tokens (user_id, push_token, device_type, device_name) 
      VALUES (?, ?, ?, ?)
      ON DUPLICATE KEY UPDATE 
        push_token = VALUES(push_token),
        device_type = VALUES(device_type),
        device_name = VALUES(device_name),
        updated_at = CURRENT_TIMESTAMP`,
      [userId, pushToken, deviceType || 'unknown', deviceName || 'unknown'],
      (err, result) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞:', err.message);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞' });
        }
        
        console.log(`‚úÖ Push-—Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`);
        res.json({ success: true, message: 'Push-—Ç–æ–∫–µ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω' });
      }
    );
  });

  // ============================================
  // –ñ–ê–õ–û–ë–´ –ù–ê –ü–û–°–¢–´
  // ============================================

  // 1Ô∏è‚É£ ENDPOINT: –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ—Å—Ç
  app.post('/api/posts/:postId/report', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const { reason } = req.body;
    const userId = req.user.id;

    if (!reason || reason.trim().length === 0) {
      return res.status(400).json({ error: '–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞' });
    }

    if (reason.trim().length > 500) {
      return res.status(400).json({ error: '–ü—Ä–∏—á–∏–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 500 —Å–∏–º–≤–æ–ª–æ–≤' });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ—Å—Ç
    db.query('SELECT id FROM posts WHERE id = ?', [postId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å—Ç–∞:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      if (results.length === 0) {
        return res.status(404).json({ error: '–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∂–∞–ª–æ–≤–∞–ª—Å—è –ª–∏ —É–∂–µ —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —ç—Ç–æ—Ç –ø–æ—Å—Ç
      db.query(
        'SELECT id FROM post_reports WHERE post_id = ? AND reporter_id = ? AND status != "rejected"',
        [postId, userId],
        (err, existingReports) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∂–∞–ª–æ–±—ã:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }

          if (existingReports.length > 0) {
            return res.status(400).json({ 
              error: '–í—ã —É–∂–µ –ø–æ–∂–∞–ª–æ–≤–∞–ª–∏—Å—å –Ω–∞ —ç—Ç–æ—Ç –ø–æ—Å—Ç' 
            });
          }

          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∂–∞–ª–æ–±—É
          db.query(
            'INSERT INTO post_reports (post_id, reporter_id, reason) VALUES (?, ?, ?)',
            [postId, userId, reason.trim()],
            (err, result) => {
              if (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∂–∞–ª–æ–±—ã:', err);
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }

              console.log(`‚úÖ –ñ–∞–ª–æ–±–∞ –Ω–∞ –ø–æ—Å—Ç ${postId} —Å–æ–∑–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId}`);

              res.json({
                success: true,
                message: '–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º',
                reportId: result.insertId
              });
            }
          );
        }
      );
    });
  });

  // 2Ô∏è‚É£ ENDPOINT: –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∂–∞–ª–æ–±—ã (–∞–¥–º–∏–Ω)
  app.get('/api/admin/post-reports', authenticateToken, (req, res) => {
    const userId = req.user.id;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [userId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
      }

      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∂–∞–ª–æ–±—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å—Ç–∞—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
      const query = `
        SELECT 
          pr.id,
          pr.post_id,
          pr.reporter_id,
          pr.reason,
          pr.status,
          pr.reviewed_by,
          pr.reviewed_at,
          pr.created_at,
          p.content as post_content,
          p.user_id as post_author_id,
          u_reporter.username as reporter_username,
          u_reporter.avatar as reporter_avatar,
          u_author.username as post_author_username,
          u_author.avatar as post_author_avatar,
          u_reviewer.username as reviewer_username
        FROM post_reports pr
        JOIN posts p ON pr.post_id = p.id
        JOIN users u_reporter ON pr.reporter_id = u_reporter.id
        JOIN users u_author ON p.user_id = u_author.id
        LEFT JOIN users u_reviewer ON pr.reviewed_by = u_reviewer.id
        ORDER BY 
          CASE 
            WHEN pr.status = 'pending' THEN 1
            WHEN pr.status = 'reviewed' THEN 2
            ELSE 3
          END,
          pr.created_at DESC
      `;

      db.query(query, (err, reports) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∂–∞–ª–æ–±:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        res.json(reports);
      });
    });
  });

  // 3Ô∏è‚É£ ENDPOINT: –ü–æ–ª—É—á–∏—Ç—å –∂–∞–ª–æ–±—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
  app.get('/api/posts/:postId/reports', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const userId = req.user.id;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [userId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
      }

      const query = `
        SELECT 
          pr.*,
          u_reporter.username as reporter_username,
          u_reporter.avatar as reporter_avatar,
          u_reviewer.username as reviewer_username
        FROM post_reports pr
        JOIN users u_reporter ON pr.reporter_id = u_reporter.id
        LEFT JOIN users u_reviewer ON pr.reviewed_by = u_reviewer.id
        WHERE pr.post_id = ?
        ORDER BY pr.created_at DESC
      `;

      db.query(query, [postId], (err, reports) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∂–∞–ª–æ–± –ø–æ—Å—Ç–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        res.json(reports);
      });
    });
  });

  // 4Ô∏è‚É£ ENDPOINT: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∂–∞–ª–æ–±—É (—É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∂–∞–ª–æ–±—É)
  app.post('/api/admin/post-reports/:reportId/:action', authenticateToken, (req, res) => {
    const { reportId, action } = req.params;
    const { ban_duration_days } = req.body;
    const adminId = req.user.id;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [adminId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∂–∞–ª–æ–±–µ
      db.query(
        'SELECT post_id, reporter_id FROM post_reports WHERE id = ?',
        [reportId],
        (err, reportResults) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∂–∞–ª–æ–±—ã:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }

          if (reportResults.length === 0) {
            return res.status(404).json({ error: '–ñ–∞–ª–æ–±–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
          }

          const { post_id, reporter_id } = reportResults[0];

          if (action === 'approve') {
            // –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç
            db.query('DELETE FROM posts WHERE id = ?', [post_id], (err) => {
              if (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }

              // –û—Ç–º–µ—á–∞–µ–º –∂–∞–ª–æ–±—É –∫–∞–∫ approved
              db.query(
                'UPDATE post_reports SET status = "approved", reviewed_by = ?, reviewed_at = NOW() WHERE id = ?',
                [adminId, reportId],
                (err) => {
                  if (err) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂–∞–ª–æ–±—ã:', err);
                    return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                  }

                  console.log(`‚úÖ –ñ–∞–ª–æ–±–∞ ${reportId} –æ–¥–æ–±—Ä–µ–Ω–∞. –ü–æ—Å—Ç ${post_id} —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${adminId}`);

                  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Socket.io
                  io.emit('post_deleted_by_admin', {
                    post_id: post_id,
                    reason: '–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω –ø–æ –∂–∞–ª–æ–±–µ'
                  });

                  res.json({
                    success: true,
                    message: '–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω –ø–æ –∂–∞–ª–æ–±–µ'
                  });
                }
              );
            });
          } else if (action === 'reject') {
            // –û—Ç–º–µ—á–∞–µ–º –∂–∞–ª–æ–±—É –∫–∞–∫ rejected
            db.query(
              'UPDATE post_reports SET status = "rejected", reviewed_by = ?, reviewed_at = NOW() WHERE id = ?',
              [adminId, reportId],
              (err) => {
                if (err) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂–∞–ª–æ–±—ã:', err);
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                }

                console.log(`‚úÖ –ñ–∞–ª–æ–±–∞ ${reportId} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${adminId}`);

                res.json({
                  success: true,
                  message: '–ñ–∞–ª–æ–±–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'
                });
              }
            );
          } else if (action === 'ban-user') {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-–Ω–∞—Ä—É—à–∏—Ç–µ–ª—è
            const reason = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è (–∂–∞–ª–æ–±–∞ –Ω–∞ –ø–æ—Å—Ç)';
            const { ban_duration_days } = req.body;
            let bannedUntil = null;

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É —Ä–∞–∑–±–∞–Ω–∞
            if (ban_duration_days !== null && ban_duration_days !== undefined) {
              const now = new Date();
              bannedUntil = new Date(now.getTime() + ban_duration_days * 24 * 60 * 60 * 1000);
            }

            db.query(
              'UPDATE users SET is_banned = TRUE, ban_reason = ?, banned_at = CURRENT_TIMESTAMP, banned_by = ?, banned_until = ? WHERE id = ?',
              [reason, adminId, bannedUntil, reporter_id],
              (err, result) => {
                if (err) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', details: err.message });
                }

                if (result.affectedRows === 0) {
                  return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
                }

                // –û—Ç–º–µ—á–∞–µ–º –∂–∞–ª–æ–±—É –∫–∞–∫ approved
                db.query(
                  'UPDATE post_reports SET status = "approved", reviewed_by = ?, reviewed_at = NOW() WHERE id = ?',
                  [adminId, reportId],
                  (err) => {
                    if (err) {
                      console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂–∞–ª–æ–±—ã:', err);
                      return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                    }

                    console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${reporter_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${adminId} –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è`);

                    const message = ban_duration_days === null 
                      ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞'
                      : `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${ban_duration_days} –¥–Ω–µ–π`;

                    res.json({
                      success: true,
                      message: message
                    });
                  }
                );
              }
            );
          } else {
            return res.status(400).json({ error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ' });
          }
        }
      );
    });
  });

  // 5Ô∏è‚É£ ENDPOINT: –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∂–∞–ª–æ–±
  app.get('/api/admin/post-reports-stats', authenticateToken, (req, res) => {
    const userId = req.user.id;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [userId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
      }

      const query = `
        SELECT 
          status,
          COUNT(*) as count
        FROM post_reports
        GROUP BY status
      `;

      db.query(query, (err, stats) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∂–∞–ª–æ–±:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }

        const statsObj = {
          pending: 0,
          reviewed: 0,
          approved: 0,
          rejected: 0,
          total: 0
        };

        stats.forEach(stat => {
          statsObj[stat.status] = stat.count;
          statsObj.total += stat.count;
        });

        res.json(statsObj);
      });
    });
  });

  // 6Ô∏è‚É£ ENDPOINT: –û—Ç–º–µ—Ç–∏—Ç—å –∂–∞–ª–æ–±—É –∫–∞–∫ "–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ"
  app.patch('/api/admin/post-reports/:reportId/mark-reviewed', authenticateToken, (req, res) => {
    const { reportId } = req.params;
    const adminId = req.user.id;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [adminId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }

      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
      }

      db.query(
        'UPDATE post_reports SET status = "reviewed" WHERE id = ? AND status = "pending"',
        [reportId],
        (err) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∂–∞–ª–æ–±—ã:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }

          console.log(`‚úÖ –ñ–∞–ª–æ–±–∞ ${reportId} –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${adminId}`);

          res.json({
            success: true,
            message: '–ñ–∞–ª–æ–±–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ'
          });
        }
      );
    });
  });

  // ============================================
  // –ë–ê–ù –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ "–õ—é–¥–∏")
  // ============================================

  app.post('/admin/users/:userId/ban', authenticateToken, (req, res) => {
    const { userId } = req.params;
    const { reason = '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤–∞', ban_duration_days } = req.body;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–¥–º–∏–Ω –Ω–µ –∑–∞–±–∞–Ω–∏–≤–∞–µ—Ç —Å–∞–º —Å–µ–±—è
      if (parseInt(userId) === req.user.id) {
        return res.status(400).json({ error: '–ù–µ–ª—å–∑—è –∑–∞–±–∞–Ω–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è' });
      }
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É —Ä–∞–∑–±–∞–Ω–∞
      let bannedUntil = null;
      if (ban_duration_days !== null && ban_duration_days !== undefined && ban_duration_days > 0) {
        const now = new Date();
        bannedUntil = new Date(now.getTime() + ban_duration_days * 24 * 60 * 60 * 1000);
      }
      // –ï—Å–ª–∏ null –∏–ª–∏ undefined - –±–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞, banned_until –æ—Å—Ç–∞–µ—Ç—Å—è null
      
      // –ó–∞–±–∞–Ω–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      db.query(
        'UPDATE users SET is_banned = TRUE, ban_reason = ?, banned_at = CURRENT_TIMESTAMP, banned_until = ?, banned_by = ? WHERE id = ?',
        [reason, bannedUntil, req.user.id, userId],
        (err, result) => {
          if (err) {
            console.error('‚ùå Error banning user:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          if (result.affectedRows === 0) {
            return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
          }
          
          const durationText = ban_duration_days === null 
            ? '–Ω–∞–≤—Å–µ–≥–¥–∞' 
            : `–Ω–∞ ${ban_duration_days} –¥–Ω–µ–π`;
          
          console.log(`üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∑–∞–±–∞–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id} ${durationText}. –ü—Ä–∏—á–∏–Ω–∞: ${reason}`);
          
          // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–∞–Ω–µ —á–µ—Ä–µ–∑ WebSocket –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω
          const userSocketIds = getUserSocketIds(userId);
          if (userSocketIds.length > 0) {
            userSocketIds.forEach((socketId) => {
              io.to(socketId).emit('user_banned', {
                reason: reason,
                message: '–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
                bannedUntil: bannedUntil
              });
            });
          }
          
          res.json({ 
            success: true, 
            message: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ –∑–∞–±–∞–Ω–µ–Ω ${durationText}`,
            reason: reason,
            bannedUntil: bannedUntil
          });
        }
      );
    });
  });

  // –†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (ADMIN)
  app.post('/api/admin/users/:userId/unban', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –†–∞–∑–±–∞–Ω–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      db.query(
        'UPDATE users SET is_banned = FALSE, ban_reason = NULL, banned_at = NULL, banned_until = NULL, banned_by = NULL WHERE id = ?',
        [userId],
        (err, result) => {
          if (err) {
            console.error('‚ùå Error unbanning user:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          if (result.affectedRows === 0) {
            return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
          }
          
          console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —Ä–∞–∑–±–∞–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id}`);
          
          res.json({ 
            success: true, 
            message: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–±–∞–Ω–µ–Ω`
          });
        }
      );
    });
  });

  // ============================================
  // üìã –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï ENDPOINT'–´ –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¶–ò–ò
  // ============================================

  // ============================================
  // 1Ô∏è‚É£ –û–ß–ò–°–¢–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–• (ADMIN)
  // ============================================
  app.post('/api/admin/database/clear', authenticateToken, async (req, res) => {
    const { confirmation } = req.body;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], async (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' });
      }
      
      // –¢—Ä–µ–±—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
      if (confirmation !== 'CLEAR_ALL_DATA') {
        return res.status(400).json({ 
          error: '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ',
          message: '–û—Ç–ø—Ä–∞–≤—å—Ç–µ { confirmation: "CLEAR_ALL_DATA" } —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—á–∏—Å—Ç–∫—É'
        });
      }
      
      try {
        console.log(`\n${'='.repeat(70)}`);
        console.log(`üóëÔ∏è  –ù–ê–ß–ê–õ–û –û–ß–ò–°–¢–ö–ò –ë–ê–ó–´ –î–ê–ù–ù–´–•`);
        console.log(`   –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: ${req.user.id}`);
        console.log(`   –í—Ä–µ–º—è: ${new Date().toISOString()}`);
        console.log(`${'='.repeat(70)}\n`);
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É FOREIGN KEY –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        await new Promise((resolve, reject) => {
          db.query('SET FOREIGN_KEY_CHECKS = 0', (err) => {
            if (err) reject(err);
            else resolve();
          });
        });
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î
        const getTables = () => new Promise((resolve, reject) => {
          db.query(`SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = DATABASE() AND TABLE_NAME NOT IN ('information_schema')`, (err, tables) => {
            if (err) reject(err);
            else resolve(tables.map(t => t.TABLE_NAME));
          });
        });
        
        const tables = await getTables();
        console.log(`üìä –ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü –¥–ª—è –æ—á–∏—Å—Ç–∫–∏: ${tables.length}`);
        
        // –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –ö–†–û–ú–ï –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏–ª –æ—á–∏—Å—Ç–∫—É
        let totalDeleted = 0;
        
        for (const table of tables) {
          const query = table === 'users' 
            ? `DELETE FROM ${table} WHERE id != ${req.user.id}`
            : `DELETE FROM ${table}`;
          
          const result = await new Promise((resolve, reject) => {
            db.query(query, (err, result) => {
              if (err) {
                console.warn(`‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ ${table}: ${err.message}`);
                resolve(null);
              } else {
                console.log(`‚úÖ –û—á–∏—â–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞: ${table} (${result.affectedRows || 0} —Å—Ç—Ä–æ–∫)`);
                totalDeleted += result.affectedRows || 0;
                resolve(result);
              }
            });
          });
        }
        
        // –í–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫—É FOREIGN KEY
        await new Promise((resolve, reject) => {
          db.query('SET FOREIGN_KEY_CHECKS = 1', (err) => {
            if (err) reject(err);
            else resolve();
          });
        });
        
        console.log(`\n${'='.repeat(70)}`);
        console.log(`‚úÖ –ë–ê–ó–ê –î–ê–ù–ù–´–• –û–ß–ò–©–ï–ù–ê –£–°–ü–ï–®–ù–û`);
        console.log(`${'='.repeat(70)}\n`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        io.emit('database_cleared', {
          message: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
          cleared_by: req.user.id,
          cleared_at: new Date().toISOString()
        });
        
        res.json({ 
          success: true, 
          message: '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞',
          tables_cleared: tables.length,
          total_rows_deleted: totalDeleted
        });
        
      } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ë–î:', error);
        res.status(500).json({ 
          error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö',
          details: error.message 
        });
      }
    });
  });

  // ============================================
  // 2Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –°–¢–ê–¢–ò–°–¢–ò–ö–£ –°–ï–†–í–ï–†–ê (ADMIN)
  // ============================================
  app.get('/admin/statistics', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      const stats = {};
      let completedQueries = 0;
      const totalQueries = 10;
      
      db.query('SELECT COUNT(*) as count FROM users', (err, result) => {
        stats.totalUsers = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM users WHERE is_online = TRUE', (err, result) => {
        stats.onlineUsers = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM users WHERE is_banned = TRUE', (err, result) => {
        stats.bannedUsers = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM messages', (err, result) => {
        stats.totalMessages = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM group_messages', (err, result) => {
        stats.groupMessages = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM groups', (err, result) => {
        stats.totalGroups = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM posts', (err, result) => {
        stats.totalPosts = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM likes', (err, result) => {
        stats.totalLikes = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM comments', (err, result) => {
        stats.totalComments = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      db.query('SELECT COUNT(*) as count FROM hashtags', (err, result) => {
        stats.totalHashtags = result?.[0]?.count || 0;
        completedQueries++;
        if (completedQueries === totalQueries) sendStats();
      });
      
      function sendStats() {
        res.json({
          success: true,
          data: stats,
          timestamp: new Date().toISOString()
        });
      }
    });
  });

  // ============================================
  // 3Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–• (ADMIN)
  // ============================================
  app.get('/admin/all-users', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      db.query(`
        SELECT 
          id,
          username,
          email,
          avatar,
          bio,
          status,
          is_online,
          is_banned,
          ban_reason,
          banned_at,
          banned_until,
          is_admin,
          created_at
        FROM users
        ORDER BY created_at DESC
      `, (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json(results);
      });
    });
  });

  // ============================================
  // 4Ô∏è‚É£ –ü–û–ò–°–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –ü–û –ò–ú–ï–ù–ò –ò–õ–ò EMAIL (ADMIN)
  // ============================================
  app.get('/admin/users/search', authenticateToken, (req, res) => {
    const { q } = req.query;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      if (!q || q.trim().length < 2) {
        return res.status(400).json({ error: '–ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞' });
      }
      
      db.query(`
        SELECT 
          id,
          username,
          email,
          avatar,
          is_online,
          is_banned,
          ban_reason,
          is_admin,
          created_at
        FROM users
        WHERE username LIKE ? OR email LIKE ?
        LIMIT 20
      `, [`%${q}%`, `%${q}%`], (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        res.json(results);
      });
    });
  });

  // ============================================
  // 5Ô∏è‚É£ –°–ë–†–û–° –ü–ê–†–û–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (ADMIN)
  // ============================================
  app.post('/admin/users/:userId/reset-password', authenticateToken, async (req, res) => {
    const { userId } = req.params;
    const { newPassword } = req.body;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      if (!newPassword || newPassword.length < 6) {
        return res.status(400).json({ error: '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤' });
      }
      
      bcrypt.hash(newPassword, 10, (err, hashedPassword) => {
        if (err) {
          console.error('‚ùå Error hashing password:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        db.query(
          'UPDATE users SET password = ? WHERE id = ?',
          [hashedPassword, userId],
          (err, result) => {
            if (err) {
              console.error('‚ùå Error updating password:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            if (result.affectedRows === 0) {
              return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
            }
            
            console.log(`‚úÖ –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –∏–∑–º–µ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id}`);
            
            res.json({ 
              success: true, 
              message: '–ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω'
            });
          }
        );
      });
    });
  });

  // ============================================
  // 6Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –ö–û–ù–ö–†–ï–¢–ù–û–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï (ADMIN)
  // ============================================
  app.get('/admin/users/:userId/info', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      db.query(`
        SELECT 
          u.id,
          u.username,
          u.email,
          u.avatar,
          u.bio,
          u.status,
          u.is_online,
          u.is_banned,
          u.ban_reason,
          u.banned_at,
          u.banned_until,
          u.is_admin,
          u.created_at,
          (SELECT COUNT(*) FROM posts WHERE user_id = u.id) as posts_count,
          (SELECT COUNT(*) FROM messages WHERE sender_id = u.id) as messages_sent,
          (SELECT COUNT(*) FROM messages WHERE receiver_id = u.id) as messages_received,
          (SELECT COUNT(*) FROM friends WHERE user_id = u.id OR friend_id = u.id) as friends_count,
          (SELECT COUNT(*) FROM group_members WHERE user_id = u.id) as groups_count
        FROM users u
        WHERE u.id = ?
      `, [userId], (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        if (results.length === 0) return res.status(404).json({ error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
        
        res.json(results[0]);
      });
    });
  });

  // ============================================
  // 7Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ò–°–¢–û–†–ò–ò –î–ï–ô–°–¢–í–ò–ô (ADMIN LOGS)
  // ============================================
  app.get('/admin/action-logs', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      res.json({
        success: true,
        logs: serverLogs.slice(-100)
      });
    });
  });

  // ============================================
  // 8Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –í–°–ï –ê–ö–¢–ò–í–ù–´–ï –ó–í–û–ù–ö–ò (ADMIN)
  // ============================================
  app.get('/admin/active-calls', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      const calls = Array.from(activeCalls.entries()).map(([callId, call]) => ({
        callId,
        ...call,
        durationSeconds: Math.floor((new Date() - call.started_at) / 1000)
      }));
      
      res.json({
        success: true,
        active_calls: calls,
        total_active: calls.length
      });
    });
  });

  // ============================================
  // 9Ô∏è‚É£ –ó–ê–í–ï–†–®–ò–¢–¨ –ó–í–û–ù–û–ö –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (ADMIN)
  // ============================================
  app.post('/admin/calls/:callId/terminate', authenticateToken, (req, res) => {
    const { callId } = req.params;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      const call = activeCalls.get(callId);
      
      if (!call) {
        return res.status(404).json({ error: '–ó–≤–æ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω' });
      }
      
      io.to(`user_${call.from_user_id}`).emit('call_terminated_by_admin', {
        callId,
        message: '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º'
      });
      
      io.to(`user_${call.to_user_id}`).emit('call_terminated_by_admin', {
        callId,
        message: '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º'
      });
      
      activeCalls.delete(callId);
      
      console.log(`‚úÖ –ó–≤–æ–Ω–æ–∫ ${callId} –∑–∞–≤–µ—Ä—à–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ${req.user.id}`);
      
      res.json({ 
        success: true, 
        message: '–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω'
      });
    });
  });

  // ============================================
  // üîü –ü–û–õ–£–ß–ò–¢–¨ –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –ì–†–£–ü–ü–ï (ADMIN)
  // ============================================
  app.get('/admin/groups/:groupId/info', authenticateToken, (req, res) => {
    const { groupId } = req.params;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      db.query(`
        SELECT 
          g.id,
          g.name,
          g.description,
          g.avatar,
          g.created_by,
          u.username as creator_username,
          (SELECT COUNT(*) FROM group_members WHERE group_id = g.id) as members_count,
          (SELECT COUNT(*) FROM group_messages WHERE group_id = g.id) as messages_count,
          g.created_at
        FROM groups g
        LEFT JOIN users u ON g.created_by = u.id
        WHERE g.id = ?
      `, [groupId], (err, results) => {
        if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        if (results.length === 0) return res.status(404).json({ error: '–ì—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' });
        
        res.json(results[0]);
      });
    });
  });

  // ============================================
  // ‚ì´ –≠–ö–°–ü–û–†–¢–ò–†–û–í–ê–¢–¨ –ë–ê–ó–£ –î–ê–ù–ù–´–• (ADMIN)
  // ============================================
  app.get('/admin/database/export', authenticateToken, (req, res) => {
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      const tables = [
        'users',
        'messages',
        'groups',
        'group_members',
        'group_messages',
        'posts',
        'likes',
        'comments',
        'friends',
        'calls',
        'hashtags',
        'post_hashtags',
        'post_reports'
      ];
      
      const exportData = {};
      let completed = 0;
      
      tables.forEach(table => {
        db.query(`SELECT * FROM ${table}`, (err, results) => {
          exportData[table] = results || [];
          completed++;
          
          if (completed === tables.length) {
            res.json({
              success: true,
              export_date: new Date().toISOString(),
              data: exportData
            });
          }
        });
      });
    });
  });

  // ============================================
  // ‚ì¨ –û–¢–ü–†–ê–í–ò–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –í–°–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú (ADMIN)
  // ============================================
  app.post('/admin/broadcast-notification', authenticateToken, (req, res) => {
    const { title, message } = req.body;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      if (!title || !message) {
        return res.status(400).json({ error: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã' });
      }
      
      io.emit('admin_notification', {
        title,
        message,
        sent_by: req.user.username,
        sent_at: new Date().toISOString()
      });
      
      console.log(`üì¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ${req.user.id} –æ—Ç–ø—Ä–∞–≤–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`);
      
      res.json({ 
        success: true, 
        message: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º'
      });
    });
  });

  // ============================================
  // ‚ì≠ –ë–õ–û–ö–ò–†–û–í–ö–ê/–†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –û–¢ –ß–ê–¢–û–í (ADMIN)
  // ============================================
  app.post('/admin/users/:userId/mute', authenticateToken, (req, res) => {
    const { userId } = req.params;
    const { duration_minutes = 60 } = req.body;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      const muteUntil = new Date(Date.now() + duration_minutes * 60 * 1000);
      
      if (!global.mutedUsers) {
        global.mutedUsers = new Map();
      }
      
      global.mutedUsers.set(String(userId), {
        muteUntil,
        mutedBy: req.user.id,
        reason: req.body.reason || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∑–∞–≥–ª—É—à–∏–ª'
      });
      
      io.to(`user_${userId}`).emit('user_muted', {
        duration_minutes,
        reason: req.body.reason || '–í—ã –∑–∞–≥–ª—É—à–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º',
        until: muteUntil
      });
      
      console.log(`üîá –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∑–∞–≥–ª—É—à–µ–Ω –Ω–∞ ${duration_minutes} –º–∏–Ω—É—Ç –∞–¥–º–∏–Ω–æ–º ${req.user.id}`);
      
      res.json({ 
        success: true, 
        message: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥–ª—É—à–µ–Ω –Ω–∞ ${duration_minutes} –º–∏–Ω—É—Ç`
      });
    });
  });

  app.post('/admin/users/:userId/unmute', authenticateToken, (req, res) => {
    const { userId } = req.params;
    
    db.query('SELECT is_admin FROM users WHERE id = ?', [req.user.id], (err, results) => {
      if (err) return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      if (results.length === 0 || !results[0].is_admin) {
        return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
      }
      
      if (global.mutedUsers) {
        global.mutedUsers.delete(String(userId));
      }
      
      io.to(`user_${userId}`).emit('user_unmuted', {
        message: '–í—ã –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥–ª—É—à–µ–Ω—ã'
      });
      
      console.log(`üîä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —Ä–∞–∑–≥–ª—É—à–µ–Ω –∞–¥–º–∏–Ω–æ–º ${req.user.id}`);
      
      res.json({ 
        success: true, 
        message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–≥–ª—É—à–µ–Ω'
      });
    });
  });

  // ============================================
  // üèòÔ∏è –≠–ù–î–ü–û–ò–ù–¢–´ –î–õ–Ø –°–û–û–ë–©–ï–°–¢–í (Communities)
  // ============================================

  // 1Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –í–°–ï –°–û–û–ë–©–ï–°–¢–í–ê (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π)
  // 1Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –í–°–ï –°–û–û–ë–©–ï–°–¢–í–ê (—Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π) - –ò–°–ü–†–ê–í–õ–ï–ù–û
  app.get('/api/communities', authenticateToken, (req, res) => {
    const { limit = 20, offset = 0, category = null, search = null, sort = 'newest' } = req.query;
    const userId = req.user.id;
    
    let query = `
      SELECT 
        c.*,
        u.username as creator_username,
        u.avatar as creator_avatar,
        COALESCE(cs.members_count, 0) as members_count,
        COALESCE(cs.posts_count, 0) as posts_count,
        COALESCE(cs.followers_count, 0) as followers_count,
        COALESCE(cs.views_count, 0) as views_count,
        COALESCE(
          (SELECT 1 FROM community_members 
          WHERE community_id = c.id AND user_id = ?), 0
        ) as is_member,
        COALESCE(
          (SELECT 1 FROM community_followers 
          WHERE community_id = c.id AND user_id = ?), 0
        ) as is_following,
        COALESCE(
          (SELECT 1 FROM community_bans 
          WHERE community_id = c.id AND banned_user_id = ?), 0
        ) as is_banned
      FROM communities c
      LEFT JOIN users u ON c.creator_id = u.id
      LEFT JOIN community_stats cs ON c.id = cs.community_id
      WHERE 1=1
    `;
    
    const params = [userId, userId, userId];
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ò –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –ò –ø—É–±–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
    // –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —á–ª–µ–Ω
    query += ` AND (c.is_private = 0 OR c.id IN (
      SELECT community_id FROM community_members WHERE user_id = ?
    ))`;
    params.push(userId);
    
    if (category) {
      query += ` AND c.category = ?`;
      params.push(category);
    }
    
    if (search) {
      query += ` AND (c.name LIKE ? OR c.description LIKE ?)`;
      params.push(`%${search}%`, `%${search}%`);
    }
    
    if (sort === 'newest') {
      query += ` ORDER BY c.created_at DESC`;
    } else if (sort === 'members') {
      query += ` ORDER BY cs.members_count DESC`;
    } else if (sort === 'trending') {
      query += ` ORDER BY cs.posts_count DESC, cs.members_count DESC`;
    }
    
    query += ` LIMIT ? OFFSET ?`;
    params.push(parseInt(limit), parseInt(offset));
    
    db.query(query, params, (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      // –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
      let countQuery = `SELECT COUNT(*) as total FROM communities WHERE 1=1`;
      const countParams = [];
      
      // ‚úÖ –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è —Å—á–µ—Ç–∞
      countQuery += ` AND (is_private = 0 OR id IN (
        SELECT community_id FROM community_members WHERE user_id = ?
      ))`;
      countParams.push(userId);
      
      if (category) {
        countQuery += ` AND category = ?`;
        countParams.push(category);
      }
      
      if (search) {
        countQuery += ` AND (name LIKE ? OR description LIKE ?)`;
        countParams.push(`%${search}%`, `%${search}%`);
      }
      
      db.query(countQuery, countParams, (err, countResults) => {
        res.json({
          success: true,
          data: results || [],
          total: countResults?.[0]?.total || 0,
          limit: parseInt(limit),
          offset: parseInt(offset)
        });
      });
    });
  });

  // 2Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ú–û–ò –°–û–û–ë–©–ï–°–¢–í–ê
  // 2Ô∏è‚É£ –ú–û–ò –°–û–û–ë–©–ï–°–¢–í–ê - –ò–°–ü–†–ê–í–õ–ï–ù–û (–¥–æ–±–∞–≤–ª–µ–Ω views_count)
  app.get('/api/communities/my', authenticateToken, (req, res) => {
    const userId = req.user.id;
    
    console.log(`\n${'='.repeat(70)}`);
    console.log(`üìã –ú–û–ò –°–û–û–ë–©–ï–°–¢–í–ê`);
    console.log(`   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}`);
    console.log(`${'='.repeat(70)}`);
    
    const query = `
      SELECT 
        c.*,
        u.username as creator_username,
        u.avatar as creator_avatar,
        COALESCE(cs.members_count, 0) as members_count,
        COALESCE(cs.posts_count, 0) as posts_count,
        COALESCE(cs.followers_count, 0) as followers_count,
        COALESCE(cs.views_count, 0) as views_count,
        cm.role as my_role
      FROM communities c
      JOIN community_members cm ON c.id = cm.community_id
      LEFT JOIN users u ON c.creator_id = u.id
      LEFT JOIN community_stats cs ON c.id = cs.community_id
      WHERE cm.user_id = ?
      ORDER BY cm.joined_at DESC
    `;
    
    db.query(query, [userId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–∏—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${results.length} —Å–æ–æ–±—â–µ—Å—Ç–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`);
      console.log(`${'='.repeat(70)}\n`);
      
      res.json({
        success: true,
        data: results || []
      });
    });
  });

  // 3Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –î–ï–¢–ê–õ–¨ –°–û–û–ë–©–ï–°–¢–í–ê - –ò–°–ü–†–ê–í–õ–ï–ù–û (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + views_count)
  app.get('/api/communities/:communityId', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const userId = req.user.id;
    
    console.log(`\n${'='.repeat(70)}`);
    console.log(`üìñ –î–ï–¢–ê–õ–¨ –°–û–û–ë–©–ï–°–¢–í–ê`);
    console.log(`   ID: ${communityId}`);
    console.log(`   –ó—Ä–∏—Ç–µ–ª—å: ${userId}`);
    console.log(`${'='.repeat(70)}`);
    
    const query = `
      SELECT 
        c.*,
        u.username as creator_username,
        u.avatar as creator_avatar,
        COALESCE(cs.members_count, 0) as members_count,
        COALESCE(cs.posts_count, 0) as posts_count,
        COALESCE(cs.followers_count, 0) as followers_count,
        COALESCE(cs.views_count, 0) as views_count,
        EXISTS(
          SELECT 1 FROM community_members 
          WHERE community_id = c.id AND user_id = ?
        ) as is_member,
        EXISTS(
          SELECT 1 FROM community_followers 
          WHERE community_id = c.id AND user_id = ?
        ) as is_following,
        EXISTS(
          SELECT 1 FROM community_bans 
          WHERE community_id = c.id AND banned_user_id = ?
        ) as is_banned
      FROM communities c
      LEFT JOIN users u ON c.creator_id = u.id
      LEFT JOIN community_stats cs ON c.id = cs.community_id
      WHERE c.id = ?
    `;
    
    db.query(query, [userId, userId, userId, communityId], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      if (!results || results.length === 0) {
        console.warn(`‚ö†Ô∏è –°–æ–æ–±—â–µ—Å—Ç–≤–æ ${communityId} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
        return res.status(404).json({ error: '–°–æ–æ–±—â–µ—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
      }
      
      const community = results[0];
      
      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
      db.query(
        `INSERT INTO community_stats (community_id, views_count) VALUES (?, 1)
        ON DUPLICATE KEY UPDATE views_count = views_count + 1`,
        [communityId]
      );
      
      console.log(`‚úÖ –°–æ–æ–±—â–µ—Å—Ç–≤–æ: ${community.name}`);
      console.log(`   –ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ${community.views_count}`);
      console.log(`   –ß–ª–µ–Ω–æ–≤: ${community.members_count}`);
      console.log(`${'='.repeat(70)}\n`);
      
      res.json({
        success: true,
        data: community
      });
    });
  });

  // 4Ô∏è‚É£ –°–û–ó–î–ê–¢–¨ –°–û–û–ë–©–ï–°–¢–í–û
  // 4Ô∏è‚É£ –°–û–ó–î–ê–¢–¨ –°–û–û–ë–©–ï–°–¢–í–û - –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û
  app.post('/api/communities', authenticateToken, (req, res) => {
    const { name, description, category = 'General', image, banner_image, rules, is_private = false } = req.body;
    const userId = req.user.id;
    
    console.log(`\n${'='.repeat(70)}`);
    console.log(`üÜï –°–û–ó–î–ê–ù–ò–ï –°–û–û–ë–©–ï–°–¢–í–ê`);
    console.log(`   –ù–∞–∑–≤–∞–Ω–∏–µ: ${name}`);
    console.log(`   –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}`);
    console.log(`   –ü—Ä–∏–≤–∞—Ç–Ω–æ–µ: ${is_private}`);
    console.log(`   –°–æ–∑–¥–∞—Ç–µ–ª—å: ${userId}`);
    console.log(`${'='.repeat(70)}`);
    
    if (!name || name.trim().length === 0) {
      return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    }
    
    if (name.length > 100) {
      return res.status(400).json({ error: '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 —Å–∏–º–≤–æ–ª–æ–≤' });
    }
    
    // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
    db.query(
      `INSERT INTO communities (name, description, category, creator_id, image, banner_image, rules, is_private) 
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
      [name, description || null, category, userId, image || null, banner_image || null, rules || null, is_private ? 1 : 0],
      (err, result) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', details: err.message });
        }
        
        const communityId = result.insertId;
        console.log(`‚úÖ –°–æ–æ–±—â–µ—Å—Ç–≤–æ ${communityId} —Å–æ–∑–¥–∞–Ω–æ –≤ –ë–î`);
        
        // –®–∞–≥ 1: –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–∞–∫ admin
        db.query(
          `INSERT INTO community_members (community_id, user_id, role) VALUES (?, ?, 'admin')`,
          [communityId, userId],
          (memberErr) => {
            if (memberErr) {
              console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—Ç–µ–ª—è –≤ —á–ª–µ–Ω—ã:', memberErr);
            } else {
              console.log(`‚úÖ –°–æ–∑–¥–∞—Ç–µ–ª—å ${userId} –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ admin`);
            }
            
            // –®–∞–≥ 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É - –ò–°–ü–†–ê–í–õ–ï–ù–û (–ø–æ–ª–Ω—ã–µ –ø–æ–ª—è)
            db.query(
              `INSERT INTO community_stats (community_id, members_count, posts_count, followers_count, views_count) 
              VALUES (?, 1, 0, 0, 0)
              ON DUPLICATE KEY UPDATE members_count = 1`,
              [communityId],
              (statsErr) => {
                if (statsErr) {
                  console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', statsErr);
                } else {
                  console.log(`‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ ${communityId} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞`);
                }
                
                // –®–∞–≥ 3: –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
                db.query(
                  `SELECT 
                    c.*,
                    u.username as creator_username,
                    u.avatar as creator_avatar,
                    COALESCE(cs.members_count, 1) as members_count,
                    COALESCE(cs.posts_count, 0) as posts_count,
                    COALESCE(cs.followers_count, 0) as followers_count,
                    COALESCE(cs.views_count, 0) as views_count,
                    1 as is_member,
                    0 as is_following,
                    0 as is_banned
                  FROM communities c
                  LEFT JOIN users u ON c.creator_id = u.id
                  LEFT JOIN community_stats cs ON c.id = cs.community_id
                  WHERE c.id = ?`,
                  [communityId],
                  (fetchErr, communities) => {
                    if (fetchErr) {
                      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:', fetchErr);
                      return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                    }
                    
                    if (!communities || communities.length === 0) {
                      console.error('‚ùå –°–æ–æ–±—â–µ—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è');
                      return res.status(500).json({ error: '–û—à–∏–±–∫–∞: —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
                    }
                    
                    const community = communities[0];
                    
                    console.log(`‚úÖ –ü–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ ${communityId} –∑–∞–≥—Ä—É–∂–µ–Ω—ã`);
                    console.log(`   –ò–º—è: ${community.name}`);
                    console.log(`   –°–æ–∑–¥–∞—Ç–µ–ª—å: ${community.creator_username}`);
                    console.log(`${'='.repeat(70)}\n`);
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Socket.io
                    io.emit('community_created', {
                      community_id: communityId,
                      name: name,
                      creator_id: userId,
                      created_at: new Date()
                    });
                    
                    // ‚úÖ –ì–õ–ê–í–ù–û–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
                    res.json({
                      success: true,
                      message: '–°–æ–æ–±—â–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–æ',
                      community_id: communityId,
                      data: community
                    });
                  }
                );
              }
            );
          }
        );
      }
    );
  });

  // 5Ô∏è‚É£ –û–ë–ù–û–í–ò–¢–¨ –°–û–û–ë–©–ï–°–¢–í–û (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
  app.put('/api/communities/:communityId', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const { name, description, category, image, banner_image, rules } = req.body;
    const userId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
    db.query(
      `SELECT role FROM community_members WHERE community_id = ? AND user_id = ?`,
      [communityId, userId],
      (err, results) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (!results || results.length === 0 || results[0].role === 'member') {
          return res.status(403).json({ error: '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ' });
        }
        
        const updateData = {};
        if (name) updateData.name = name;
        if (description) updateData.description = description;
        if (category) updateData.category = category;
        if (image) updateData.image = image;
        if (banner_image) updateData.banner_image = banner_image;
        if (rules) updateData.rules = rules;
        
        db.query(
          `UPDATE communities SET ? WHERE id = ?`,
          [updateData, communityId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –°–æ–æ–±—â–µ—Å—Ç–≤–æ ${communityId} –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–æ–º ${userId}`);
            
            res.json({
              success: true,
              message: '–°–æ–æ–±—â–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ'
            });
          }
        );
      }
    );
  });

  // 6Ô∏è‚É£ –£–î–ê–õ–ò–¢–¨ –°–û–û–ë–©–ï–°–¢–í–û (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å)
  app.delete('/api/communities/:communityId', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const userId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º
    db.query(
      `SELECT creator_id FROM communities WHERE id = ?`,
      [communityId],
      (err, results) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–∑–¥–∞—Ç–µ–ª—è:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (!results || results.length === 0) {
          return res.status(404).json({ error: '–°–æ–æ–±—â–µ—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' });
        }
        
        if (results[0].creator_id !== userId) {
          return res.status(403).json({ error: '–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ' });
        }
        
        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–æ (–∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ FOREIGN KEY)
        db.query(
          `DELETE FROM communities WHERE id = ?`,
          [communityId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –°–æ–æ–±—â–µ—Å—Ç–≤–æ ${communityId} —É–¥–∞–ª–µ–Ω–æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º ${userId}`);
            
            res.json({
              success: true,
              message: '–°–æ–æ–±—â–µ—Å—Ç–≤–æ —É–¥–∞–ª–µ–Ω–æ'
            });
          }
        );
      }
    );
  });

  // ============================================
  // –ß–õ–ï–ù–°–¢–í–û –í –°–û–û–ë–©–ï–°–¢–í–ê–•
  // ============================================

  // 7Ô∏è‚É£ –ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø –ö –°–û–û–ë–©–ï–°–¢–í–£
  // 5Ô∏è‚É£ –ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø –ö –°–û–û–ë–©–ï–°–¢–í–£ - –ò–°–ü–†–ê–í–õ–ï–ù–û (–±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
  app.post('/api/communities/:communityId/join', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const userId = req.user.id;
    
    console.log(`\n${'='.repeat(70)}`);
    console.log(`üîó –ü–†–ò–°–û–ï–î–ò–ù–ï–ù–ò–ï –ö –°–û–û–ë–©–ï–°–¢–í–£`);
    console.log(`   –°–æ–æ–±—â–µ—Å—Ç–≤–æ: ${communityId}`);
    console.log(`   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}`);
    console.log(`${'='.repeat(70)}`);
    
    // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–∞–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    db.query(
      `SELECT * FROM community_bans WHERE community_id = ? AND banned_user_id = ?`,
      [communityId, userId],
      (err, banResults) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (banResults && banResults.length > 0) {
          const ban = banResults[0];
          const isActive = !ban.banned_until || new Date() < new Date(ban.banned_until);
          
          if (isActive) {
            console.warn(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –∑–∞–±–∞–Ω–µ–Ω –¥–æ ${ban.banned_until}`);
            return res.status(403).json({ 
              error: '–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ —ç—Ç–æ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ',
              reason: ban.reason,
              banned_until: ban.banned_until
            });
          } else {
            console.log(`‚úÖ –ë–∞–Ω –∏—Å—Ç—ë–∫, –ø–æ–∑–≤–æ–ª—è–µ–º –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è`);
          }
        }
        
        // –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —á–ª–µ–Ω –ª–∏ —É–∂–µ
        db.query(
          `SELECT id FROM community_members WHERE community_id = ? AND user_id = ?`,
          [communityId, userId],
          (err, memberResults) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–ª–µ–Ω—Å—Ç–≤–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            if (memberResults && memberResults.length > 0) {
              console.warn(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ ${communityId}`);
              return res.status(400).json({ error: '–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ —ç—Ç–æ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ' });
            }
            
            // –®–∞–≥ 3: –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
            db.query(
              `INSERT INTO community_members (community_id, user_id) VALUES (?, ?)`,
              [communityId, userId],
              (err) => {
                if (err) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', err);
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                }
                
                console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–ª–µ–Ω—ã`);
                
                // –®–∞–≥ 4: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (members_count)
                db.query(
                  `INSERT INTO community_stats (community_id, members_count) VALUES (?, 1)
                  ON DUPLICATE KEY UPDATE members_count = members_count + 1`,
                  [communityId],
                  (statErr) => {
                    if (statErr) {
                      console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', statErr);
                    } else {
                      console.log(`‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
                    }
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Socket.io
                    io.emit('user_joined_community', {
                      community_id: communityId,
                      user_id: userId,
                      joined_at: new Date()
                    });
                    
                    console.log(`${'='.repeat(70)}\n`);
                    
                    res.json({
                      success: true,
                      message: '–í—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É'
                    });
                  }
                );
              }
            );
          }
        );
      }
    );
  });

  // 6Ô∏è‚É£ –í–´–ô–¢–ò –ò–ó –°–û–û–ë–©–ï–°–¢–í–ê - –ò–°–ü–†–ê–í–õ–ï–ù–û (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ + stats update)
  app.post('/api/communities/:communityId/leave', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const userId = req.user.id;
    
    console.log(`\n${'='.repeat(70)}`);
    console.log(`‚ùå –í–´–•–û–î –ò–ó –°–û–û–ë–©–ï–°–¢–í–ê`);
    console.log(`   –°–æ–æ–±—â–µ—Å—Ç–≤–æ: ${communityId}`);
    console.log(`   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}`);
    console.log(`${'='.repeat(70)}`);
    
    // –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–æ–≤
    db.query(
      `SELECT COUNT(*) as admin_count FROM community_members 
      WHERE community_id = ? AND role = 'admin'`,
      [communityId],
      (err, adminResults) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–æ–≤:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const adminCount = adminResults[0].admin_count;
        console.log(`üìä –ê–¥–º–∏–Ω–æ–≤ –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ: ${adminCount}`);
        
        if (adminCount === 1) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∞–¥–º–∏–Ω–æ–º
          db.query(
            `SELECT role FROM community_members WHERE community_id = ? AND user_id = ?`,
            [communityId, userId],
            (err, roleResults) => {
              if (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏:', err);
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }
              
              if (roleResults && roleResults.length > 0 && roleResults[0].role === 'admin') {
                console.warn(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–¥–º–∏–Ω`);
                return res.status(400).json({ 
                  error: '–í—ã –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∑–Ω–∞—á—å—Ç–µ –¥—Ä—É–≥–æ–≥–æ –∞–¥–º–∏–Ω–∞ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º' 
                });
              }
              
              removeUserFromCommunity();
            }
          );
        } else {
          removeUserFromCommunity();
        }
        
        function removeUserFromCommunity() {
          db.query(
            `DELETE FROM community_members WHERE community_id = ? AND user_id = ?`,
            [communityId, userId],
            (err) => {
              if (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ —á–ª–µ–Ω–æ–≤:', err);
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }
              
              console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–¥–∞–ª—ë–Ω –∏–∑ —á–ª–µ–Ω–æ–≤`);
              
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (members_count)
              db.query(
                `UPDATE community_stats 
                SET members_count = GREATEST(0, members_count - 1) 
                WHERE community_id = ?`,
                [communityId],
                (statErr) => {
                  if (statErr) {
                    console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', statErr);
                  } else {
                    console.log(`‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (members_count -1)`);
                  }
                  
                  io.emit('user_left_community', {
                    community_id: communityId,
                    user_id: userId,
                    left_at: new Date()
                  });
                  
                  console.log(`${'='.repeat(70)}\n`);
                  
                  res.json({
                    success: true,
                    message: '–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞'
                  });
                }
              );
            }
          );
        }
      }
    );
  });

  // 9Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ß–õ–ï–ù–û–í –°–û–û–ë–©–ï–°–¢–í–ê
  app.get('/api/communities/:communityId/members', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const { role = null } = req.query;
    
    let query = `
      SELECT 
        u.id,
        u.username,
        u.avatar,
        u.status,
        cm.role,
        cm.joined_at
      FROM community_members cm
      JOIN users u ON cm.user_id = u.id
      WHERE cm.community_id = ?
    `;
    
    const params = [communityId];
    
    if (role) {
      query += ` AND cm.role = ?`;
      params.push(role);
    }
    
    query += ` ORDER BY 
      CASE cm.role
        WHEN 'admin' THEN 1
        WHEN 'moderator' THEN 2
        ELSE 3
      END,
      cm.joined_at DESC`;
    
    db.query(query, params, (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–ª–µ–Ω–æ–≤:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json({
        success: true,
        data: results || [],
        total: results?.length || 0
      });
    });
  });

  // üîü –ò–ó–ú–ï–ù–ò–¢–¨ –†–û–õ–¨ –ß–õ–ï–ù–ê (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
  app.put('/api/communities/:communityId/members/:userId/role', authenticateToken, (req, res) => {
    const { communityId, userId } = req.params;
    const { role } = req.body;
    const adminId = req.user.id;
    
    if (!['member', 'moderator', 'admin'].includes(role)) {
      return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω–∞—è —Ä–æ–ª—å' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    db.query(
      `SELECT role FROM community_members WHERE community_id = ? AND user_id = ?`,
      [communityId, adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || adminResults[0].role !== 'admin') {
          return res.status(403).json({ error: '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —Ä–æ–ª–∏' });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å
        db.query(
          `UPDATE community_members SET role = ? WHERE community_id = ? AND user_id = ?`,
          [role, communityId, userId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId} –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ ${role} –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ ${communityId}`);
            
            res.json({
              success: true,
              message: `–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${role}`
            });
          }
        );
      }
    );
  });

  // 1Ô∏è‚É£1Ô∏è‚É£ –í–´–ì–ù–ê–¢–¨ –ß–õ–ï–ù–ê –ò–ó –°–û–û–ë–©–ï–°–¢–í–ê (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
  app.delete('/api/communities/:communityId/members/:userId', authenticateToken, (req, res) => {
    const { communityId, userId } = req.params;
    const adminId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    db.query(
      `SELECT role FROM community_members WHERE community_id = ? AND user_id = ?`,
      [communityId, adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || adminResults[0].role !== 'admin') {
          return res.status(403).json({ error: '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –≤—ã–≥–æ–Ω—è—Ç—å —á–ª–µ–Ω–æ–≤' });
        }
        
        // –£–¥–∞–ª—è–µ–º —á–ª–µ–Ω–∞
        db.query(
          `DELETE FROM community_members WHERE community_id = ? AND user_id = ?`,
          [communityId, userId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–ª–µ–Ω–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} —É–¥–∞–ª–µ–Ω –∏–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ ${communityId} –∞–¥–º–∏–Ω–æ–º ${adminId}`);
            
            res.json({
              success: true,
              message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞'
            });
          }
        );
      }
    );
  });

  // ============================================
  // –ü–û–°–¢–´ –°–û–û–ë–©–ï–°–¢–í
  // ============================================

  // 1Ô∏è‚É£2Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ü–û–°–¢–´ –°–û–û–ë–©–ï–°–¢–í–ê
  app.get('/api/communities/:communityId/posts', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const { limit = 20, offset = 0 } = req.query;
    const userId = req.user.id;
    
    const query = `
      SELECT 
        cp.*,
        u.username as author_username,
        u.avatar as author_avatar,
        COUNT(DISTINCT cpl.id) as likes_count,
        COUNT(DISTINCT cpc.id) as comments_count,
        EXISTS(
          SELECT 1 FROM community_post_likes 
          WHERE post_id = cp.id AND user_id = ?
        ) as is_liked
      FROM community_posts cp
      JOIN users u ON cp.author_id = u.id
      LEFT JOIN community_post_likes cpl ON cp.id = cpl.post_id
      LEFT JOIN community_post_comments cpc ON cp.id = cpc.post_id
      WHERE cp.community_id = ?
      GROUP BY cp.id
      ORDER BY cp.is_pinned DESC, cp.created_at DESC
      LIMIT ? OFFSET ?
    `;
    
    db.query(query, [userId, communityId, parseInt(limit), parseInt(offset)], (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json({
        success: true,
        data: results || [],
        limit: parseInt(limit),
        offset: parseInt(offset)
      });
    });
  });

  // 1Ô∏è‚É£3Ô∏è‚É£ –°–û–ó–î–ê–¢–¨ –ü–û–°–¢ –í –°–û–û–ë–©–ï–°–¢–í–ï
  app.post('/api/communities/:communityId/posts', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const { title, content, image } = req.body;
    const userId = req.user.id;
    
    if (!content || content.trim().length === 0) {
      return res.status(400).json({ error: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á–ª–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
    db.query(
      `SELECT id FROM community_members WHERE community_id = ? AND user_id = ?`,
      [communityId, userId],
      (err, memberResults) => {
        if (err || !memberResults || memberResults.length === 0) {
          return res.status(403).json({ error: '–í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–ª–µ–Ω–æ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ —á—Ç–æ–±—ã –ø–æ—Å—Ç–∏—Ç—å' });
        }
        
        // –°–æ–∑–¥–∞–µ–º –ø–æ—Å—Ç
        db.query(
          `INSERT INTO community_posts (community_id, author_id, title, content, image) 
          VALUES (?, ?, ?, ?, ?)`,
          [communityId, userId, title || null, content, image || null],
          (err, result) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            const postId = result.insertId;
            
            console.log(`‚úÖ –ü–æ—Å—Ç ${postId} —Å–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId} –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ ${communityId}`);
            
            io.emit('community_post_created', {
              community_id: communityId,
              post_id: postId,
              author_id: userId
            });
            
            res.json({
              success: true,
              message: '–ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω',
              post_id: postId
            });
          }
        );
      }
    );
  });

  // 1Ô∏è‚É£4Ô∏è‚É£ –£–î–ê–õ–ò–¢–¨ –ü–û–°–¢ (–∞–≤—Ç–æ—Ä –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
  app.delete('/api/communities/:communityId/posts/:postId', authenticateToken, (req, res) => {
    const { communityId, postId } = req.params;
    const userId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
    db.query(
      `SELECT cp.author_id, cm.role FROM community_posts cp
      LEFT JOIN community_members cm ON cp.community_id = cm.community_id AND cm.user_id = ?
      WHERE cp.id = ? AND cp.community_id = ?`,
      [userId, postId, communityId],
      (err, results) => {
        if (err || !results || results.length === 0) {
          return res.status(404).json({ error: '–ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
        }
        
        const { author_id, role } = results[0];
        
        if (author_id !== userId && role !== 'admin' && role !== 'moderator') {
          return res.status(403).json({ error: '–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç' });
        }
        
        // –£–¥–∞–ª—è–µ–º –ø–æ—Å—Ç
        db.query(
          `DELETE FROM community_posts WHERE id = ?`,
          [postId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –ü–æ—Å—Ç ${postId} —É–¥–∞–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId}`);
            
            res.json({
              success: true,
              message: '–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω'
            });
          }
        );
      }
    );
  });

  // 1Ô∏è‚É£5Ô∏è‚É£ –õ–ê–ô–ö –ù–ê –ü–û–°–¢
  app.post('/api/communities/:communityId/posts/:postId/like', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const userId = req.user.id;
    
    db.query(
      `SELECT id FROM community_post_likes WHERE post_id = ? AND user_id = ?`,
      [postId, userId],
      (err, results) => {
        if (err) {
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (results && results.length > 0) {
          // –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫
          db.query(
            `DELETE FROM community_post_likes WHERE post_id = ? AND user_id = ?`,
            [postId, userId],
            (err) => {
              if (err) {
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }
              
              res.json({ success: true, liked: false });
            }
          );
        } else {
          // –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–π–∫
          db.query(
            `INSERT INTO community_post_likes (post_id, user_id) VALUES (?, ?)`,
            [postId, userId],
            (err) => {
              if (err) {
                return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
              }
              
              res.json({ success: true, liked: true });
            }
          );
        }
      }
    );
  });

  // 1Ô∏è‚É£6Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ü–û–°–¢–ê
  app.get('/api/communities/:communityId/posts/:postId/comments', authenticateToken, (req, res) => {
    const { postId } = req.params;
    
    const query = `
      SELECT 
        cpc.*,
        u.username,
        u.avatar
      FROM community_post_comments cpc
      JOIN users u ON cpc.author_id = u.id
      WHERE cpc.post_id = ?
      ORDER BY cpc.created_at ASC
    `;
    
    db.query(query, [postId], (err, results) => {
      if (err) {
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json({
        success: true,
        data: results || []
      });
    });
  });

  // 1Ô∏è‚É£7Ô∏è‚É£ –î–û–ë–ê–í–ò–¢–¨ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô
  app.post('/api/communities/:communityId/posts/:postId/comments', authenticateToken, (req, res) => {
    const { postId } = req.params;
    const { content } = req.body;
    const userId = req.user.id;
    
    if (!content || content.trim().length === 0) {
      return res.status(400).json({ error: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º' });
    }
    
    db.query(
      `INSERT INTO community_post_comments (post_id, author_id, content) VALUES (?, ?, ?)`,
      [postId, userId, content],
      (err, result) => {
        if (err) {
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        res.json({
          success: true,
          comment_id: result.insertId
        });
      }
    );
  });

  // ============================================
  // –ë–õ–û–ö–ò–†–û–í–ö–ê –í –°–û–û–ë–©–ï–°–¢–í–ê–•
  // ============================================

  // 1Ô∏è‚É£8Ô∏è‚É£ –ó–ê–ë–ê–ù–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –í –°–û–û–ë–©–ï–°–¢–í–ï
  app.post('/api/communities/:communityId/ban', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const { user_id, reason = '', ban_duration_days = null } = req.body;
    const adminId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    db.query(
      `SELECT role FROM community_members WHERE community_id = ? AND user_id = ?`,
      [communityId, adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || adminResults[0].role !== 'admin') {
          return res.status(403).json({ error: '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –±–∞–Ω–∏—Ç—å' });
        }
        
        let banned_until = null;
        if (ban_duration_days && ban_duration_days > 0) {
          const now = new Date();
          banned_until = new Date(now.getTime() + ban_duration_days * 24 * 60 * 60 * 1000);
        }
        
        db.query(
          `INSERT INTO community_bans (community_id, banned_user_id, banned_by, reason, ban_duration_days, banned_until) 
          VALUES (?, ?, ?, ?, ?, ?)
          ON DUPLICATE KEY UPDATE 
            reason = VALUES(reason),
            banned_until = VALUES(banned_until)`,
          [communityId, user_id, adminId, reason, ban_duration_days, banned_until],
          (err) => {
            if (err) {
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
            db.query(
              `DELETE FROM community_members WHERE community_id = ? AND user_id = ?`,
              [communityId, user_id]
            );
            
            console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user_id} –∑–∞–±–∞–Ω–µ–Ω –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ ${communityId}`);
            
            res.json({ success: true, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω' });
          }
        );
      }
    );
  });

  // 1Ô∏è‚É£9Ô∏è‚É£ –†–ê–ó–ë–ê–ù–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
  app.post('/api/communities/:communityId/unban', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const { user_id } = req.body;
    const adminId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞
    db.query(
      `SELECT role FROM community_members WHERE community_id = ? AND user_id = ?`,
      [communityId, adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || adminResults[0].role !== 'admin') {
          return res.status(403).json({ error: '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Ä–∞–∑–±–∞–Ω–∏—Ç—å' });
        }
        
        db.query(
          `DELETE FROM community_bans WHERE community_id = ? AND banned_user_id = ?`,
          [communityId, user_id],
          (err) => {
            if (err) {
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user_id} —Ä–∞–∑–±–∞–Ω–µ–Ω –≤ —Å–æ–æ–±—â–µ—Å—Ç–≤–µ ${communityId}`);
            
            res.json({ success: true, message: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω' });
          }
        );
      }
    );
  });

  // ============================================
  // –ü–û–ò–°–ö –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
  // ============================================

  // 2Ô∏è‚É£0Ô∏è‚É£ –ü–û–ò–°–ö –°–û–û–ë–©–ï–°–¢–í
  app.get('/api/communities/search', authenticateToken, (req, res) => {
    const { q, limit = 10 } = req.query;
    
    if (!q || q.trim().length < 2) {
      return res.status(400).json({ error: '–ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞' });
    }
    
    const query = `
      SELECT 
        c.*,
        cs.members_count
      FROM communities c
      LEFT JOIN community_stats cs ON c.id = cs.community_id
      WHERE c.is_private = FALSE AND (c.name LIKE ? OR c.description LIKE ?)
      ORDER BY cs.members_count DESC
      LIMIT ?
    `;
    
    db.query(query, [`%${q}%`, `%${q}%`, parseInt(limit)], (err, results) => {
      if (err) {
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json({
        success: true,
        data: results || []
      });
    });
  });

  // 2Ô∏è‚É£1Ô∏è‚É£ –ü–û–ü–£–õ–Ø–†–ù–´–ï –°–û–û–ë–©–ï–°–¢–í–ê
  app.get('/api/communities/trending', authenticateToken, (req, res) => {
    const { limit = 10 } = req.query;
    const userId = req.user.id;
    
    const query = `
      SELECT 
        c.*,
        cs.members_count,
        cs.posts_count,
        EXISTS(
          SELECT 1 FROM community_members 
          WHERE community_id = c.id AND user_id = ?
        ) as is_member
      FROM communities c
      LEFT JOIN community_stats cs ON c.id = cs.community_id
      WHERE c.is_private = FALSE
      ORDER BY cs.members_count DESC, cs.posts_count DESC
      LIMIT ?
    `;
    
    db.query(query, [userId, parseInt(limit)], (err, results) => {
      if (err) {
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json({
        success: true,
        data: results || []
      });
    });
  });

  // 2Ô∏è‚É£2Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–ò
  app.get('/api/communities/categories', authenticateToken, (req, res) => {
    db.query(`SELECT * FROM community_categories ORDER BY name ASC`, (err, results) => {
      if (err) {
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json({
        success: true,
        data: results || []
      });
    });
  });

  // ============================================
  // –ü–û–î–ü–ò–°–ö–ò –ù–ê –°–û–û–ë–©–ï–°–¢–í–ê
  // ============================================

  // 2Ô∏è‚É£3Ô∏è‚É£ –ü–û–î–ü–ò–°–ê–¢–¨–°–Ø –ù–ê –°–û–û–ë–©–ï–°–¢–í–û
  app.post('/api/communities/:communityId/follow', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const userId = req.user.id;
    
    db.query(
      `INSERT INTO community_followers (community_id, user_id) VALUES (?, ?)
      ON DUPLICATE KEY UPDATE followed_at = NOW()`,
      [communityId, userId],
      (err) => {
        if (err) {
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        res.json({ success: true, message: '–í—ã –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å' });
      }
    );
  });

  // 2Ô∏è‚É£4Ô∏è‚É£ –û–¢–ü–ò–°–ê–¢–¨–°–Ø –û–¢ –°–û–û–ë–©–ï–°–¢–í–ê
  app.delete('/api/communities/:communityId/follow', authenticateToken, (req, res) => {
    const { communityId } = req.params;
    const userId = req.user.id;
    
    db.query(
      `DELETE FROM community_followers WHERE community_id = ? AND user_id = ?`,
      [communityId, userId],
      (err) => {
        if (err) {
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        res.json({ success: true, message: '–í—ã –æ—Ç–ø–∏—Å–∞–ª–∏—Å—å' });
      }
    );
  });

  // ============================================
  // üÜò SUPPORT SYSTEM ENDPOINTS
  // ============================================

  // 1Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –í–°–ï –ö–ê–¢–ï–ì–û–†–ò–ò –ü–û–î–î–ï–†–ñ–ö–ò
  app.get('/api/support/categories', authenticateToken, (req, res) => {
    db.query(
      'SELECT * FROM support_categories ORDER BY name ASC',
      (err, results) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        res.json({
          success: true,
          data: results || []
        });
      }
    );
  });

  // 2Ô∏è‚É£ –°–û–ó–î–ê–¢–¨ –¢–ò–ö–ï–¢ –ü–û–î–î–ï–†–ñ–ö–ò
  app.post('/api/support/tickets', authenticateToken, (req, res) => {
    const { subject, message, category = 'general', priority = 'medium' } = req.body;
    const userId = req.user.id;
    
    if (!subject || subject.trim().length === 0) {
      return res.status(400).json({ error: '–¢–µ–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞' });
    }
    
    if (!message || message.trim().length === 0) {
      return res.status(400).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    }
    
    if (subject.length > 255) {
      return res.status(400).json({ error: '–¢–µ–º–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 255 —Å–∏–º–≤–æ–ª–æ–≤' });
    }
    
    if (message.length > 5000) {
      return res.status(400).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 5000 —Å–∏–º–≤–æ–ª–æ–≤' });
    }
    
    db.query(
      `INSERT INTO support_tickets (user_id, subject, message, category, priority) 
      VALUES (?, ?, ?, ?, ?)`,
      [userId, subject.trim(), message.trim(), category, priority],
      (err, result) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        const ticketId = result.insertId;
        
        console.log(`‚úÖ –¢–∏–∫–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ #${ticketId} —Å–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${userId}`);
        console.log(`   –¢–µ–º–∞: ${subject}`);
        console.log(`   –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${category}`);
        console.log(`   –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${priority}`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
        io.emit('support_ticket_created', {
          ticket_id: ticketId,
          user_id: userId,
          subject,
          category,
          priority,
          created_at: new Date()
        });
        
        res.json({
          success: true,
          message: '–¢–∏–∫–µ—Ç —Å–æ–∑–¥–∞–Ω. –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!',
          ticket_id: ticketId
        });
      }
    );
  });

  // 3Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –ú–û–ò –¢–ò–ö–ï–¢–´
  app.get('/api/support/tickets', authenticateToken, (req, res) => {
    const userId = req.user.id;
    const { status = null, limit = 20, offset = 0 } = req.query;
    
    let query = `
      SELECT 
        st.*,
        u.username,
        u.avatar,
        (SELECT COUNT(*) FROM support_replies WHERE ticket_id = st.id) as replies_count,
        (SELECT MAX(created_at) FROM support_replies WHERE ticket_id = st.id) as last_reply_at
      FROM support_tickets st
      JOIN users u ON st.user_id = u.id
      WHERE st.user_id = ?
    `;
    
    const params = [userId];
    
    if (status) {
      query += ` AND st.status = ?`;
      params.push(status);
    }
    
    query += ` ORDER BY st.created_at DESC LIMIT ? OFFSET ?`;
    params.push(parseInt(limit), parseInt(offset));
    
    db.query(query, params, (err, results) => {
      if (err) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤:', err);
        return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
      }
      
      res.json({
        success: true,
        data: results || [],
        limit: parseInt(limit),
        offset: parseInt(offset)
      });
    });
  });

  // 4Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –î–ï–¢–ê–õ–¨ –¢–ò–ö–ï–¢–ê
  app.get('/api/support/tickets/:ticketId', authenticateToken, (req, res) => {
    const { ticketId } = req.params;
    const userId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ—Ç—å —ç—Ç–æ—Ç —Ç–∏–∫–µ—Ç
    db.query(
      `SELECT st.*, u.username, u.avatar, u.email
      FROM support_tickets st
      JOIN users u ON st.user_id = u.id
      WHERE st.id = ? AND (st.user_id = ? OR ? IN (SELECT id FROM users WHERE is_admin = TRUE))`,
      [ticketId, userId, userId],
      (err, ticketResults) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–∞:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (!ticketResults || ticketResults.length === 0) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
        }
        
        const ticket = ticketResults[0];
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã
        db.query(
          `SELECT 
            sr.*,
            admin.username as admin_username,
            admin.avatar as admin_avatar
          FROM support_replies sr
          JOIN users admin ON sr.admin_id = admin.id
          WHERE sr.ticket_id = ?
          ORDER BY sr.created_at ASC`,
          [ticketId],
          (err, replies) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤:', err);
              replies = [];
            }
            
            // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
            db.query(
              `INSERT INTO support_ticket_read_status (ticket_id, user_id, is_read, read_at)
              VALUES (?, ?, TRUE, NOW())
              ON DUPLICATE KEY UPDATE is_read = TRUE, read_at = NOW()`,
              [ticketId, userId]
            );
            
            res.json({
              success: true,
              ticket: ticket,
              replies: replies || []
            });
          }
        );
      }
    );
  });

  // 5Ô∏è‚É£ –î–û–ë–ê–í–ò–¢–¨ –û–¢–í–ï–¢ –ù–ê –¢–ò–ö–ï–¢ (ADMIN)
  app.post('/api/support/tickets/:ticketId/reply', authenticateToken, (req, res) => {
    const { ticketId } = req.params;
    const { message } = req.body;
    const adminId = req.user.id;
    
    if (!message || message.trim().length === 0) {
      return res.status(400).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ' });
    }
    
    if (message.length > 5000) {
      return res.status(400).json({ error: '–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 5000 —Å–∏–º–≤–æ–ª–æ–≤' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query(
      'SELECT is_admin FROM users WHERE id = ?',
      [adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || !adminResults[0].is_admin) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞
        db.query(
          'SELECT user_id FROM support_tickets WHERE id = ?',
          [ticketId],
          (err, ticketResults) => {
            if (err || !ticketResults || ticketResults.length === 0) {
              return res.status(404).json({ error: '–¢–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
            }
            
            const userId = ticketResults[0].user_id;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
            db.query(
              `INSERT INTO support_replies (ticket_id, admin_id, message) VALUES (?, ?, ?)`,
              [ticketId, adminId, message.trim()],
              (err, result) => {
                if (err) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:', err);
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞ –Ω–∞ 'in_progress' –µ—Å–ª–∏ –æ–Ω –±—ã–ª 'open'
                db.query(
                  `UPDATE support_tickets SET status = 'in_progress', updated_at = NOW() 
                  WHERE id = ? AND status = 'open'`,
                  [ticketId]
                );
                
                console.log(`‚úÖ –û—Ç–≤–µ—Ç –Ω–∞ —Ç–∏–∫–µ—Ç #${ticketId} –¥–æ–±–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–æ–º ${adminId}`);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ Socket.io
                io.to(`user_${userId}`).emit('support_reply_received', {
                  ticket_id: ticketId,
                  admin_id: adminId,
                  message: message.substring(0, 100) + '...'
                });
                
                res.json({
                  success: true,
                  message: '–û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω',
                  reply_id: result.insertId
                });
              }
            );
          }
        );
      }
    );
  });

  // 6Ô∏è‚É£ –û–ë–ù–û–í–ò–¢–¨ –°–¢–ê–¢–£–° –¢–ò–ö–ï–¢–ê (ADMIN)
  app.patch('/api/support/tickets/:ticketId/status', authenticateToken, (req, res) => {
    const { ticketId } = req.params;
    const { status } = req.body;
    const adminId = req.user.id;
    
    if (!['open', 'in_progress', 'resolved', 'closed'].includes(status)) {
      return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Å—Ç–∞—Ç—É—Å' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query(
      'SELECT is_admin FROM users WHERE id = ?',
      [adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || !adminResults[0].is_admin) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–∫–µ—Ç–µ
        db.query(
          'SELECT user_id FROM support_tickets WHERE id = ?',
          [ticketId],
          (err, ticketResults) => {
            if (err || !ticketResults || ticketResults.length === 0) {
              return res.status(404).json({ error: '–¢–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' });
            }
            
            const userId = ticketResults[0].user_id;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            db.query(
              'UPDATE support_tickets SET status = ?, updated_at = NOW() WHERE id = ?',
              [status, ticketId],
              (err) => {
                if (err) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', err);
                  return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
                }
                
                console.log(`‚úÖ –°—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞ #${ticketId} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${status} –∞–¥–º–∏–Ω–æ–º ${adminId}`);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                io.to(`user_${userId}`).emit('support_ticket_status_changed', {
                  ticket_id: ticketId,
                  status: status
                });
                
                res.json({
                  success: true,
                  message: `–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${status}`
                });
              }
            );
          }
        );
      }
    );
  });

  // 7Ô∏è‚É£ –ò–ó–ú–ï–ù–ò–¢–¨ –ü–†–ò–û–†–ò–¢–ï–¢ –¢–ò–ö–ï–¢–ê (ADMIN)
  app.patch('/api/support/tickets/:ticketId/priority', authenticateToken, (req, res) => {
    const { ticketId } = req.params;
    const { priority } = req.body;
    const adminId = req.user.id;
    
    if (!['low', 'medium', 'high', 'critical'].includes(priority)) {
      return res.status(400).json({ error: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç' });
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query(
      'SELECT is_admin FROM users WHERE id = ?',
      [adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || !adminResults[0].is_admin) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
        }
        
        db.query(
          'UPDATE support_tickets SET priority = ?, updated_at = NOW() WHERE id = ?',
          [priority, ticketId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–∏–∫–µ—Ç–∞ #${ticketId} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${priority} –∞–¥–º–∏–Ω–æ–º ${adminId}`);
            
            res.json({
              success: true,
              message: `–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${priority}`
            });
          }
        );
      }
    );
  });

  // 8Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –í–°–ï –¢–ò–ö–ï–¢–´ (ADMIN)
  app.get('/api/admin/support/tickets', authenticateToken, (req, res) => {
    const adminId = req.user.id;
    const { status = null, priority = null, limit = 20, offset = 0 } = req.query;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query(
      'SELECT is_admin FROM users WHERE id = ?',
      [adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || !adminResults[0].is_admin) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
        }
        
        let query = `
          SELECT 
            st.*,
            u.username,
            u.avatar,
            u.email,
            (SELECT COUNT(*) FROM support_replies WHERE ticket_id = st.id) as replies_count,
            sc.name as category_name,
            sc.icon as category_icon
          FROM support_tickets st
          JOIN users u ON st.user_id = u.id
          LEFT JOIN support_categories sc ON st.category = sc.name
          WHERE 1=1
        `;
        
        const params = [];
        
        if (status) {
          query += ` AND st.status = ?`;
          params.push(status);
        }
        
        if (priority) {
          query += ` AND st.priority = ?`;
          params.push(priority);
        }
        
        query += ` ORDER BY 
          CASE st.priority
            WHEN 'critical' THEN 1
            WHEN 'high' THEN 2
            WHEN 'medium' THEN 3
            ELSE 4
          END,
          CASE st.status
            WHEN 'open' THEN 1
            WHEN 'in_progress' THEN 2
            WHEN 'resolved' THEN 3
            ELSE 4
          END,
          st.created_at ASC
        LIMIT ? OFFSET ?`;
        
        params.push(parseInt(limit), parseInt(offset));
        
        db.query(query, params, (err, results) => {
          if (err) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤:', err);
            return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
          }
          
          // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          db.query(
            `SELECT 
              COUNT(*) as total,
              SUM(CASE WHEN status = 'open' THEN 1 ELSE 0 END) as open_count,
              SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as in_progress_count,
              SUM(CASE WHEN status = 'resolved' THEN 1 ELSE 0 END) as resolved_count,
              SUM(CASE WHEN status = 'closed' THEN 1 ELSE 0 END) as closed_count,
              SUM(CASE WHEN priority = 'critical' THEN 1 ELSE 0 END) as critical_count
            FROM support_tickets`,
            (err, statsResults) => {
              res.json({
                success: true,
                data: results || [],
                stats: statsResults?.[0] || {},
                limit: parseInt(limit),
                offset: parseInt(offset)
              });
            }
          );
        });
      }
    );
  });

  // 9Ô∏è‚É£ –ü–û–õ–£–ß–ò–¢–¨ –°–¢–ê–¢–ò–°–¢–ò–ö–£ –ü–û–î–î–ï–†–ñ–ö–ò (ADMIN)
  app.get('/api/admin/support/statistics', authenticateToken, (req, res) => {
    const adminId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query(
      'SELECT is_admin FROM users WHERE id = ?',
      [adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || !adminResults[0].is_admin) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        db.query(
          `SELECT 
            COUNT(*) as total_tickets,
            SUM(CASE WHEN status = 'open' THEN 1 ELSE 0 END) as open_tickets,
            SUM(CASE WHEN status = 'in_progress' THEN 1 ELSE 0 END) as in_progress_tickets,
            SUM(CASE WHEN status = 'resolved' THEN 1 ELSE 0 END) as resolved_tickets,
            SUM(CASE WHEN status = 'closed' THEN 1 ELSE 0 END) as closed_tickets,
            SUM(CASE WHEN priority = 'critical' THEN 1 ELSE 0 END) as critical_tickets,
            SUM(CASE WHEN priority = 'high' THEN 1 ELSE 0 END) as high_tickets,
            SUM(CASE WHEN DATE(created_at) = CURDATE() THEN 1 ELSE 0 END) as tickets_today,
            SUM(CASE WHEN DATE(created_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY) THEN 1 ELSE 0 END) as tickets_yesterday,
            SUM(CASE WHEN DATE(created_at) >= DATE_SUB(CURDATE(), INTERVAL 7 DAY) THEN 1 ELSE 0 END) as tickets_this_week
          FROM support_tickets`,
          (err, stats) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            db.query(
              `SELECT 
                category,
                COUNT(*) as count,
                SUM(CASE WHEN status = 'open' THEN 1 ELSE 0 END) as open_count,
                SUM(CASE WHEN status = 'resolved' THEN 1 ELSE 0 END) as resolved_count
              FROM support_tickets
              GROUP BY category`,
              (err, categoryStats) => {
                res.json({
                  success: true,
                  overall: stats?.[0] || {},
                  by_category: categoryStats || []
                });
              }
            );
          }
        );
      }
    );
  });

  // üîü –ó–ê–ö–†–´–¢–¨ –¢–ò–ö–ï–¢ (ADMIN/USER)
  app.post('/api/support/tickets/:ticketId/close', authenticateToken, (req, res) => {
    const { ticketId } = req.params;
    const userId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç —Ç–∏–∫–µ—Ç
    db.query(
      `SELECT st.user_id, st.status, u.is_admin
      FROM support_tickets st
      JOIN users u ON u.id = ?
      WHERE st.id = ?`,
      [userId, ticketId],
      (err, results) => {
        if (err) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', err);
          return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
        }
        
        if (!results || results.length === 0) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
        }
        
        const { user_id, status, is_admin } = results[0];
        
        if (user_id !== userId && !is_admin) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω' });
        }
        
        if (status === 'closed') {
          return res.status(400).json({ error: '–¢–∏–∫–µ—Ç —É–∂–µ –∑–∞–∫—Ä—ã—Ç' });
        }
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–∏–∫–µ—Ç
        db.query(
          'UPDATE support_tickets SET status = "closed", updated_at = NOW() WHERE id = ?',
          [ticketId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–∏–∫–µ—Ç–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –¢–∏–∫–µ—Ç #${ticketId} –∑–∞–∫—Ä—ã—Ç`);
            
            res.json({
              success: true,
              message: '–¢–∏–∫–µ—Ç –∑–∞–∫—Ä—ã—Ç'
            });
          }
        );
      }
    );
  });

  // 1Ô∏è‚É£1Ô∏è‚É£ –£–î–ê–õ–ò–¢–¨ –¢–ò–ö–ï–¢ (ADMIN)
  app.delete('/api/admin/support/tickets/:ticketId', authenticateToken, (req, res) => {
    const { ticketId } = req.params;
    const adminId = req.user.id;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    db.query(
      'SELECT is_admin FROM users WHERE id = ?',
      [adminId],
      (err, adminResults) => {
        if (err || !adminResults || adminResults.length === 0 || !adminResults[0].is_admin) {
          return res.status(403).json({ error: '–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤' });
        }
        
        db.query(
          'DELETE FROM support_tickets WHERE id = ?',
          [ticketId],
          (err) => {
            if (err) {
              console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–∏–∫–µ—Ç–∞:', err);
              return res.status(500).json({ error: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' });
            }
            
            console.log(`‚úÖ –¢–∏–∫–µ—Ç #${ticketId} —É–¥–∞–ª–µ–Ω –∞–¥–º–∏–Ω–æ–º ${adminId}`);
            
            res.json({
              success: true,
              message: '–¢–∏–∫–µ—Ç —É–¥–∞–ª–µ–Ω'
            });
          }
        );
      }
    );
  });

  const PORT = process.env.PORT || 3001;
  server.listen(PORT, '0.0.0.0', () => {
    addLog(`‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`, 'success');
    addLog('‚úÖ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–´', 'success');
    addLog('‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù', 'success');
    addLog('‚úÖ Socket.io room-based messaging –≥–æ—Ç–æ–≤', 'success');
    
    console.log(`
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  ‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}                       ‚ïë
  ‚ïë  ‚úÖ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–´                         ‚ïë
  ‚ïë  ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–µ—Ä–∞ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù                        ‚ïë
  ‚ïë  ‚úÖ Socket.io room-based messaging –≥–æ—Ç–æ–≤                  ‚ïë
  ‚ïë  ‚è≥ –î–æ–∑–≤–æ–Ω: 15 —Å–µ–∫—É–Ω–¥                                     ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    `);
  });